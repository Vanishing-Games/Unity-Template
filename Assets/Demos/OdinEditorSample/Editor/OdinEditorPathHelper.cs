using System;
using System.IO;
using System.Linq;
using System.Reflection;
using UnityEditor;
using UnityEngine;

[AttributeUsage(AttributeTargets.Method)]
public class AutoOdinWindowMenuAttribute : Attribute
{
    public string CustomName { get; }

    public AutoOdinWindowMenuAttribute(string customName = null)
    {
        CustomName = customName;
    }
}

public static class AutoMenuGenerator
{
    // 1. å¯é…ç½®ä»£ç ç”Ÿæˆç›®å½•ï¼ˆæ¨èä½¿ç”¨ Editor ä¸‹çš„æŸä¸ªå­ç›®å½•ï¼‰
    private const string OutputFolder = "Assets/Demos/OdinEditorSample/Editor/AutoGeneratedMenus";
    private const string OutputFileName = "AutoGeneratedMenus.cs";

    [MenuItem("Tools/OdinEditorSample/ğŸ› ï¸ é‡æ–°ç”Ÿæˆèœå•")]
    public static void GenerateMenus()
    {
        var allMethods = AppDomain
            .CurrentDomain.GetAssemblies()
            .Where(asm => !asm.FullName.StartsWith("Unity") && !asm.FullName.StartsWith("System")) // åŠ é€Ÿè¿‡æ»¤
            .SelectMany(a =>
            {
                try
                {
                    return a.GetTypes();
                }
                catch
                {
                    return new Type[0];
                }
            })
            .SelectMany(t =>
                t.GetMethods(BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Static)
            )
            .Where(m => m.GetCustomAttribute<AutoOdinWindowMenuAttribute>() != null)
            .ToList();

        if (!allMethods.Any())
        {
            Debug.LogWarning("âš ï¸ æœªæ‰¾åˆ°ä»»ä½•å¸¦ [AutoOdinWindowMenu] çš„é™æ€æ–¹æ³•ã€‚");
            return;
        }

        if (!Directory.Exists(OutputFolder))
            Directory.CreateDirectory(OutputFolder);

        string filePath = Path.Combine(OutputFolder, OutputFileName);

        using (StreamWriter writer = new StreamWriter(filePath, false))
        {
            writer.WriteLine("// è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹");
            writer.WriteLine("using UnityEditor;");
            writer.WriteLine("using System.Reflection;");
            writer.WriteLine("using UnityEngine;");
            writer.WriteLine();
            writer.WriteLine("public static class AutoGeneratedMenus");
            writer.WriteLine("{");

            foreach (var method in allMethods)
            {
                var attr = method.GetCustomAttribute<AutoOdinWindowMenuAttribute>();
                string typeFullName = method.DeclaringType.FullName.Replace('+', '.'); // åµŒå¥—ç±»æ”¯æŒ
                string methodName = method.Name;
                string menuName = attr.CustomName ?? methodName;

                // Unity èœå•è·¯å¾„
                string menuPath = $"Tools/OdinEditorSample/{method.DeclaringType.Name}";

                // ç”Ÿæˆå”¯ä¸€å‡½æ•°åï¼ˆé˜²æ­¢é‡å¤ï¼‰
                string uniqueFunctionName = $"Menu_{Sanitize(typeFullName)}_{methodName}";

                writer.WriteLine($"    [MenuItem(\"{menuPath}\")]");
                writer.WriteLine($"    public static void {uniqueFunctionName}()");
                writer.WriteLine("    {");

                // ç”¨åå°„è°ƒç”¨ï¼Œé¿å… private static æ— æ³•ç›´æ¥è®¿é—®
                writer.WriteLine($"        var type = typeof({typeFullName});");
                writer.WriteLine(
                    $"        var method = type.GetMethod(\"{methodName}\", BindingFlags.Static | BindingFlags.Public | BindingFlags.NonPublic);"
                );
                writer.WriteLine("        if (method == null)");
                writer.WriteLine("        {");
                writer.WriteLine(
                    $"            Debug.LogError(\"æœªèƒ½æ‰¾åˆ°æ–¹æ³• {typeFullName}.{methodName}\");"
                );
                writer.WriteLine("            return;");
                writer.WriteLine("        }");
                writer.WriteLine("        method.Invoke(null, null);");

                writer.WriteLine("    }");
                writer.WriteLine();
            }

            writer.WriteLine("}");
        }

        AssetDatabase.Refresh();
        Debug.Log($"âœ… å·²ç”Ÿæˆè‡ªåŠ¨èœå•ä»£ç ï¼Œå…± {allMethods.Count} ä¸ªé¡¹ã€‚ä½ç½®ï¼š{filePath}");
    }

    // ç”¨äºå°†ç±»åä¸­çš„éæ³•å­—ç¬¦æ›¿æ¢æˆåˆæ³•çš„å‡½æ•°åï¼ˆå¦‚å‘½åç©ºé—´ä¸­çš„.ï¼‰
    private static string Sanitize(string name)
    {
        return name.Replace('.', '_').Replace('+', '_');
    }
}
