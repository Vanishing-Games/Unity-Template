name: â³ å…ƒæ•°æ®å‡†å¤‡

on:
  workflow_call:
    inputs:
      buildType:
        description: "æ„å»ºç±»å‹: preview | release_candidate | release"
        required: false
        type: string
        default: "preview"
      testsOnly:
        description: "æ˜¯å¦ä»…æµ‹è¯•"
        required: false
        type: boolean
        default: false
    outputs:
      projectName:
        description: "é¡¹ç›®åç§°"
        value: ${{ jobs.prepare_metadata.outputs.projectName }}
      unityVersion:
        description: "Unityç‰ˆæœ¬"
        value: ${{ jobs.prepare_metadata.outputs.unityVersion }}
      timeoutMinutesTests:
        description: "æµ‹è¯•è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰"
        value: ${{ jobs.prepare_metadata.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild:
        description: "æ„å»ºè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰"
        value: ${{ jobs.prepare_metadata.outputs.timeoutMinutesBuild }}
      retentionDays:
        description: "å·¥ä»¶ä¿ç•™å¤©æ•°"
        value: ${{ jobs.prepare_metadata.outputs.retentionDays }}
      buildType:
        description: "æ„å»ºç±»å‹"
        value: ${{ jobs.prepare_metadata.outputs.buildType }}
      buildVersion:
        description: "æ„å»ºç‰ˆæœ¬"
        value: ${{ jobs.resolve_build_version.outputs.buildVersion || jobs.prepare_metadata.outputs.buildVersion }}
      buildTargets:
        description: "æ„å»ºç›®æ ‡"
        value: ${{ jobs.prepare_metadata.outputs.buildTargets }}
      validDeployTargets:
        description: "æœ‰æ•ˆçš„éƒ¨ç½²ç›®æ ‡"
        value: ${{ jobs.prepare_metadata.outputs.deployTargets }}
      requiresCombined:
        description: "æ˜¯å¦éœ€è¦åˆå¹¶äº§ç‰©"
        value: ${{ jobs.prepare_metadata.outputs.requiresCombined }}
      skipPerBuildTarget:
        description: "æ˜¯å¦è·³è¿‡æ¯æ„å»ºç›®æ ‡äº§ç‰©"
        value: ${{ jobs.prepare_metadata.outputs.skipPerBuildTarget }}
      useGitLfs:
        description: "æ˜¯å¦ä½¿ç”¨Git LFS"
        value: ${{ jobs.prepare_metadata.outputs.useGitLfs }}
      editModePath:
        description: "EditModeæµ‹è¯•è·¯å¾„"
        value: ${{ jobs.prepare_metadata.outputs.editModePath }}
      playModePath:
        description: "PlayModeæµ‹è¯•è·¯å¾„"
        value: ${{ jobs.prepare_metadata.outputs.playModePath }}
      quietMode:
        description: "æ˜¯å¦é™é»˜æ¨¡å¼"
        value: ${{ jobs.prepare_metadata.outputs.quietMode }}
      testsOnly:
        description: "æ˜¯å¦ä»…æµ‹è¯•"
        value: ${{ jobs.prepare_metadata.outputs.testsOnly }}
      skipTests:
        description: "æ˜¯å¦è·³è¿‡æµ‹è¯•"
        value: ${{ jobs.prepare_metadata.outputs.skipTests }}
      excludeUnityTests:
        description: "æ˜¯å¦æ’é™¤Unityæµ‹è¯•"
        value: ${{ jobs.prepare_metadata.outputs.excludeUnityTests }}
      forceCombineArtifacts:
        description: "æ˜¯å¦å¼ºåˆ¶åˆå¹¶äº§ç‰©"
        value: ${{ jobs.prepare_metadata.outputs.forceCombineArtifacts }}

jobs:
  prepare_metadata:
    name: âš–ï¸ å…ƒæ•°æ®å‡†å¤‡
    runs-on: ubuntu-latest
    outputs:
      projectName: ${{ steps.config.outputs.projectName }}
      unityVersion: ${{ steps.config.outputs.unityVersion }}
      timeoutMinutesTests: ${{ steps.config.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild: ${{ steps.config.outputs.timeoutMinutesBuild }}
      retentionDays: ${{ steps.config.outputs.retentionDays }}
      buildType: ${{ steps.config.outputs.buildType }}
      buildTargets: ${{ steps.config.outputs.buildTargets }}
      deployTargets: ${{ steps.config.outputs.deployTargets }}
      requiresCombined: ${{ steps.config.outputs.requiresCombined }}
      skipPerBuildTarget: ${{ steps.config.outputs.skipPerBuildTarget }}
      useGitLfs: ${{ steps.config.outputs.useGitLfs }}
      editModePath: ${{ steps.config.outputs.editModePath }}
      playModePath: ${{ steps.config.outputs.playModePath }}
      quietMode: ${{ steps.config.outputs.quietMode }}
      testsOnly: ${{ steps.config.outputs.testsOnly }}
      skipTests: ${{ steps.config.outputs.skipTests }}
      excludeUnityTests: ${{ steps.config.outputs.excludeUnityTests }}
      forceCombineArtifacts: ${{ steps.config.outputs.forceCombineArtifacts }}
      buildVersion: ${{ steps.config.outputs.buildVersion }}
    steps:
      - name: ğŸ“ æ£€å‡ºé…ç½®æ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/config/*
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ğŸ”§ è§£æé…ç½®
        id: config
        shell: bash
        run: |
          set -euo pipefail
          CONFIG_PATH=".github/config"
          DEFAULTS_CONFIG="$CONFIG_PATH/defaults.json"
          CI_DEFAULTS_CONFIG="$CONFIG_PATH/ci-defaults.json"
          PIPELINE_CONFIG="$CONFIG_PATH/pipeline-config.json"

          echo "ğŸ“‹ å¼€å§‹è§£æé…ç½®..."

          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          for config_file in "$DEFAULTS_CONFIG" "$CI_DEFAULTS_CONFIG" "$PIPELINE_CONFIG"; do
            if [[ ! -f "$config_file" ]]; then
              echo "âŒ ç¼ºå°‘é…ç½®æ–‡ä»¶: $config_file"
              exit 1
            fi
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $config_file"
          done

          # è¯»å–defaults.json
          PROJECT_NAME=$(jq -r '.project.name // "Unity-Template"' "$DEFAULTS_CONFIG")
          UNITY_VERSION=$(jq -r '.unity.version // "2022.3.58f1"' "$DEFAULTS_CONFIG")
          USE_GIT_LFS=$(jq -r '.pipeline.useGitLfs // true' "$DEFAULTS_CONFIG")
          QUIET_MODE=$(jq -r '.pipeline.quietMode // false' "$DEFAULTS_CONFIG")
          EDITMODE_PATH=$(jq -r '.tests.editMode.path // "Assets/Tests/Editor"' "$DEFAULTS_CONFIG")
          PLAYMODE_PATH=$(jq -r '.tests.playMode.path // "Assets/Tests/PlayMode"' "$DEFAULTS_CONFIG")
          TIMEOUT_TESTS=$(jq -r '.tests.timeoutMinutes // 20' "$DEFAULTS_CONFIG")
          TIMEOUT_BUILD=$(jq -r '.build.timeoutMinutes // 30' "$DEFAULTS_CONFIG")
          FORCE_COMBINE=$(jq -r '.pipeline.forceCombineArtifacts // true' "$DEFAULTS_CONFIG")

          # è¯»å–ci-defaults.json
          CI_PROJECT_NAME=$(jq -r '.metadataConfig.projectName // empty' "$CI_DEFAULTS_CONFIG")
          CI_BUILD_VERSION=$(jq -r '.metadataConfig.buildVersion // "0.1.0"' "$CI_DEFAULTS_CONFIG")
          CI_RETENTION_DAYS=$(jq -r '.metadataConfig.retentionDays // 30' "$CI_DEFAULTS_CONFIG")
          CI_REQUIRES_COMBINED=$(jq -r '.artifactConfig.requiresCombined // true' "$CI_DEFAULTS_CONFIG")
          CI_SKIP_PER_BUILD=$(jq -r '.artifactConfig.skipPerBuildTarget // false' "$CI_DEFAULTS_CONFIG")
          CI_SKIP_TESTS=$(jq -r '.metadataConfig.skipTests // false' "$CI_DEFAULTS_CONFIG")
          CI_BUILD_TARGETS=$(jq -c '.build.defaultTargets // ["StandaloneWindows64","StandaloneOSX"]' "$DEFAULTS_CONFIG")
          CI_DEPLOY_TARGETS=$(jq -c '.deploy.defaultTargets // ["gh-pages"]' "$DEFAULTS_CONFIG")
          
          # ä½¿ç”¨è¾“å…¥å‚æ•°æˆ–é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å€¼
          CI_BUILD_TYPE="${{ inputs.buildType || 'preview' }}"
          CI_TESTS_ONLY="${{ inputs.testsOnly || false }}"

          # è¯»å–deployTargetsé…ç½®
          DEPLOY_TARGETS=$(jq -c 'keys' "$CONFIG_PATH/deploy-targets.json")

          # è¯»å–å…¶å®ƒå‚æ•°
          EXCLUDE_UNITY_TESTS=$(jq -r '.pipeline.excludeUnityTests // false' "$DEFAULTS_CONFIG")

          # ä¿ç•™å¤©æ•°
          RETENTION_MAPPING=$(jq -r '.build.retentionDays' "$DEFAULTS_CONFIG")
          FINAL_RETENTION=$(echo "$RETENTION_MAPPING" | jq -r ".[\"$CI_BUILD_TYPE\"] // 30")

          # è¾“å‡º
          echo "projectName=${CI_PROJECT_NAME:-$PROJECT_NAME}" >> "$GITHUB_OUTPUT"
          echo "unityVersion=$UNITY_VERSION" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesTests=$TIMEOUT_TESTS" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesBuild=$TIMEOUT_BUILD" >> "$GITHUB_OUTPUT"
          echo "retentionDays=$FINAL_RETENTION" >> "$GITHUB_OUTPUT"
          echo "buildType=$CI_BUILD_TYPE" >> "$GITHUB_OUTPUT"
          echo "buildTargets=$CI_BUILD_TARGETS" >> "$GITHUB_OUTPUT"
          echo "deployTargets=$CI_DEPLOY_TARGETS" >> "$GITHUB_OUTPUT"
          echo "requiresCombined=$CI_REQUIRES_COMBINED" >> "$GITHUB_OUTPUT"
          echo "skipPerBuildTarget=$CI_SKIP_PER_BUILD" >> "$GITHUB_OUTPUT"
          echo "useGitLfs=$USE_GIT_LFS" >> "$GITHUB_OUTPUT"
          echo "editModePath=$EDITMODE_PATH" >> "$GITHUB_OUTPUT"
          echo "playModePath=$PLAYMODE_PATH" >> "$GITHUB_OUTPUT"
          echo "quietMode=$QUIET_MODE" >> "$GITHUB_OUTPUT"
          echo "testsOnly=$CI_TESTS_ONLY" >> "$GITHUB_OUTPUT"
          echo "skipTests=$CI_SKIP_TESTS" >> "$GITHUB_OUTPUT"
          echo "excludeUnityTests=$EXCLUDE_UNITY_TESTS" >> "$GITHUB_OUTPUT"
          echo "forceCombineArtifacts=$FORCE_COMBINE" >> "$GITHUB_OUTPUT"
          echo "buildVersion=$CI_BUILD_VERSION" >> "$GITHUB_OUTPUT"

          echo "âœ… é…ç½®è§£æå®Œæˆ"
          
          echo "ğŸ” è°ƒè¯•è¾“å‡º:"
          echo "  - é¡¹ç›®åç§°: $PROJECT_NAME"
          echo "  - Unityç‰ˆæœ¬: $UNITY_VERSION"
          echo "  - æ„å»ºç±»å‹: $CI_BUILD_TYPE"
          echo "  - æ„å»ºç›®æ ‡: $CI_BUILD_TARGETS"
          echo "  - éƒ¨ç½²ç›®æ ‡: $CI_DEPLOY_TARGETS"
          echo "  - ä»…æµ‹è¯•: $CI_TESTS_ONLY"
          echo "  - è·³è¿‡æµ‹è¯•: $CI_SKIP_TESTS"

  resolve_build_version:
    name: ç”Ÿæˆæ„å»ºç‰ˆæœ¬å·
    needs:
      - prepare_metadata
    if: needs.prepare_metadata.outputs.testsOnly == 'false' && needs.prepare_metadata.outputs.skipTests == 'false'
    runs-on: ubuntu-latest
    outputs:
      buildVersion: ${{ steps.version.outputs.buildVersion }}
    steps:
      - name: ğŸ”– ç”Ÿæˆæ„å»ºç‰ˆæœ¬
        id: version
        run: |
          BUILD_TYPE="${{ needs.prepare_metadata.outputs.buildType }}"
          BASE_VERSION="${{ needs.prepare_metadata.outputs.buildVersion }}"
          
          case "$BUILD_TYPE" in
            "preview")
              BUILD_VERSION="${BASE_VERSION}-preview.${{ github.run_number }}"
              ;;
            "release_candidate")
              BUILD_VERSION="${BASE_VERSION}-rc.${{ github.run_number }}"
              ;;
            "release")
              BUILD_VERSION="$BASE_VERSION"
              ;;
            *)
              BUILD_VERSION="${BASE_VERSION}-$BUILD_TYPE.${{ github.run_number }}"
              ;;
          esac
          
          echo "buildVersion=$BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ”– ç”Ÿæˆçš„æ„å»ºç‰ˆæœ¬: $BUILD_VERSION"

  summarize_metadata:
    name: ğŸ“„ æ±‡æ€»å…ƒæ•°æ®
    needs:
      - prepare_metadata
      - resolve_build_version
    if: always()
    uses: ./.github/workflows/summarize-metadata.yml
    with:
      useGitLfs: ${{ needs.prepare_metadata.outputs.useGitLfs }}
      excludeUnityTests: ${{ needs.prepare_metadata.outputs.excludeUnityTests }}
      forceCombineArtifacts: ${{ needs.prepare_metadata.outputs.forceCombineArtifacts }}
      quietMode: ${{ needs.prepare_metadata.outputs.quietMode }}
      unityVersion: ${{ needs.prepare_metadata.outputs.unityVersion }}
      projectName: ${{ needs.prepare_metadata.outputs.projectName }}
      editModePath: ${{ needs.prepare_metadata.outputs.editModePath }}
      playModePath: ${{ needs.prepare_metadata.outputs.playModePath }}
      buildVersion: ${{ needs.resolve_build_version.outputs.buildVersion }}
      buildType: ${{ needs.prepare_metadata.outputs.buildType }}
      skipTests: ${{ needs.prepare_metadata.outputs.skipTests }}
      testsOnly: ${{ needs.prepare_metadata.outputs.testsOnly }}
      retentionDays: ${{ needs.prepare_metadata.outputs.retentionDays }}
      timeoutMinutesTests: ${{ needs.prepare_metadata.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild: ${{ needs.prepare_metadata.outputs.timeoutMinutesBuild }}
      buildTargets: ${{ needs.prepare_metadata.outputs.buildTargets }}
      validDeployTargets: ${{ needs.prepare_metadata.outputs.deployTargets || '[]' }}
      requiresCombined: ${{ needs.prepare_metadata.outputs.requiresCombined || false }}
      skipPerBuildTarget: ${{ needs.prepare_metadata.outputs.skipPerBuildTarget || false }}