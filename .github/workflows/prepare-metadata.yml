name: â³ å…ƒæ•°æ®å‡†å¤‡

on:
  workflow_call:
    inputs:
      projectName:
        type: string
        required: false
      unityVersion:
        type: string
        required: false
      buildVersion:
        type: string
        required: false
      deployTargets:
        type: string
        required: false
      buildTargets:
        type: string
        required: false
      buildType:
        type: string
        required: false
      skipTests:
        type: string
        required: false
      skipBuild:
        type: string
        required: false
        default: 'false'
      testsOnly:
        type: string
        required: false
    outputs:
      projectName:
        value: ${{ jobs.prepare_metadata.outputs.projectName }}
      unityVersion:
        value: ${{ jobs.prepare_metadata.outputs.unityVersion }}
      buildVersion:
        value: ${{ jobs.resolve_build_version.outputs.buildVersion || jobs.prepare_metadata.outputs.buildVersion }}
      testsOnly:
        value: ${{ jobs.prepare_metadata.outputs.testsOnly }}
      skipTests:
        value: ${{ jobs.prepare_metadata.outputs.skipTests }}
      useGitLfs:
        value: ${{ jobs.prepare_metadata.outputs.useGitLfs }}
      editModePath:
        value: ${{ jobs.prepare_metadata.outputs.editModePath }}
      playModePath:
        value: ${{ jobs.prepare_metadata.outputs.playModePath }}
      timeoutMinutesTests:
        value: ${{ jobs.prepare_metadata.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild:
        value: ${{ jobs.prepare_metadata.outputs.timeoutMinutesBuild }}
      quietMode:
        value: ${{ jobs.prepare_metadata.outputs.quietMode }}
      buildType:
        value: ${{ jobs.prepare_metadata.outputs.buildType }}
      retentionDays:
        value: ${{ jobs.prepare_metadata.outputs.retentionDays }}
      buildTargets:
        value: ${{ jobs.prepare_metadata.outputs.buildTargets }}
      validDeployTargets:
        value: ${{ jobs.prepare_metadata.outputs.deployTargets }}
      requiresCombined:
        value: ${{ jobs.prepare_metadata.outputs.requiresCombined }}
      skipPerBuildTarget:
        value: ${{ jobs.prepare_metadata.outputs.skipPerBuildTarget }}

env:
  CONFIG_PATH: '.github/config'

jobs:
  prepare_metadata:
    name: âš–ï¸ å…ƒæ•°æ®å‡†å¤‡å’Œé…ç½®è§£æž
    runs-on: ubuntu-latest
    outputs:
      projectName: ${{ steps.config.outputs.projectName }}
      unityVersion: ${{ steps.config.outputs.unityVersion }}
      timeoutMinutesTests: ${{ steps.config.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild: ${{ steps.config.outputs.timeoutMinutesBuild }}
      retentionDays: ${{ steps.config.outputs.retentionDays }}
      buildType: ${{ steps.config.outputs.buildType }}
      buildTargets: ${{ steps.config.outputs.buildTargets }}
      deployTargets: ${{ steps.config.outputs.deployTargets }}
      requiresCombined: ${{ steps.config.outputs.requiresCombined }}
      skipPerBuildTarget: ${{ steps.config.outputs.skipPerBuildTarget }}
      useGitLfs: ${{ steps.config.outputs.useGitLfs }}
      editModePath: ${{ steps.config.outputs.editModePath }}
      playModePath: ${{ steps.config.outputs.playModePath }}
      quietMode: ${{ steps.config.outputs.quietMode }}
      testsOnly: ${{ steps.config.outputs.testsOnly }}
      skipTests: ${{ steps.config.outputs.skipTests }}
      buildVersion: ${{ steps.config.outputs.buildVersion }}
    steps:
      - name: ðŸ“ æ£€å‡ºé…ç½®æ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ env.CONFIG_PATH }}
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ðŸ”§ è§£æžå’ŒåŠ è½½é…ç½®
        id: config
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ðŸ“‹ å¼€å§‹åŠ è½½é…ç½®æ–‡ä»¶..."
          
          # éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
          DEFAULTS_CONFIG="${CONFIG_PATH}/defaults.json"
          CI_DEFAULTS_CONFIG="${CONFIG_PATH}/ci-defaults.json"
          
          for config_file in "$DEFAULTS_CONFIG" "$CI_DEFAULTS_CONFIG"; do
            if [[ ! -f "$config_file" ]]; then
              echo "âŒ ç¼ºå°‘é…ç½®æ–‡ä»¶: $config_file"
              exit 1
            fi
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $config_file"
          done
          
          # ä»Ždefaults.jsonè¯»å–åŸºç¡€é…ç½®
          echo "ðŸ“– è¯»å–åŸºç¡€é…ç½®..."
          PROJECT_NAME=$(jq -r '.project.name // "Unity-Template"' "$DEFAULTS_CONFIG")
          UNITY_VERSION=$(jq -r '.unity.version // "2022.3.58f1"' "$DEFAULTS_CONFIG")
          USE_GIT_LFS=$(jq -r '.pipeline.useGitLfs // true' "$DEFAULTS_CONFIG")
          QUIET_MODE=$(jq -r '.pipeline.quietMode // false' "$DEFAULTS_CONFIG")
          EDITMODE_PATH=$(jq -r '.tests.editMode.path // "Assets/Tests/Editor"' "$DEFAULTS_CONFIG")
          PLAYMODE_PATH=$(jq -r '.tests.playMode.path // "Assets/Tests/PlayMode"' "$DEFAULTS_CONFIG")
          TIMEOUT_TESTS=$(jq -r '.tests.timeoutMinutes // 20' "$DEFAULTS_CONFIG")
          TIMEOUT_BUILD=$(jq -r '.build.timeoutMinutes // 30' "$DEFAULTS_CONFIG")
          FORCE_COMBINE=$(jq -r '.pipeline.forceCombineArtifacts // true' "$DEFAULTS_CONFIG")
          
          # è¯»å–é»˜è®¤æž„å»ºç›®æ ‡å’Œéƒ¨ç½²ç›®æ ‡
          DEFAULT_BUILD_TARGETS=$(jq -c '.build.defaultTargets // ["WebGL","StandaloneWindows64","StandaloneOSX"]' "$DEFAULTS_CONFIG")
          DEFAULT_DEPLOY_TARGETS=$(jq -c '.deploy.defaultTargets // ["gh-pages"]' "$DEFAULTS_CONFIG")
          
          echo "ðŸŽ¯ é»˜è®¤æž„å»ºç›®æ ‡: $DEFAULT_BUILD_TARGETS"
          echo "ðŸš€ é»˜è®¤éƒ¨ç½²ç›®æ ‡: $DEFAULT_DEPLOY_TARGETS"
          
          # ä»Žci-defaults.jsonè¯»å–CIç‰¹å®šé…ç½®
          echo "ðŸ“– è¯»å–CIç‰¹å®šé…ç½®..."
          CI_BUILD_TYPE=$(jq -r '.metadataConfig.buildType // "preview"' "$CI_DEFAULTS_CONFIG")
          CI_BUILD_VERSION=$(jq -r '.metadataConfig.buildVersion // "0.1.0"' "$CI_DEFAULTS_CONFIG")
          CI_RETENTION_DAYS=$(jq -r '.metadataConfig.retentionDays // 30' "$CI_DEFAULTS_CONFIG")
          CI_REQUIRES_COMBINED=$(jq -r '.artifactConfig.requiresCombined // true' "$CI_DEFAULTS_CONFIG")
          CI_SKIP_PER_BUILD=$(jq -r '.artifactConfig.skipPerBuildTarget // false' "$CI_DEFAULTS_CONFIG")
          
          # æ£€æµ‹commitæ¶ˆæ¯ä¸­çš„ç‰¹æ®Šæ ‡è®° (ä»…åœ¨GitHubäº‹ä»¶ä¸­æœ‰æ•ˆ)
          COMMIT_MSG=""
          TESTS_ONLY=false
          SKIP_TESTS=false
          
          if [[ "${{ github.event_name }}" == "push" ]]; then
            COMMIT_MSG="${{ github.event.head_commit.message || '' }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            COMMIT_MSG="${{ github.event.pull_request.title || '' }}"
          fi
          
          echo "ðŸ“ æ£€æŸ¥commitæ¶ˆæ¯: $COMMIT_MSG"
          
          # æ£€æŸ¥[TEST ONLY]æ ‡è®°
          if [[ "$COMMIT_MSG" == *"[TEST ONLY]"* ]]; then
            echo "ðŸ§ª æ£€æµ‹åˆ°[TEST ONLY]æ ‡è®°ï¼Œè®¾ç½®ä¸ºä»…æµ‹è¯•æ¨¡å¼"
            TESTS_ONLY=true
          fi
          
          # åº”ç”¨è¾“å…¥å‚æ•°ï¼Œä¼˜å…ˆçº§ï¼šè¾“å…¥å‚æ•° > ä»“åº“å˜é‡ > é…ç½®æ–‡ä»¶é»˜è®¤å€¼
          
          # é¡¹ç›®åç§°
          FINAL_PROJECT_NAME="${{ inputs.projectName }}"
          if [[ -z "$FINAL_PROJECT_NAME" || "$FINAL_PROJECT_NAME" == "null" ]]; then
            FINAL_PROJECT_NAME="${{ vars.PROJECT_NAME }}"
          fi
          if [[ -z "$FINAL_PROJECT_NAME" || "$FINAL_PROJECT_NAME" == "null" ]]; then
            FINAL_PROJECT_NAME="$PROJECT_NAME"
          fi
          
          # Unityç‰ˆæœ¬
          FINAL_UNITY_VERSION="${{ inputs.unityVersion }}"
          if [[ -z "$FINAL_UNITY_VERSION" || "$FINAL_UNITY_VERSION" == "null" ]]; then
            FINAL_UNITY_VERSION="${{ vars.UNITY_VERSION }}"
          fi
          if [[ -z "$FINAL_UNITY_VERSION" || "$FINAL_UNITY_VERSION" == "null" ]]; then
            FINAL_UNITY_VERSION="$UNITY_VERSION"
          fi
          
          # æž„å»ºç±»åž‹
          FINAL_BUILD_TYPE="${{ inputs.buildType }}"
          if [[ -z "$FINAL_BUILD_TYPE" || "$FINAL_BUILD_TYPE" == "null" ]]; then
            FINAL_BUILD_TYPE="$CI_BUILD_TYPE"
          fi
          
          # æž„å»ºç‰ˆæœ¬
          FINAL_BUILD_VERSION="${{ inputs.buildVersion }}"
          if [[ -z "$FINAL_BUILD_VERSION" || "$FINAL_BUILD_VERSION" == "null" ]]; then
            FINAL_BUILD_VERSION="$CI_BUILD_VERSION"
          fi
          
          # æž„å»ºç›®æ ‡ - ä¼˜å…ˆçº§ï¼šè¾“å…¥å‚æ•° > ä»“åº“å˜é‡ > é…ç½®æ–‡ä»¶é»˜è®¤å€¼
          FINAL_BUILD_TARGETS="${{ inputs.buildTargets }}"
          if [[ -z "$FINAL_BUILD_TARGETS" || "$FINAL_BUILD_TARGETS" == "null" || "$FINAL_BUILD_TARGETS" == "[]" ]]; then
            FINAL_BUILD_TARGETS="${{ vars.BUILD_TARGETS }}"
            echo "ðŸ”„ ä½¿ç”¨ä»“åº“å˜é‡æž„å»ºç›®æ ‡: $FINAL_BUILD_TARGETS"
          fi
          if [[ -z "$FINAL_BUILD_TARGETS" || "$FINAL_BUILD_TARGETS" == "null" || "$FINAL_BUILD_TARGETS" == "[]" ]]; then
            FINAL_BUILD_TARGETS="$DEFAULT_BUILD_TARGETS"
            echo "ðŸ”„ ä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤æž„å»ºç›®æ ‡: $FINAL_BUILD_TARGETS"
          fi
          
          # éƒ¨ç½²ç›®æ ‡
          FINAL_DEPLOY_TARGETS="${{ inputs.deployTargets }}"
          if [[ -z "$FINAL_DEPLOY_TARGETS" || "$FINAL_DEPLOY_TARGETS" == "null" || "$FINAL_DEPLOY_TARGETS" == "[]" ]]; then
            FINAL_DEPLOY_TARGETS="${{ vars.DEPLOY_TARGETS }}"
          fi
          if [[ -z "$FINAL_DEPLOY_TARGETS" || "$FINAL_DEPLOY_TARGETS" == "null" || "$FINAL_DEPLOY_TARGETS" == "[]" ]]; then
            FINAL_DEPLOY_TARGETS="$DEFAULT_DEPLOY_TARGETS"
          fi
          
          # testsOnlyçš„å¤„ç†ï¼šè¾“å…¥å‚æ•° > commitæ ‡è®° > é»˜è®¤false
          FINAL_TESTS_ONLY="${{ inputs.testsOnly }}"
          if [[ -z "$FINAL_TESTS_ONLY" || "$FINAL_TESTS_ONLY" == "null" ]]; then
            FINAL_TESTS_ONLY="$TESTS_ONLY"
          fi
          
          # skipTestsçš„å¤„ç†
          FINAL_SKIP_TESTS="${{ inputs.skipTests }}"
          if [[ -z "$FINAL_SKIP_TESTS" || "$FINAL_SKIP_TESTS" == "null" ]]; then
            FINAL_SKIP_TESTS="$SKIP_TESTS"
          fi
          
          # æ ¹æ®æž„å»ºç±»åž‹è®¾ç½®ä¿ç•™å¤©æ•°
          RETENTION_MAPPING=$(jq -r '.build.retentionDays' "$DEFAULTS_CONFIG")
          FINAL_RETENTION=$(echo "$RETENTION_MAPPING" | jq -r ".[\"$FINAL_BUILD_TYPE\"] // 30")
          
          # è¾“å‡ºæ‰€æœ‰é…ç½®
          echo "projectName=$FINAL_PROJECT_NAME" >> "$GITHUB_OUTPUT"
          echo "unityVersion=$FINAL_UNITY_VERSION" >> "$GITHUB_OUTPUT"
          echo "buildType=$FINAL_BUILD_TYPE" >> "$GITHUB_OUTPUT"
          echo "buildVersion=$FINAL_BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "buildTargets=$FINAL_BUILD_TARGETS" >> "$GITHUB_OUTPUT"
          echo "deployTargets=$FINAL_DEPLOY_TARGETS" >> "$GITHUB_OUTPUT"
          echo "testsOnly=$FINAL_TESTS_ONLY" >> "$GITHUB_OUTPUT"
          echo "skipTests=$FINAL_SKIP_TESTS" >> "$GITHUB_OUTPUT"
          echo "retentionDays=$FINAL_RETENTION" >> "$GITHUB_OUTPUT"
          echo "requiresCombined=$CI_REQUIRES_COMBINED" >> "$GITHUB_OUTPUT"
          echo "skipPerBuildTarget=$CI_SKIP_PER_BUILD" >> "$GITHUB_OUTPUT"
          echo "useGitLfs=$USE_GIT_LFS" >> "$GITHUB_OUTPUT"
          echo "editModePath=$EDITMODE_PATH" >> "$GITHUB_OUTPUT"
          echo "playModePath=$PLAYMODE_PATH" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesTests=$TIMEOUT_TESTS" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesBuild=$TIMEOUT_BUILD" >> "$GITHUB_OUTPUT"
          echo "quietMode=$QUIET_MODE" >> "$GITHUB_OUTPUT"
          
          echo "âœ… é…ç½®è§£æžå®Œæˆ"
          echo "ðŸ“Š æœ€ç»ˆé…ç½®æ‘˜è¦:"
          echo "  - é¡¹ç›®å: $FINAL_PROJECT_NAME"
          echo "  - Unityç‰ˆæœ¬: $FINAL_UNITY_VERSION"
          echo "  - æž„å»ºç±»åž‹: $FINAL_BUILD_TYPE"
          echo "  - æž„å»ºç›®æ ‡: $FINAL_BUILD_TARGETS"
          echo "  - éƒ¨ç½²ç›®æ ‡: $FINAL_DEPLOY_TARGETS"
          echo "  - ä»…æµ‹è¯•: $FINAL_TESTS_ONLY"
          echo "  - è·³è¿‡æµ‹è¯•: $FINAL_SKIP_TESTS"

      - name: ðŸ›¡ï¸ éªŒè¯é…ç½®å®Œæ•´æ€§
        run: |
          echo "ðŸ” éªŒè¯é…ç½®å®Œæ•´æ€§..."
          
          BUILD_TARGETS="${{ steps.config.outputs.buildTargets }}"
          TESTS_ONLY="${{ steps.config.outputs.testsOnly }}"
          
          # å¦‚æžœä¸æ˜¯ä»…æµ‹è¯•æ¨¡å¼ï¼Œå¿…é¡»æœ‰æœ‰æ•ˆçš„æž„å»ºç›®æ ‡
          if [[ "$TESTS_ONLY" != "true" ]]; then
            if [[ "$BUILD_TARGETS" == "[]" || "$BUILD_TARGETS" == "" || "$BUILD_TARGETS" == "null" ]]; then
              echo "âŒ é”™è¯¯ï¼šæœªè®¾ç½®æœ‰æ•ˆçš„æž„å»ºç›®æ ‡ä¸”æœªå¯ç”¨ä»…æµ‹è¯•æ¨¡å¼"
              echo "ðŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
              echo "   1. åœ¨commitæ¶ˆæ¯ä¸­æ·»åŠ  [TEST ONLY] æ ‡è®°ä»¥å¯ç”¨ä»…æµ‹è¯•æ¨¡å¼"
              echo "   2. æˆ–è€…åœ¨ä»“åº“å˜é‡ä¸­è®¾ç½® BUILD_TARGETS"
              echo "   3. æˆ–è€…ç¡®ä¿ .github/config/defaults.json ä¸­æœ‰æœ‰æ•ˆçš„é»˜è®¤æž„å»ºç›®æ ‡"
              exit 1
            fi
          fi
          
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          echo "ðŸŽ¯ æž„å»ºç›®æ ‡: $BUILD_TARGETS"
          echo "ðŸ§ª ä»…æµ‹è¯•æ¨¡å¼: $TESTS_ONLY"

  resolve_build_version:
    name: ðŸ”¢ è§£æžæž„å»ºç‰ˆæœ¬
    needs: prepare_metadata
    if: needs.prepare_metadata.outputs.testsOnly == 'false' && inputs.skipBuild == 'false'
    uses: ./.github/workflows/build-version-resolver.yml
    with:
      buildType: ${{ needs.prepare_metadata.outputs.buildType }}
      buildVersion: ${{ needs.prepare_metadata.outputs.buildVersion }}

  summarize_metadata:
    name: ðŸ“„ å…ƒæ•°æ®é…ç½®æ‘˜è¦
    needs:
      - prepare_metadata
      - resolve_build_version
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š ç”Ÿæˆé…ç½®æ‘˜è¦
        run: |
          echo "# âš–ï¸ å…ƒæ•°æ®é…ç½®æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“‹ åŸºç¡€é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›®åç§° | \`${{ needs.prepare_metadata.outputs.projectName }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Unityç‰ˆæœ¬ | \`${{ needs.prepare_metadata.outputs.unityVersion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | \`${{ needs.prepare_metadata.outputs.buildType }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç‰ˆæœ¬ | \`${{ needs.resolve_build_version.outputs.buildVersion || needs.prepare_metadata.outputs.buildVersion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ¯ ç›®æ ‡é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç›®æ ‡ | \`${{ needs.prepare_metadata.outputs.buildTargets }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²ç›®æ ‡ | \`${{ needs.prepare_metadata.outputs.deployTargets }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ”§ æµæ°´çº¿æŽ§åˆ¶" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ä»…æµ‹è¯•æ¨¡å¼ | ${{ needs.prepare_metadata.outputs.testsOnly == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è·³è¿‡æµ‹è¯• | ${{ needs.prepare_metadata.outputs.skipTests == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆå¹¶äº§ç‰© | ${{ needs.prepare_metadata.outputs.requiresCombined == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## â±ï¸ è¶…æ—¶å’Œä¿ç•™è®¾ç½®" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æµ‹è¯•è¶…æ—¶ | ${{ needs.prepare_metadata.outputs.timeoutMinutesTests }} åˆ†é’Ÿ |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºè¶…æ—¶ | ${{ needs.prepare_metadata.outputs.timeoutMinutesBuild }} åˆ†é’Ÿ |" >> $GITHUB_STEP_SUMMARY
          echo "| äº§ç‰©ä¿ç•™ | ${{ needs.prepare_metadata.outputs.retentionDays }} å¤© |" >> $GITHUB_STEP_SUMMARY