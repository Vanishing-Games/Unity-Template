name: ğŸ§ª æµ‹è¯• - æ­¥éª¤5é€šçŸ¥å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: "æ„å»ºç±»å‹ï¼š'preview' ç”¨äºæ‰‹åŠ¨/å¼€å‘æ„å»ºï¼Œ'release_candidate' ç”¨äºé¢„å‘å¸ƒï¼ˆå¦‚ v1.2.3-rc.1ï¼‰ï¼Œ'release' ç”¨äºæ­£å¼å‘å¸ƒï¼ˆå¦‚ v1.2.3ï¼‰"
        required: true
        default: "release_candidate"
        type: choice
        options:
          - preview
          - release_candidate
          - release
      projectName:
        description: "äº§ç‰©çš„é¡¹ç›®åç§°"
        required: true
        default: "Unity_CI_Templates"
      buildVersion:
        description: "å¯é€‰çš„ç‰ˆæœ¬å·å­—ç¬¦ä¸²ï¼ˆå¦‚ v1.2.3 æˆ– v1.2.3-rc.1ï¼‰ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚ PR-0001, manual-mainï¼‰"
        required: false
        default: "v0.0.0"
        type: string
      buildTargets:
        description: "è¦æ„å»ºçš„ç›®æ ‡çš„ JSON æ•°ç»„"
        required: true
        default: '["Android", "WebGL", "StandaloneLinux64-Client", "StandaloneLinux64-Server", "StandaloneWindows", "StandaloneWindows64", "StandaloneOSX", "iOS"]'
      deployTargets:
        description: "éƒ¨ç½²ç›®æ ‡çš„ JSON æ•°ç»„ï¼ˆå¦‚ [\"itch.io\",\"s3\"]ï¼‰"
        required: true
        default: '["itch.io", "appcenter", "firebase", "s3", "gh-pages", "steam", "discord", "testflight", "custom-server"]'
        type: string
      deployTargetsSuccessful:
        description: "éƒ¨ç½²æˆåŠŸçš„ç›®æ ‡ JSON æ•°ç»„ï¼ˆå¦‚ [\"itch.io\",\"s3\"]ï¼‰"
        required: true
        default: '["itch.io", "appcenter", "firebase", "s3", "gh-pages", "steam", "discord", "testflight", "custom-server"]'
        type: string
      editmodeFailedCount:
        description: "æ¨¡æ‹Ÿ EditMode æµ‹è¯•å¤±è´¥æ•°"
        required: false
        default: '0'
        type: string
      playmodeFailedCount:
        description: "æ¨¡æ‹Ÿ PlayMode æµ‹è¯•å¤±è´¥æ•°"
        required: false
        default: '0'
        type: string
      releaseResult:
        description: "æ¨¡æ‹Ÿå‘å¸ƒç»“æœ"
        required: false
        default: 'success'
        type: choice
        options:
          - success
          - no_artifacts
          - api_failure
          - upload_failure
          - unknown_failure
      quietMode:
        description: "æ¨¡æ‹Ÿé™é»˜æ¨¡å¼"
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  prepare_metadata:
    name: â³ å…ƒæ•°æ®å‡†å¤‡
    uses: ./.github/workflows/prepare-metadata.yml
    with:
      projectName: ${{ inputs.projectName }}
      unityVersion: ${{ vars.UNITY_VERSION }}
      skipTests: false
      testsOnly: false
      buildTargets: ${{ inputs.buildTargets }}
      deployTargets: ${{ inputs.deployTargets }}
      buildType: ${{ inputs.buildType }}
      buildVersion: ${{ inputs.buildVersion }}

  dry_tests:
    name: ğŸ“‹ åˆ›å»º Dry-Tests
    needs: 
        - prepare_metadata
    uses: ./.github/workflows/dry-tests.yml
    with:
      editmodeFailedCount: ${{ inputs.editmodeFailedCount }}
      editmodeTotalCount: 12
      playmodeFailedCount: ${{ inputs.playmodeFailedCount }}
      playmodeTotalCount: 8
      quietMode: ${{ inputs.quietMode }}

  dry_build:
    name: ğŸ§© åˆ›å»º Dry-Build
    needs: 
        - prepare_metadata
        - dry_tests
    if: ${{ needs.dry_tests.outputs.hasFails == 'false' }}
    uses: ./.github/workflows/dry-build.yml
    with:
      unityVersion: ${{ needs.prepare_metadata.outputs.unityVersion }}
      buildVersion: ${{ needs.prepare_metadata.outputs.buildVersion }}
      buildType: ${{ needs.prepare_metadata.outputs.buildType }}
      projectName: ${{ needs.prepare_metadata.outputs.projectName }}
      buildTargets: ${{ needs.prepare_metadata.outputs.buildTargets }}
      combineArtifacts: ${{ needs.prepare_metadata.outputs.requiresCombined }}
    secrets: inherit

  dry_release:
    name: ğŸ“¦ åˆ›å»º Dry-Release
    needs: 
        - prepare_metadata
        - dry_build
    uses: ./.github/workflows/dry-release.yml
    with:
      simulateResult: ${{ inputs.releaseResult }}

  dry_deploy:
    name: ğŸŒ åˆ›å»º Dry-Deploy
    needs: [prepare_metadata, dry_build, dry_tests]
    uses: ./.github/workflows/dry-deploy.yml
    with:
      deployTargets: ${{ inputs.deployTargets }}
      successfulTargets: ${{ inputs.deployTargetsSuccessful }}

  test_notify:
    name: ğŸ“£ æµ‹è¯•é€šçŸ¥
    needs: 
      - prepare_metadata
      - dry_tests
      - dry_build
      - dry_deploy
      - dry_release
    if: always()
    uses: ./.github/workflows/step-5-notify.yml
    with:
      buildVersion: ${{ needs.prepare_metadata.outputs.buildVersion }}
      releaseResult: ${{ inputs.releaseResult }}
      releaseErrorMessage: ${{ needs.dry_release.outputs.releaseErrorMessage }}
      deployResult: ${{ needs.dry_deploy.outputs.deployResult }}
      testsHasFails: ${{ needs.dry_tests.outputs.hasFails }}
      testsTotal: ${{ needs.dry_tests.outputs.totalTests }}
      testsPassed: ${{ needs.dry_tests.outputs.passedTests }}
      testsFailedNames: ${{ needs.dry_tests.outputs.failedTestNames }}
    secrets:
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}