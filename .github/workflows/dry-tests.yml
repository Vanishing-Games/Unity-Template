name: ğŸŒ€ å¹²æµ‹è¯•ï¼ˆDry Testsï¼‰

on:
  workflow_call:
    inputs:
      editmodeFailedCount:
        description: "æ¨¡æ‹Ÿ EditMode å¤±è´¥æµ‹è¯•æ•°"
        required: true
        default: '0'
        type: string
      editmodeTotalCount:
        description: "æ¨¡æ‹Ÿ EditMode æµ‹è¯•æ€»æ•°"
        required: true
        default: '42'
        type: string
      playmodeFailedCount:
        description: "æ¨¡æ‹Ÿ PlayMode å¤±è´¥æµ‹è¯•æ•°"
        required: true
        default: '0'
        type: string
      playmodeTotalCount:
        description: "æ¨¡æ‹Ÿ PlayMode æµ‹è¯•æ€»æ•°"
        required: true
        default: '42'
        type: string
      quietMode:
        description: "æ˜¯å¦æ¨¡æ‹Ÿé™é»˜æ¨¡å¼"
        required: true
        default: 'false'
        type: string
    outputs:
      hasFails:
        description: "æ˜¯å¦æœ‰å¤±è´¥å‘ç”Ÿ"
        value: ${{ jobs.dry_tests.outputs.hasFails }}
      totalTests:
        description: "æ¨¡æ‹Ÿæµ‹è¯•æ€»æ•°"
        value: ${{ jobs.dry_tests.outputs.totalTests }}
      passedTests:
        description: "æ¨¡æ‹Ÿé€šè¿‡çš„æµ‹è¯•æ•°"
        value: ${{ jobs.dry_tests.outputs.passedTests }}
      failedTestNames:
        description: "æ¨¡æ‹Ÿå¤±è´¥æµ‹è¯•åç§°åˆ—è¡¨"
        value: ${{ jobs.dry_tests.outputs.failedTestNames }}

jobs:
  dry_tests:
    name: ğŸ§ª æ¨¡æ‹Ÿæµ‹è¯•æ±‡æ€»
    runs-on: ubuntu-latest
    outputs:
      hasFails: ${{ steps.simulate.outputs.hasFails }}
      totalTests: ${{ steps.simulate.outputs.totalTests }}
      passedTests: ${{ steps.simulate.outputs.passedTests }}
      failedTestNames: ${{ steps.simulate.outputs.failedTestNames }}
    steps:
      - name: æ¨¡æ‹Ÿæµ‹è¯•æ±‡æ€»
        id: simulate
        run: |
          EDIT_TOTAL=${{ inputs.editmodeTotalCount }}
          EDIT_FAILS=${{ inputs.editmodeFailedCount }}
          EDIT_PASSED=$((EDIT_TOTAL - EDIT_FAILS))

          PLAY_TOTAL=${{ inputs.playmodeTotalCount }}
          PLAY_FAILS=${{ inputs.playmodeFailedCount }}
          PLAY_PASSED=$((PLAY_TOTAL - PLAY_FAILS))

          TOTAL_TESTS=$((EDIT_TOTAL + PLAY_TOTAL))
          PASSED_TESTS=$((EDIT_PASSED + PLAY_PASSED))

          HAS_FAILS="false"
          FAILED_LIST="None"
          
          if [[ "$EDIT_FAILS" -gt 0 || "$PLAY_FAILS" -gt 0 ]]; then
            HAS_FAILS="true"
            FAILED_LIST=""
            for i in $(seq 1 "$EDIT_FAILS"); do
              FAILED_LIST+="EditMode.FailingTest$i"$'\n'
            done
            for i in $(seq 1 "$PLAY_FAILS"); do
              FAILED_LIST+="PlayMode.FailingTest$i"$'\n'
            done
          fi

          echo "hasFails=$HAS_FAILS" >> $GITHUB_OUTPUT
          echo "totalTests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passedTests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          if [[ "$HAS_FAILS" == "true" ]]; then
            echo "failedTestNames<<EOF" >> $GITHUB_OUTPUT
            echo "$FAILED_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "failedTestNames=None" >> $GITHUB_OUTPUT
          fi

          # æ±‡æ€»è¾“å‡º
          if [[ "${{ inputs.quietMode }}" == "false" || "$HAS_FAILS" == "true" ]]; then
            echo "### ğŸ“‹ æ¨¡æ‹Ÿ Unity æµ‹è¯•ç»“æœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æµ‹è¯•æ¨¡å¼   | é€šè¿‡æ•° / æ€»æ•° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ¥ª EditMode | $EDIT_PASSED / $EDIT_TOTAL | $([[ $EDIT_FAILS -eq 0 ]] && echo 'âœ”ï¸' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ® PlayMode | $PLAY_PASSED / $PLAY_TOTAL | $([[ $PLAY_FAILS -eq 0 ]] && echo 'âœ”ï¸' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY

            if [[ "$HAS_FAILS" == "true" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "<details><summary>âŒ å¤±è´¥æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "$FAILED_LIST" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ğŸ”• å¯ç”¨é™é»˜æ¨¡å¼ â€” è·³è¿‡è¯¦ç»†æ±‡æ€»ã€‚"
          fi

      - name: åˆ›å»ºè™šæ‹Ÿäº§ç‰©
        run: |
          mkdir -p dummy-results/EditMode
          mkdir -p dummy-results/PlayMode
          echo "<test-results mode='EditMode'>" > dummy-results/EditMode/results.xml
          echo "<test-results mode='PlayMode'>" > dummy-results/PlayMode/results.xml
          echo "æ¨¡æ‹Ÿ EditMode æµ‹è¯•ç»“æœæ–‡ä»¶" > dummy-results/EditMode/results.txt
          echo "æ¨¡æ‹Ÿ PlayMode æµ‹è¯•ç»“æœæ–‡ä»¶" > dummy-results/PlayMode/results.txt

      - name: ä¸Šä¼ è™šæ‹Ÿ EditMode äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Unity-EditMode-dry
          path: dummy-results/EditMode

      - name: ä¸Šä¼ è™šæ‹Ÿ PlayMode äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Unity-PlayMode-dry
          path: dummy-results/PlayMode