name: ğŸ“‹ æ­¥éª¤1 - æµ‹è¯•

on:
  workflow_call:
    inputs:
      unityVersion:
        description: "ä½¿ç”¨çš„ Unity ç‰ˆæœ¬"
        required: true
        default: '2022.3.58f1'
        type: string
      useGitLfs:
        description: "æ˜¯å¦ä½¿ç”¨ Git LFSï¼ˆtrue/falseï¼‰"
        required: true
        default: 'true'
        type: string
      editModePath:
        description: "EditMode æµ‹è¯•æ–‡ä»¶å¤¹è·¯å¾„"
        required: true
        default: 'Assets/Tests/Editor'
        type: string
      playModePath:
        description: "PlayMode æµ‹è¯•æ–‡ä»¶å¤¹è·¯å¾„"
        required: true
        default: 'Assets/Tests/PlayMode'
        type: string
      timeoutMinutes:
        description: "æ¯ä¸ªæµ‹è¯•ä½œä¸šçš„è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰"
        required: true
        default: 15
        type: number
      quietMode:
        description: "å¯ç”¨é™é»˜æ¨¡å¼ï¼Œä»…åœ¨æµ‹è¯•å¤±è´¥æ—¶ä¸Šä¼ /è¾“å‡ºæ—¥å¿—"
        required: true
        default: 'false'
        type: string
    outputs:
      hasFails:
        description: "æ˜¯å¦æœ‰æµ‹è¯•å¤±è´¥"
        value: ${{ jobs.summarize_tests.outputs.hasFails }}
      totalTests:
        description: "è¿è¡Œçš„æµ‹è¯•æ€»æ•°ï¼ˆEditMode + PlayModeï¼‰"
        value: ${{ jobs.summarize_tests.outputs.totalTests }}
      passedTests:
        description: "é€šè¿‡çš„æµ‹è¯•æ€»æ•°ï¼ˆEditMode + PlayModeï¼‰"
        value: ${{ jobs.summarize_tests.outputs.passedTests }}
      failedTestNames:
        description: "å¤±è´¥æµ‹è¯•åç§°åˆ—è¡¨ï¼ˆå¤šè¡Œå­—ç¬¦ä¸²ï¼Œæ— å¤±è´¥æ—¶ä¸º 'None'ï¼‰"
        value: ${{ jobs.summarize_tests.outputs.failedTestNames }}
    secrets:
      UNITY_EMAIL: { required: true }
      UNITY_PASSWORD: { required: true }
      UNITY_LICENSE: { required: true }
  pull_request:
      branches:
        - develop

jobs:
  upload_unity_license:
    name: ğŸ“¥ï¸ ä¸Šä¼  Unity è®¸å¯è¯
    uses: ./.github/workflows/unity-license-uploader.yml
    secrets:
      inherit

  detect_tests:
    name: ğŸ” æ£€æµ‹æµ‹è¯•
    runs-on: ubuntu-latest
    outputs:
      has_editmode: ${{ steps.detect.outputs.has_editmode }}
      has_playmode: ${{ steps.detect.outputs.has_playmode }}
    steps:
      - id: detect
        uses: avalin/unity-ci-templates/.github/actions/detect-tests-existence@main
        with:
          editModePath: ${{ inputs.editModePath }}
          playModePath: ${{ inputs.playModePath }}

  run_editmode:
    name: ğŸ¥ª EditMode æµ‹è¯•
    needs: 
      - detect_tests
      - upload_unity_license
    if: needs.detect_tests.outputs.has_editmode == 'true'
    uses: ./.github/workflows/unity-tests-runner.yml
    with:
      testMode: EditMode
      unityVersion: ${{ inputs.unityVersion }}
      useGitLfs: ${{ inputs.useGitLfs }}
      timeoutMinutes: ${{ inputs.timeoutMinutes }}
      quietMode: ${{ inputs.quietMode }}
    secrets: inherit

  run_playmode:
    name: ğŸ® PlayMode æµ‹è¯•
    needs: 
      - detect_tests
      - upload_unity_license
    if: needs.detect_tests.outputs.has_playmode == 'true'
    uses: ./.github/workflows/unity-tests-runner.yml
    with:
      testMode: PlayMode
      unityVersion: ${{ inputs.unityVersion }}
      useGitLfs: ${{ inputs.useGitLfs }}
      timeoutMinutes: ${{ inputs.timeoutMinutes }}
      quietMode: ${{ inputs.quietMode }}
    secrets: inherit

  summarize_tests:
    name: ğŸ“„ æµ‹è¯•ç»“æœæ±‡æ€»
    needs: 
      - run_editmode
      - run_playmode
    if: |
      always() &&
      (
        inputs.quietMode == 'false' ||
        (needs.run_editmode.result == 'success' && needs.run_editmode.outputs.failed == 'true') ||
        (needs.run_playmode.result == 'success' && needs.run_playmode.outputs.failed == 'true')
      )
    uses: ./.github/workflows/summarize-tests.yml
    with:
      quietMode: ${{ inputs.quietMode }}
      editmodeFailed: ${{ needs.run_editmode.outputs.failed }}
      playmodeFailed: ${{ needs.run_playmode.outputs.failed }}
      editmodeTotal: ${{ needs.run_editmode.outputs.total }}
      editmodePassed: ${{ needs.run_editmode.outputs.passed }}
      editmodeResult: ${{ needs.run_editmode.outputs.result }}
      editmodeDuration: ${{ needs.run_editmode.outputs.duration }}
      playmodeTotal: ${{ needs.run_playmode.outputs.total }}
      playmodePassed: ${{ needs.run_playmode.outputs.passed }}
      playmodeResult: ${{ needs.run_playmode.outputs.result }}
      playmodeDuration: ${{ needs.run_playmode.outputs.duration }}

  test_failure_gatekeeper:
    name: ğŸ›‘ æµ‹è¯•å¤±è´¥ç»ˆæ­¢æµæ°´çº¿
    needs: summarize_tests
    runs-on: ubuntu-latest
    if: ${{ needs.summarize_tests.outputs.hasFails == 'true' }}
    steps:
      - name: å¼ºåˆ¶å¤±è´¥å·¥ä½œæµ
        run: |
          echo "æ£€æµ‹åˆ°æµ‹è¯•å¤±è´¥ï¼Œå¼ºåˆ¶ç»ˆæ­¢æµ‹è¯•æµç¨‹ã€‚"
          exit 1