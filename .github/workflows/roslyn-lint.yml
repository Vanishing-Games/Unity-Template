name: ğŸ“ˆ Roslyn ä»£ç è§„èŒƒæ£€æŸ¥ï¼ˆCSharpierï¼‰

on:
  workflow_call:
    inputs:
      formatDirectories:
        description: "è¦æ ¼å¼åŒ–çš„ç›®å½•åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼šAssets,CodeUnfucker/Srcï¼‰"
        required: false
        default: "Assets,CodeUnfucker/Src"
        type: string
      excludeFiles:
        description: "è¦æ’é™¤çš„æ–‡ä»¶æ¨¡å¼ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼š**/Generated/*,**/Temp.*ï¼‰"
        required: false
        default: ""
        type: string
      allowAutofix:
        description: "æ˜¯å¦å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–å¹¶æäº¤"
        required: false
        default: false
        type: boolean
      allowFailure:
        description: "æ˜¯å¦å…è®¸æ ¼å¼åŒ–å¤±è´¥"
        required: false
        default: false
        type: boolean
      verboseOutput:
        description: "æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼ˆæ‰“å°æ‰€æœ‰æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼‰"
        required: false
        default: true
        type: boolean

jobs:
  roslyn-lint:
    name: C# ä»£ç è§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé¡¹ç›®
        uses: actions/checkout@v4

      - name: å®‰è£… CSharpier
        run: |
          dotnet tool install -g csharpier
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: åˆ›å»ºæ ¼å¼åŒ–è„šæœ¬
        run: |
          cat > .github/scripts/csharpier-enhanced.sh << 'EOF'
          #!/bin/bash

          set -e

          # è§£æå‚æ•°
          DIRECTORIES="$1"
          EXCLUDE_PATTERNS="$2"
          CHECK_ONLY="$3"
          VERBOSE="$4"

          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
          IFS=',' read -ra DIRS <<< "$DIRECTORIES"
          IFS=',' read -ra EXCLUDES <<< "$EXCLUDE_PATTERNS"

          # é¢œè‰²è¾“å‡º
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color

          echo -e "${BLUE}ğŸ” CSharpier å¢å¼ºæ ¼å¼åŒ–è„šæœ¬${NC}"
          echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

          # æ˜¾ç¤ºé…ç½®
          echo -e "${YELLOW}ğŸ“‚ ç›®æ ‡ç›®å½•:${NC} $DIRECTORIES"
          if [ -n "$EXCLUDE_PATTERNS" ]; then
            echo -e "${YELLOW}âŒ æ’é™¤æ¨¡å¼:${NC} $EXCLUDE_PATTERNS"
          fi
          echo -e "${YELLOW}ğŸ”§ æ¨¡å¼:${NC} $([ "$CHECK_ONLY" = "true" ] && echo "æ£€æŸ¥æ¨¡å¼" || echo "æ ¼å¼åŒ–æ¨¡å¼")"
          echo ""

          total_files=0
          formatted_files=()
          format_errors=()

          # å¤„ç†æ¯ä¸ªç›®å½•
          for dir in "${DIRS[@]}"; do
            # ç§»é™¤å‰åç©ºæ ¼
            dir=$(echo "$dir" | xargs)
            
            if [ ! -d "$dir" ]; then
              echo -e "${YELLOW}âš ï¸  ç›®å½• '$dir' ä¸å­˜åœ¨ï¼Œè·³è¿‡${NC}"
              continue
            fi

            echo -e "${BLUE}ï¿½ å¤„ç†ç›®å½•: $dir${NC}"
            
            # æŸ¥æ‰¾æ‰€æœ‰ .cs æ–‡ä»¶
            cs_files=$(find "$dir" -name "*.cs" -type f)
            
            if [ -z "$cs_files" ]; then
              echo -e "${YELLOW}âš ï¸  åœ¨ '$dir' ä¸­æœªæ‰¾åˆ° .cs æ–‡ä»¶${NC}"
              continue
            fi

            # è¿‡æ»¤æ’é™¤çš„æ–‡ä»¶
            filtered_files=()
            while IFS= read -r file; do
              should_exclude=false
              
              # æ£€æŸ¥æ¯ä¸ªæ’é™¤æ¨¡å¼
              for exclude in "${EXCLUDES[@]}"; do
                exclude=$(echo "$exclude" | xargs) # ç§»é™¤å‰åç©ºæ ¼
                if [ -n "$exclude" ]; then
                  # ä½¿ç”¨ case æ¨¡å¼åŒ¹é…
                  case "$file" in
                    $exclude) should_exclude=true; break ;;
                  esac
                fi
              done
              
              if [ "$should_exclude" = false ]; then
                filtered_files+=("$file")
              elif [ "$VERBOSE" = "true" ]; then
                echo -e "  ${YELLOW}ğŸš« æ’é™¤:${NC} $file"
              fi
            done <<< "$cs_files"

            if [ ${#filtered_files[@]} -eq 0 ]; then
              echo -e "${YELLOW}âš ï¸  åœ¨ '$dir' ä¸­æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ .cs æ–‡ä»¶${NC}"
              continue
            fi

            echo -e "  ${GREEN}âœ“ æ‰¾åˆ° ${#filtered_files[@]} ä¸ª .cs æ–‡ä»¶${NC}"
            total_files=$((total_files + ${#filtered_files[@]}))

            # å¯¹æ¯ä¸ªæ–‡ä»¶è¿è¡Œ CSharpier
            for file in "${filtered_files[@]}"; do
              if [ "$CHECK_ONLY" = "true" ]; then
                if ! dotnet csharpier --check "$file" >/dev/null 2>&1; then
                  formatted_files+=("$file")
                  if [ "$VERBOSE" = "true" ]; then
                    echo -e "  ${RED}âŒ éœ€è¦æ ¼å¼åŒ–:${NC} $file"
                  fi
                else
                  if [ "$VERBOSE" = "true" ]; then
                    echo -e "  ${GREEN}âœ“ å·²æ ¼å¼åŒ–:${NC} $file"
                  fi
                fi
              else
                if dotnet csharpier "$file" >/dev/null 2>&1; then
                  formatted_files+=("$file")
                  if [ "$VERBOSE" = "true" ]; then
                    echo -e "  ${GREEN}âœ… å·²æ ¼å¼åŒ–:${NC} $file"
                  fi
                else
                  format_errors+=("$file")
                  if [ "$VERBOSE" = "true" ]; then
                    echo -e "  ${RED}âŒ æ ¼å¼åŒ–å¤±è´¥:${NC} $file"
                  fi
                fi
              fi
            done
            echo ""
          done

          # æ˜¾ç¤ºæ€»ç»“
          echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
          echo -e "${BLUE}ğŸ“Š æ ¼å¼åŒ–æ€»ç»“${NC}"
          echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
          echo -e "${YELLOW}ğŸ“ æ€»æ–‡ä»¶æ•°:${NC} $total_files"
          
          if [ "$CHECK_ONLY" = "true" ]; then
            echo -e "${YELLOW}âŒ éœ€è¦æ ¼å¼åŒ–:${NC} ${#formatted_files[@]}"
          else
            echo -e "${GREEN}âœ… æˆåŠŸæ ¼å¼åŒ–:${NC} ${#formatted_files[@]}"
            if [ ${#format_errors[@]} -gt 0 ]; then
              echo -e "${RED}âŒ æ ¼å¼åŒ–å¤±è´¥:${NC} ${#format_errors[@]}"
            fi
          fi

          # åˆ—å‡ºæ ¼å¼åŒ–çš„æ–‡ä»¶
          if [ ${#formatted_files[@]} -gt 0 ]; then
            echo ""
            if [ "$CHECK_ONLY" = "true" ]; then
              echo -e "${RED}ğŸ“‹ éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶åˆ—è¡¨:${NC}"
            else
              echo -e "${GREEN}ğŸ“‹ å·²æ ¼å¼åŒ–çš„æ–‡ä»¶åˆ—è¡¨:${NC}"
            fi
            for file in "${formatted_files[@]}"; do
              echo -e "  â€¢ $file"
            done
          fi

          # åˆ—å‡ºé”™è¯¯æ–‡ä»¶
          if [ ${#format_errors[@]} -gt 0 ]; then
            echo ""
            echo -e "${RED}ğŸ“‹ æ ¼å¼åŒ–å¤±è´¥çš„æ–‡ä»¶åˆ—è¡¨:${NC}"
            for file in "${format_errors[@]}"; do
              echo -e "  â€¢ $file"
            done
          fi

          echo ""

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "TOTAL_FILES=$total_files" >> $GITHUB_ENV
          echo "FORMATTED_COUNT=${#formatted_files[@]}" >> $GITHUB_ENV
          echo "ERROR_COUNT=${#format_errors[@]}" >> $GITHUB_ENV

          # å¦‚æœåœ¨æ£€æŸ¥æ¨¡å¼ä¸‹å‘ç°éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼Œåˆ™è¿”å›éé›¶é€€å‡ºç 
          if [ "$CHECK_ONLY" = "true" ] && [ ${#formatted_files[@]} -gt 0 ]; then
            echo "FORMAT_NEEDED=true" >> $GITHUB_ENV
            exit 1
          fi

          # å¦‚æœæœ‰æ ¼å¼åŒ–é”™è¯¯ï¼Œåˆ™è¿”å›éé›¶é€€å‡ºç 
          if [ ${#format_errors[@]} -gt 0 ]; then
            echo "FORMAT_ERRORS=true" >> $GITHUB_ENV
            exit 1
          fi

          exit 0
          EOF
          
          chmod +x .github/scripts/csharpier-enhanced.sh

      - name: æ£€æŸ¥ C# æ ¼å¼ï¼ˆCSharpierï¼‰
        id: csharpier-check
        continue-on-error: true
        run: |
          mkdir -p .github/scripts
          ./.github/scripts/csharpier-enhanced.sh "${{ inputs.formatDirectories }}" "${{ inputs.excludeFiles }}" "true" "${{ inputs.verboseOutput }}"

      - name: å¤„ç†æ ¼å¼æ£€æŸ¥ç»“æœ
        if: env.FORMAT_NEEDED == 'true' && inputs.allowFailure == false
        run: |
          echo "âŒ æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ä¸” allowFailure ä¸º falseï¼Œä½œä¸šå¤±è´¥ã€‚"
          echo "ğŸ’¡ è¯·è¿è¡Œ \`dotnet csharpier .\` ä¿®å¤æ ¼å¼é—®é¢˜ï¼Œæˆ–é‡æ–°è¿è¡Œå¹¶è®¾ç½® \`allowAutofix: true\`ã€‚"
          exit 1

      - name: è‡ªåŠ¨æ ¼å¼åŒ– C# æ–‡ä»¶ï¼ˆCSharpierï¼‰
        if: inputs.allowAutofix == true && (env.FORMAT_NEEDED == 'true' || env.FORMAT_ERRORS == 'true')
        run: |
          echo "ğŸ› ï¸ å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ­£åœ¨åº”ç”¨æ›´æ”¹..."
          ./.github/scripts/csharpier-enhanced.sh "${{ inputs.formatDirectories }}" "${{ inputs.excludeFiles }}" "false" "${{ inputs.verboseOutput }}"

      - name: è¿è¡Œ Unity é£æ ¼ä¿®å¤å™¨
        if: inputs.allowAutofix == true && (env.FORMAT_NEEDED == 'true' || env.FORMAT_ERRORS == 'true')
        run: |
          if [ -f ".github/scripts/analyze/csharpier-addon.sh" ]; then
            bash .github/scripts/analyze/csharpier-addon.sh
          else
            echo "âš ï¸ Unity é£æ ¼ä¿®å¤å™¨è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi

      - name: æäº¤æ ¼å¼åŒ–ä¿®å¤
        if: inputs.allowAutofix == true && (env.FORMAT_NEEDED == 'true' || env.FORMAT_ERRORS == 'true')
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # æ·»åŠ æ‰€æœ‰æ ¼å¼åŒ–çš„ç›®å½•
          IFS=',' read -ra DIRS <<< "${{ inputs.formatDirectories }}"
          for dir in "${DIRS[@]}"; do
            dir=$(echo "$dir" | xargs)
            if [ -d "$dir" ]; then
              git add "$dir"
            fi
          done
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰å‘ç°æ ¼å¼åŒ–æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ROSLYN-AUTOFIX: auto-format C# files with CSharpier

æ ¼å¼åŒ–ç›®å½•: ${{ inputs.formatDirectories }}
æ’é™¤æ¨¡å¼: ${{ inputs.excludeFiles }}
æ ¼å¼åŒ–æ–‡ä»¶æ•°: ${FORMATTED_COUNT:-0}
æ€»æ–‡ä»¶æ•°: ${TOTAL_FILES:-0}"
            git push || echo "âš ï¸ æ— æ³•æ¨é€æ›´æ”¹ï¼ˆå¯èƒ½æ˜¯ PR æˆ–æ— æƒé™ï¼‰"
          fi

      - name: æ·»åŠ æ±‡æ€»
        if: always()
        run: |
          echo "## ğŸ” CSharpier æ ¼å¼åŒ–æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‚ æ ¼å¼åŒ–ç›®å½• | \`${{ inputs.formatDirectories }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ æ’é™¤æ¨¡å¼ | \`${{ inputs.excludeFiles }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ æ€»æ–‡ä»¶æ•° | ${TOTAL_FILES:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… æ ¼å¼åŒ–æ–‡ä»¶æ•° | ${FORMATTED_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ é”™è¯¯æ–‡ä»¶æ•° | ${ERROR_COUNT:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ è‡ªåŠ¨ä¿®å¤ | ${{ inputs.allowAutofix }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${FORMAT_NEEDED:-false}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æœ¬åœ°è¿è¡Œ \`dotnet csharpier .\` æˆ–é‡æ–°è¿è¡Œå¹¶è®¾ç½® \`allowAutofix: true\`ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "${ERROR_COUNT:-0}" != "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **æ ¼å¼åŒ–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯**" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **æ‰€æœ‰æ–‡ä»¶æ ¼å¼åŒ–æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          fi