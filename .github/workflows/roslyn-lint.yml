name: ðŸ“ˆ Roslyn ä»£ç è§„èŒƒæ£€æŸ¥ï¼ˆCSharpierï¼‰

on:
  workflow_call:
    inputs:
      allowAutofix:
        description: "æ˜¯å¦å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–å¹¶æäº¤"
        required: false
        default: false
        type: boolean
      allowFailure:
        description: "æ˜¯å¦å…è®¸æ ¼å¼åŒ–å¤±è´¥"
        required: false
        default: false
        type: boolean

jobs:
  roslyn-lint:
    name: C# ä»£ç è§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé¡¹ç›®
        uses: actions/checkout@v4

      - name: å®‰è£… CSharpier
        run: |
          dotnet tool install -g csharpier
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: æ£€æŸ¥ C# æ ¼å¼ï¼ˆCSharpierï¼‰
        id: csharpier
        run: |
          echo "ðŸ“‚ æ­£åœ¨æ£€æŸ¥ Assets/ ç›®å½•ä¸‹çš„ä»£ç æ ¼å¼..."
          if ! dotnet csharpier --check Assets; then
            echo "FORMAT_FAILED=true" >> $GITHUB_ENV
          fi

      - name: è‹¥å‘çŽ°æ ¼å¼é—®é¢˜ä¸”ä¸å…è®¸å¤±è´¥åˆ™å¤±è´¥
        if: inputs.allowFailure == false
        run: |
          echo "âŒ æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ä¸” allowFailure ä¸º falseï¼Œä½œä¸šå¤±è´¥ã€‚"
          exit 1

      - name: è‡ªåŠ¨æ ¼å¼åŒ– C# æ–‡ä»¶ï¼ˆCSharpierï¼‰
        if: ${{ inputs.allowAutofix == true }}
        run: |
          echo "ðŸ› ï¸ å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ­£åœ¨åº”ç”¨æ›´æ”¹..."
          dotnet csharpier Assets

      - name: è¿è¡Œ Unity é£Žæ ¼ä¿®å¤å™¨
        if: ${{ inputs.allowAutofix == true }}
        run: bash .github/scripts/analyze/csharpier-addon.sh

      - name: æäº¤æ ¼å¼åŒ–ä¿®å¤
        if: ${{ inputs.allowAutofix == true }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Assets
          git diff --cached --quiet || git commit -m "ROSLYN-AUTOFIX: auto-format C# files with CSharpier"
          git push || echo "âš ï¸ æ— æ³•æŽ¨é€æ›´æ”¹ï¼ˆå¯èƒ½æ˜¯ PR æˆ–æ— æƒé™ï¼‰"

      - name: æ·»åŠ æ±‡æ€»
        if: failure()
        run: |
          echo "âŒ **æ£€æµ‹åˆ° CSharpier æ ¼å¼é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æœ¬åœ°è¿è¡Œ \`dotnet csharpier .\` æˆ–é‡æ–°è¿è¡Œå¹¶è®¾ç½® \`allowAutofix: true\`ã€‚" >> $GITHUB_STEP_SUMMARY