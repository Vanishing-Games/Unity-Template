name: ğŸš€ CIæµæ°´çº¿

on:
  workflow_call:
    inputs:
      buildTargets:
        description: "æ„å»ºç›®æ ‡JSONæ•°ç»„"
        required: false
        default: '[]'
        type: string
      testsOnly:
        description: "æ˜¯å¦ä»…æ‰§è¡Œæµ‹è¯•"
        required: false
        default: 'false'
        type: string
      buildType:
        description: "æ„å»ºç±»å‹"
        required: false
        default: 'preview'
        type: string
      triggerSource:
        description: "è§¦å‘æº"
        required: false
        default: 'manual'
        type: string
      enableDebug:
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼"
        required: false
        default: false
        type: boolean
      enableBuildTest:
        description: "æ˜¯å¦å¯ç”¨æ„å»ºæµ‹è¯•"
        required: false
        default: 'true'
        type: string
    secrets:
      UNITY_EMAIL:
        required: true
      UNITY_PASSWORD:
        required: true
      UNITY_LICENSE:
        required: true

permissions:
  contents: write
  actions: write

env:
  CONFIG_PATH: '.github/config'
  DEBUG_MODE: ${{ inputs.enableDebug || 'false' }}

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ï¿½ Roslyn ä»£ç è§„èŒƒæ£€æŸ¥
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  roslyn_lint:
    name: ğŸ“ˆ Roslyn ä»£ç è§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      format_failed: ${{ steps.check_format.outputs.format_failed }}
      config_enabled: ${{ steps.load_config.outputs.enabled }}
    steps:
      - name: ğŸ“ æ£€å‡ºé¡¹ç›®
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ“‹ åŠ è½½Roslyné…ç½®
        id: load_config
        shell: bash
        run: |
          set -euo pipefail
          
          CONFIG_FILE=".github/config/roslyn-lint-config.json"
          
          if [[ ! -f "$CONFIG_FILE" ]]; then
            echo "âŒ Roslyné…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # è¯»å–é…ç½®
          ENABLED=$(jq -r '.["roslyn-lint"].enabled // false' "$CONFIG_FILE")
          AUTOFIX=$(jq -r '.["roslyn-lint"].autofix // true' "$CONFIG_FILE")
          ALLOW_FAILURE=$(jq -r '.["roslyn-lint"].allowFailure // false' "$CONFIG_FILE")
          
          # è¯»å–æ£€æŸ¥è·¯å¾„
          CHECK_PATHS=$(jq -r '.checkPaths[]?' "$CONFIG_FILE" | tr '\n' ' ')
          
          echo "ğŸ“‹ Roslyné…ç½®:"
          echo "  - å¯ç”¨: $ENABLED"
          echo "  - è‡ªåŠ¨ä¿®å¤: $AUTOFIX"
          echo "  - å…è®¸å¤±è´¥: $ALLOW_FAILURE"
          echo "  - æ£€æŸ¥è·¯å¾„: $CHECK_PATHS"
          
          echo "enabled=$ENABLED" >> "$GITHUB_OUTPUT"
          echo "autofix=$AUTOFIX" >> "$GITHUB_OUTPUT"
          echo "allowFailure=$ALLOW_FAILURE" >> "$GITHUB_OUTPUT"
          echo "checkPaths=$CHECK_PATHS" >> "$GITHUB_OUTPUT"

      - name: ï¿½ å®‰è£… CSharpier
        if: steps.load_config.outputs.enabled == 'true'
        run: |
          dotnet tool install -g csharpier
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: ğŸ“ˆ æ£€æŸ¥ C# æ ¼å¼ï¼ˆCSharpierï¼‰
        if: steps.load_config.outputs.enabled == 'true'
        id: check_format
        run: |
          echo "ğŸ“‚ æ­£åœ¨æ£€æŸ¥é…ç½®çš„ç›®å½•ä»£ç æ ¼å¼..."
          CHECK_PATHS="${{ steps.load_config.outputs.checkPaths }}"
          FORMAT_FAILED=false
          
          for path in $CHECK_PATHS; do
            if [[ -d "$path" ]]; then
              echo "ğŸ” æ£€æŸ¥ç›®å½•: $path"
              if ! dotnet csharpier --check "$path"; then
                echo "âŒ ç›®å½• $path ä¸­å‘ç°æ ¼å¼é—®é¢˜"
                FORMAT_FAILED=true
              else
                echo "âœ… ç›®å½• $path æ ¼å¼æ£€æŸ¥é€šè¿‡"
              fi
            else
              echo "âš ï¸ ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡: $path"
            fi
          done
          
          echo "format_failed=$FORMAT_FAILED" >> "$GITHUB_OUTPUT"
          
          if [[ "$FORMAT_FAILED" == "true" && "${{ steps.load_config.outputs.allowFailure }}" == "false" ]]; then
            echo "âŒ æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ä¸”ä¸å…è®¸å¤±è´¥ï¼Œä½œä¸šå¤±è´¥ã€‚"
            exit 1
          fi

      - name: ğŸ› ï¸ è‡ªåŠ¨æ ¼å¼åŒ– C# æ–‡ä»¶ï¼ˆCSharpierï¼‰
        if: steps.load_config.outputs.enabled == 'true' && steps.load_config.outputs.autofix == 'true' && steps.check_format.outputs.format_failed == 'true'
        run: |
          echo "ğŸ› ï¸ å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ­£åœ¨åº”ç”¨æ›´æ”¹..."
          CHECK_PATHS="${{ steps.load_config.outputs.checkPaths }}"
          
          for path in $CHECK_PATHS; do
            if [[ -d "$path" ]]; then
              echo "ğŸ”§ æ ¼å¼åŒ–ç›®å½•: $path"
              dotnet csharpier "$path"
            fi
          done

      - name: ğŸ”§ è¿è¡Œ Unity é£æ ¼ä¿®å¤å™¨
        if: steps.load_config.outputs.enabled == 'true' && steps.load_config.outputs.autofix == 'true' && steps.check_format.outputs.format_failed == 'true'
        run: |
          if [[ -f ".github/scripts/analyze/csharpier-addon.sh" ]]; then
            echo "ğŸ”§ è¿è¡ŒUnityé£æ ¼ä¿®å¤å™¨..."
            bash .github/scripts/analyze/csharpier-addon.sh
          else
            echo "âš ï¸ Unityé£æ ¼ä¿®å¤å™¨è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: ğŸ“ æäº¤æ ¼å¼åŒ–ä¿®å¤
        if: steps.load_config.outputs.enabled == 'true' && steps.load_config.outputs.autofix == 'true' && steps.check_format.outputs.format_failed == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          CHECK_PATHS="${{ steps.load_config.outputs.checkPaths }}"
          for path in $CHECK_PATHS; do
            if [[ -d "$path" ]]; then
              git add "$path"
            fi
          done
          
          if git diff --cached --quiet; then
            echo "ğŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ROSLYN-AUTOFIX: auto-format C# files with CSharpier"
            
            # å°è¯•æ¨é€æ›´æ”¹
            if git push; then
              echo "âœ… æ ¼å¼åŒ–æ›´æ”¹å·²æˆåŠŸæ¨é€"
            else
              echo "âš ï¸ æ— æ³•æ¨é€æ›´æ”¹ï¼ˆå¯èƒ½æ˜¯PRæˆ–æ— æƒé™ï¼‰"
            fi
          fi

      - name: ğŸ“Š æ·»åŠ æ ¼å¼åŒ–æ±‡æ€»
        if: always() && steps.load_config.outputs.enabled == 'true'
        run: |
          echo "# ğŸ“ˆ Roslyn ä»£ç è§„èŒƒæ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.check_format.outputs.format_failed }}" == "true" ]]; then
            if [[ "${{ steps.load_config.outputs.autofix }}" == "true" ]]; then
              echo "âš ï¸ **æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **æ£€æµ‹åˆ° CSharpier æ ¼å¼é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æœ¬åœ°è¿è¡Œ \`dotnet csharpier .\` æˆ–é‡æ–°è¿è¡Œå¹¶è®¾ç½®è‡ªåŠ¨ä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥çš„ç›®å½•:** ${{ steps.load_config.outputs.checkPaths }}" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ï¿½ï¿½ é…ç½®è§£æå’ŒéªŒè¯
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  parse_config:
    name: ğŸ” è§£æå’ŒéªŒè¯é…ç½®
    needs: roslyn_lint
    runs-on: ubuntu-latest
    outputs:
      projectName: ${{ steps.config.outputs.projectName }}
      skipTests: ${{ steps.config.outputs.skipTests }}
      testsOnly: ${{ steps.config.outputs.testsOnly }}
      buildType: ${{ steps.config.outputs.buildType }}
      buildVersion: ${{ steps.config.outputs.buildVersion }}
      retentionDays: ${{ steps.config.outputs.retentionDays }}
      requiresCombined: ${{ steps.config.outputs.requiresCombined }}
      skipPerBuildTarget: ${{ steps.config.outputs.skipPerBuildTarget }}
      unityVersion: ${{ steps.config.outputs.unityVersion }}
      useGitLfs: ${{ steps.config.outputs.useGitLfs }}
      editModePath: ${{ steps.config.outputs.editModePath }}
      playModePath: ${{ steps.config.outputs.playModePath }}
      timeoutMinutesTests: ${{ steps.config.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild: ${{ steps.config.outputs.timeoutMinutesBuild }}
      quietMode: ${{ steps.config.outputs.quietMode }}
      buildTargets: ${{ steps.config.outputs.buildTargets }}
      shouldRun: ${{ steps.validate.outputs.shouldRun }}
      skipReason: ${{ steps.validate.outputs.skipReason }}
    steps:
      - name: ğŸ“ æ£€å‡ºé…ç½®æ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ env.CONFIG_PATH }}
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ğŸ”§ è§£æé…ç½®
        id: config
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ğŸ“‹ å¼€å§‹è§£æé…ç½®..."
          
          # åŠ è½½é…ç½®æ–‡ä»¶
          DEFAULTS_CONFIG="${CONFIG_PATH}/defaults.json"
          CI_DEFAULTS_CONFIG="${CONFIG_PATH}/ci-defaults.json"
          PIPELINE_CONFIG="${CONFIG_PATH}/pipeline-config.json"
          
          # éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
          for config_file in "$DEFAULTS_CONFIG" "$CI_DEFAULTS_CONFIG" "$PIPELINE_CONFIG"; do
            if [[ ! -f "$config_file" ]]; then
              echo "âŒ ç¼ºå°‘é…ç½®æ–‡ä»¶: $config_file"
              exit 1
            fi
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶: $config_file"
          done
          
          # ä»defaults.jsonè¯»å–é…ç½®
          echo "ğŸ“– è¯»å–é»˜è®¤é…ç½®..."
          PROJECT_NAME=$(jq -r '.project.name // "Unity-Template"' "$DEFAULTS_CONFIG")
          UNITY_VERSION=$(jq -r '.unity.version // "2022.3.58f1"' "$DEFAULTS_CONFIG")
          USE_GIT_LFS=$(jq -r '.pipeline.useGitLfs // true' "$DEFAULTS_CONFIG")
          QUIET_MODE=$(jq -r '.pipeline.quietMode // false' "$DEFAULTS_CONFIG")
          EDITMODE_PATH=$(jq -r '.tests.editMode.path // "Assets/Tests/Editor"' "$DEFAULTS_CONFIG")
          PLAYMODE_PATH=$(jq -r '.tests.playMode.path // "Assets/Tests/PlayMode"' "$DEFAULTS_CONFIG")
          TIMEOUT_TESTS=$(jq -r '.tests.timeoutMinutes // 20' "$DEFAULTS_CONFIG")
          TIMEOUT_BUILD=$(jq -r '.build.timeoutMinutes // 30' "$DEFAULTS_CONFIG")
          FORCE_COMBINE=$(jq -r '.pipeline.forceCombineArtifacts // true' "$DEFAULTS_CONFIG")
          
          # ä»ci-defaults.jsonè¯»å–CIç‰¹å®šé…ç½®
          echo "ğŸ“– è¯»å–CIé»˜è®¤é…ç½®..."
          CI_PROJECT_NAME=$(jq -r '.metadataConfig.projectName // empty' "$CI_DEFAULTS_CONFIG")
          CI_BUILD_TYPE=$(jq -r '.metadataConfig.buildType // "preview"' "$CI_DEFAULTS_CONFIG")
          CI_BUILD_VERSION=$(jq -r '.metadataConfig.buildVersion // "0.1.0"' "$CI_DEFAULTS_CONFIG")
          CI_RETENTION_DAYS=$(jq -r '.metadataConfig.retentionDays // 30' "$CI_DEFAULTS_CONFIG")
          CI_REQUIRES_COMBINED=$(jq -r '.artifactConfig.requiresCombined // true' "$CI_DEFAULTS_CONFIG")
          CI_SKIP_PER_BUILD=$(jq -r '.artifactConfig.skipPerBuildTarget // false' "$CI_DEFAULTS_CONFIG")
          
          # åº”ç”¨è¾“å…¥å‚æ•°æˆ–ä½¿ç”¨é»˜è®¤å€¼
          FINAL_PROJECT_NAME="${CI_PROJECT_NAME:-$PROJECT_NAME}"
          FINAL_BUILD_TYPE="${{ inputs.buildType || '$CI_BUILD_TYPE' }}"
          FINAL_TESTS_ONLY="${{ inputs.testsOnly || 'false' }}"
          FINAL_BUILD_VERSION="$CI_BUILD_VERSION"
          
          # å¤„ç†æ„å»ºç›®æ ‡ - ä¼˜å…ˆçº§ï¼šè¾“å…¥å‚æ•° > ä»“åº“å˜é‡ > é…ç½®æ–‡ä»¶é»˜è®¤å€¼
          BUILD_TARGETS_INPUT="${{ inputs.buildTargets || '[]' }}"
          if [[ "$BUILD_TARGETS_INPUT" == "[]" || "$BUILD_TARGETS_INPUT" == "" ]]; then
            # å°è¯•ä»ä»“åº“å˜é‡è·å–
            REPO_BUILD_TARGETS="${{ vars.BUILD_TARGETS || '' }}"
            if [[ -n "$REPO_BUILD_TARGETS" && "$REPO_BUILD_TARGETS" != "[]" && "$REPO_BUILD_TARGETS" != "null" ]]; then
              BUILD_TARGETS_INPUT="$REPO_BUILD_TARGETS"
              echo "ğŸ”„ ä½¿ç”¨ä»“åº“å˜é‡æ„å»ºç›®æ ‡: $BUILD_TARGETS_INPUT"
            else
              # ä»defaults.jsonè·å–é»˜è®¤æ„å»ºç›®æ ‡
              BUILD_TARGETS_INPUT=$(jq -c '.build.defaultTargets // ["WebGL","StandaloneWindows64","StandaloneOSX"]' "$DEFAULTS_CONFIG")
              echo "ğŸ”„ ä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤æ„å»ºç›®æ ‡: $BUILD_TARGETS_INPUT"
            fi
          fi
          
          # æ ¹æ®æ„å»ºç±»å‹è®¾ç½®ä¿ç•™å¤©æ•°
          RETENTION_MAPPING=$(jq -r '.build.retentionDays' "$DEFAULTS_CONFIG")
          FINAL_RETENTION=$(echo "$RETENTION_MAPPING" | jq -r ".[\"$FINAL_BUILD_TYPE\"] // 30")
          
          # è¾“å‡ºé…ç½®
          echo "projectName=$FINAL_PROJECT_NAME" >> "$GITHUB_OUTPUT"
          echo "skipTests=false" >> "$GITHUB_OUTPUT"
          echo "testsOnly=$FINAL_TESTS_ONLY" >> "$GITHUB_OUTPUT"
          echo "buildType=$FINAL_BUILD_TYPE" >> "$GITHUB_OUTPUT"
          echo "buildVersion=$FINAL_BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "retentionDays=$FINAL_RETENTION" >> "$GITHUB_OUTPUT"
          echo "requiresCombined=$CI_REQUIRES_COMBINED" >> "$GITHUB_OUTPUT"
          echo "skipPerBuildTarget=$CI_SKIP_PER_BUILD" >> "$GITHUB_OUTPUT"
          echo "unityVersion=$UNITY_VERSION" >> "$GITHUB_OUTPUT"
          echo "useGitLfs=$USE_GIT_LFS" >> "$GITHUB_OUTPUT"
          echo "editModePath=$EDITMODE_PATH" >> "$GITHUB_OUTPUT"
          echo "playModePath=$PLAYMODE_PATH" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesTests=$TIMEOUT_TESTS" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesBuild=$TIMEOUT_BUILD" >> "$GITHUB_OUTPUT"
          echo "quietMode=$QUIET_MODE" >> "$GITHUB_OUTPUT"
          echo "buildTargets=$BUILD_TARGETS_INPUT" >> "$GITHUB_OUTPUT"
          
          echo "âœ… é…ç½®è§£æå®Œæˆ"
          
          # è¾“å‡ºè¯¦ç»†é…ç½®ä¿¡æ¯
          if [[ "${{ env.DEBUG_MODE }}" == "true" ]]; then
            echo "ğŸ› è¯¦ç»†é…ç½®ä¿¡æ¯:"
            echo "  - é¡¹ç›®å: $FINAL_PROJECT_NAME"
            echo "  - Unityç‰ˆæœ¬: $UNITY_VERSION"
            echo "  - æ„å»ºç±»å‹: $FINAL_BUILD_TYPE"
            echo "  - æ„å»ºç‰ˆæœ¬: $FINAL_BUILD_VERSION"
            echo "  - ä»…æµ‹è¯•: $FINAL_TESTS_ONLY"
            echo "  - æ„å»ºç›®æ ‡: $BUILD_TARGETS_INPUT"
            echo "  - ä¿ç•™å¤©æ•°: $FINAL_RETENTION"
            echo "  - æµ‹è¯•è¶…æ—¶: $TIMEOUT_TESTSåˆ†é’Ÿ"
            echo "  - æ„å»ºè¶…æ—¶: $TIMEOUT_BUILDåˆ†é’Ÿ"
          fi

      - name: ğŸ›¡ï¸ éªŒè¯é…ç½®å’Œç¯å¢ƒ
        id: validate
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ğŸ” éªŒè¯é…ç½®å’Œç¯å¢ƒ..."
          
          # æ£€æŸ¥commitå…³é”®å­— (å¦‚æœæ˜¯pushè§¦å‘)
          if [[ "${{ github.event_name }}" == "push" ]]; then
            COMMIT_MSG="${{ github.event.head_commit.message || '' }}"
            echo "ğŸ“ Commitæ¶ˆæ¯: $COMMIT_MSG"
            
            # æ£€æŸ¥è·³è¿‡å…³é”®å­—
            if [[ "$COMMIT_MSG" == *"[SKIP CICD]"* || "$COMMIT_MSG" == *"[SKIP CI]"* ]]; then
              echo "ğŸš« æ£€æµ‹åˆ°è·³è¿‡CIå…³é”®å­—ï¼Œç»ˆæ­¢æµæ°´çº¿"
              echo "shouldRun=false" >> "$GITHUB_OUTPUT"
              echo "skipReason=commit_skip_keyword" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            

          fi
          
          # éªŒè¯æ„å»ºç›®æ ‡
          BUILD_TARGETS="${{ steps.config.outputs.buildTargets }}"
          if [[ "$BUILD_TARGETS" == "[]" || "$BUILD_TARGETS" == "" ]]; then
            if [[ "${{ steps.config.outputs.testsOnly }}" != "true" ]]; then
              echo "âŒ æœªæŒ‡å®šæœ‰æ•ˆçš„æ„å»ºç›®æ ‡ä¸”æœªè®¾ç½®ä»…æµ‹è¯•æ¨¡å¼"
              echo "shouldRun=false" >> "$GITHUB_OUTPUT"
              echo "skipReason=no_build_targets" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          
          # éªŒè¯Unityç‰ˆæœ¬æ ¼å¼
          UNITY_VERSION="${{ steps.config.outputs.unityVersion }}"
          if [[ ! "$UNITY_VERSION" =~ ^[0-9]{4}\.[0-9]+\.[0-9]+[a-z][0-9]+$ ]]; then
            echo "âš ï¸ Unityç‰ˆæœ¬æ ¼å¼å¯èƒ½ä¸æ­£ç¡®: $UNITY_VERSION"
          fi
          
          echo "shouldRun=true" >> "$GITHUB_OUTPUT"
          echo "skipReason=" >> "$GITHUB_OUTPUT"
          echo "âœ… é…ç½®éªŒè¯é€šè¿‡"

      - name: ğŸ“Š ç”Ÿæˆé…ç½®æ‘˜è¦
        if: always()
        run: |
          echo "# ğŸ”§ CIæµæ°´çº¿é…ç½®æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜¯å¦æ‰§è¡Œ | ${{ steps.validate.outputs.shouldRun == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›®åç§° | \`${{ steps.config.outputs.projectName }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Unityç‰ˆæœ¬ | \`${{ steps.config.outputs.unityVersion }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºç±»å‹ | \`${{ steps.config.outputs.buildType }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ä»…æµ‹è¯•æ¨¡å¼ | ${{ steps.config.outputs.testsOnly == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯ç”¨æ„å»ºæµ‹è¯• | ${{ inputs.enableBuildTest == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºç›®æ ‡ | \`${{ steps.config.outputs.buildTargets }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æº | \`${{ inputs.triggerSource || github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.validate.outputs.shouldRun }}" != "true" ]]; then
            echo "| è·³è¿‡åŸå›  | \`${{ steps.validate.outputs.skipReason }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§ª æµ‹è¯•é˜¶æ®µ
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  run_tests:
    name: ğŸ§ª æ‰§è¡ŒUnityæµ‹è¯•
    if: needs.parse_config.outputs.shouldRun == 'true' && needs.parse_config.outputs.skipTests != 'true'
    needs: parse_config
    uses: ./.github/workflows/step-1-test.yml
    with:
      unityVersion: ${{ needs.parse_config.outputs.unityVersion }}
      useGitLfs: ${{ needs.parse_config.outputs.useGitLfs }}
      editModePath: ${{ needs.parse_config.outputs.editModePath }}
      playModePath: ${{ needs.parse_config.outputs.playModePath }}
      timeoutMinutes: ${{ fromJson(needs.parse_config.outputs.timeoutMinutesTests) }}
      quietMode: ${{ needs.parse_config.outputs.quietMode }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ—ï¸ æ„å»ºé˜¶æ®µ (ä»…åœ¨éä»…æµ‹è¯•æ¨¡å¼ä¸‹æ‰§è¡Œ)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  run_build:
    name: ğŸ—ï¸ æ‰§è¡ŒUnityæ„å»º
    needs: 
      - parse_config
      - run_tests
    if: >
      always() &&
      needs.parse_config.outputs.shouldRun == 'true' &&
      needs.parse_config.outputs.testsOnly != 'true' &&
      inputs.enableBuildTest == 'true' &&
      (needs.run_tests.result == 'success' || needs.run_tests.result == 'skipped')
    uses: ./.github/workflows/step-2-build.yml
    with:
      projectName: ${{ needs.parse_config.outputs.projectName }}
      unityVersion: ${{ needs.parse_config.outputs.unityVersion }}
      buildVersion: ${{ needs.parse_config.outputs.buildVersion }}
      buildType: ${{ needs.parse_config.outputs.buildType }}
      buildTargets: ${{ needs.parse_config.outputs.buildTargets }}
      combineArtifacts: ${{ needs.parse_config.outputs.requiresCombined }}
      timeoutMinutes: ${{ fromJson(needs.parse_config.outputs.timeoutMinutesBuild) }}
      retentionDays: ${{ fromJson(needs.parse_config.outputs.retentionDays) }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“Š æœ€ç»ˆæ‘˜è¦å’Œé”™è¯¯å¤„ç†
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pipeline_summary:
    name: ğŸ“Š CIæµæ°´çº¿æ‰§è¡Œæ‘˜è¦
    needs: 
      - roslyn_lint
      - parse_config
      - run_tests
      - run_build
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†æ‰§è¡Œæ‘˜è¦
        run: |
          echo "# ğŸš€ CIæµæ°´çº¿æ‰§è¡ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åŸºæœ¬ä¿¡æ¯
          echo "## ğŸ“‹ åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰§è¡Œæ—¶é—´ | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘äº‹ä»¶ | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯/æ ‡ç­¾ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| å·¥ä½œæµè¿è¡ŒID | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # é˜¶æ®µæ‰§è¡ŒçŠ¶æ€
          echo "## ğŸ”„ æ‰§è¡Œé˜¶æ®µçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ | ç»“æœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Roslynä»£ç æ ¼å¼æ£€æŸ¥
          if [[ "${{ needs.roslyn_lint.outputs.config_enabled }}" == "true" ]]; then
            ROSLYN_STATUS="âŒ å¤±è´¥"
            ROSLYN_RESULT=""
            case "${{ needs.roslyn_lint.result }}" in
              "success")
                if [[ "${{ needs.roslyn_lint.outputs.format_failed }}" == "true" ]]; then
                  ROSLYN_STATUS="âš ï¸ å·²ä¿®å¤"
                  ROSLYN_RESULT="æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ï¼Œå·²è‡ªåŠ¨ä¿®å¤"
                else
                  ROSLYN_STATUS="âœ… é€šè¿‡"
                  ROSLYN_RESULT="ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
                fi
                ;;
              "failure")
                ROSLYN_RESULT="ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥"
                ;;
              "skipped")
                ROSLYN_STATUS="â­ï¸ è·³è¿‡"
                ROSLYN_RESULT="Roslynæ£€æŸ¥è¢«è·³è¿‡"
                ;;
              *)
                ROSLYN_RESULT="æœªæ‰§è¡Œæˆ–çŠ¶æ€æœªçŸ¥"
                ;;
            esac
            echo "| Roslynä»£ç æ ¼å¼ | $ROSLYN_STATUS | $ROSLYN_RESULT |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Roslynä»£ç æ ¼å¼ | â­ï¸ ç¦ç”¨ | åœ¨é…ç½®ä¸­æœªå¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # é…ç½®è§£æ
          CONFIG_STATUS="âŒ å¤±è´¥"
          CONFIG_RESULT="æœªæ‰§è¡Œ"
          if [[ "${{ needs.parse_config.result }}" == "success" ]]; then
            if [[ "${{ needs.parse_config.outputs.shouldRun }}" == "true" ]]; then
              CONFIG_STATUS="âœ… æˆåŠŸ"
              CONFIG_RESULT="é…ç½®è§£æå®Œæˆï¼Œæµæ°´çº¿ç»§ç»­æ‰§è¡Œ"
            else
              CONFIG_STATUS="â­ï¸ è·³è¿‡"
              CONFIG_RESULT="æ£€æµ‹åˆ°è·³è¿‡æ¡ä»¶: ${{ needs.parse_config.outputs.skipReason }}"
            fi
          elif [[ "${{ needs.parse_config.result }}" == "failure" ]]; then
            CONFIG_RESULT="é…ç½®è§£æå¤±è´¥"
          fi
          echo "| é…ç½®è§£æ | $CONFIG_STATUS | $CONFIG_RESULT |" >> $GITHUB_STEP_SUMMARY
          
          # æµ‹è¯•æ‰§è¡Œ
          if [[ "${{ needs.parse_config.outputs.shouldRun }}" == "true" ]]; then
            TEST_STATUS="âŒ å¤±è´¥"
            TEST_RESULT=""
            case "${{ needs.run_tests.result }}" in
              "success")
                TEST_STATUS="âœ… æˆåŠŸ"
                if [[ "${{ needs.run_tests.outputs.hasFails }}" == "true" ]]; then
                  TEST_STATUS="âš ï¸ éƒ¨åˆ†å¤±è´¥"
                  TEST_RESULT="æ€»æµ‹è¯•: ${{ needs.run_tests.outputs.totalTests }}, é€šè¿‡: ${{ needs.run_tests.outputs.passedTests }}"
                else
                  TEST_RESULT="æ‰€æœ‰æµ‹è¯•é€šè¿‡ (æ€»è®¡: ${{ needs.run_tests.outputs.totalTests }})"
                fi
                ;;
              "failure")
                TEST_RESULT="æµ‹è¯•æ‰§è¡Œå¤±è´¥"
                ;;
              "skipped")
                TEST_STATUS="â­ï¸ è·³è¿‡"
                TEST_RESULT="è·³è¿‡æµ‹è¯• (skipTests=true)"
                ;;
              *)
                TEST_RESULT="æœªæ‰§è¡Œæˆ–çŠ¶æ€æœªçŸ¥"
                ;;
            esac
            echo "| Unityæµ‹è¯• | $TEST_STATUS | $TEST_RESULT |" >> $GITHUB_STEP_SUMMARY
            
            # æ„å»ºæ‰§è¡Œ
            if [[ "${{ needs.parse_config.outputs.testsOnly }}" != "true" && "${{ inputs.enableBuildTest }}" == "true" ]]; then
              BUILD_STATUS="âŒ å¤±è´¥"
              BUILD_RESULT=""
              case "${{ needs.run_build.result }}" in
                "success")
                  BUILD_STATUS="âœ… æˆåŠŸ"
                  BUILD_RESULT="æ„å»ºå®Œæˆï¼Œç›®æ ‡: ${{ needs.parse_config.outputs.buildTargets }}"
                  ;;
                "failure")
                  BUILD_RESULT="æ„å»ºå¤±è´¥"
                  ;;
                "skipped")
                  BUILD_STATUS="â­ï¸ è·³è¿‡"
                  BUILD_RESULT="è·³è¿‡æ„å»º (æµ‹è¯•å¤±è´¥)"
                  ;;
                *)
                  BUILD_RESULT="æœªæ‰§è¡Œæˆ–çŠ¶æ€æœªçŸ¥"
                  ;;
              esac
              echo "| Unityæ„å»º | $BUILD_STATUS | $BUILD_RESULT |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ needs.parse_config.outputs.testsOnly }}" == "true" ]]; then
              echo "| Unityæ„å»º | â­ï¸ è·³è¿‡ | ä»…æµ‹è¯•æ¨¡å¼å·²å¯ç”¨ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "${{ inputs.enableBuildTest }}" != "true" ]]; then
              echo "| Unityæ„å»º | â­ï¸ è·³è¿‡ | æ„å»ºæµ‹è¯•å·²ç¦ç”¨ |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # é”™è¯¯è¯¦æƒ… (å¦‚æœæœ‰)
          if [[ "${{ needs.run_tests.result }}" == "failure" || "${{ needs.run_build.result }}" == "failure" ]]; then
            echo "## âŒ é”™è¯¯è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ needs.run_tests.result }}" == "failure" ]]; then
              echo "### ğŸ§ª æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              if [[ "${{ needs.run_tests.outputs.failedTestNames }}" != "" && "${{ needs.run_tests.outputs.failedTestNames }}" != "None" ]]; then
                echo "**å¤±è´¥çš„æµ‹è¯•:**" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                echo "${{ needs.run_tests.outputs.failedTestNames }}" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ needs.run_build.result }}" == "failure" ]]; then
              echo "### ğŸ—ï¸ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
              echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### ğŸ”§ æ•…éšœæ’é™¤å»ºè®®" >> $GITHUB_STEP_SUMMARY
            echo "1. æ£€æŸ¥Unityç‰ˆæœ¬æ˜¯å¦ä¸é¡¹ç›®å…¼å®¹" >> $GITHUB_STEP_SUMMARY
            echo "2. éªŒè¯Unityè®¸å¯è¯æ˜¯å¦æœ‰æ•ˆ" >> $GITHUB_STEP_SUMMARY
            echo "3. ç¡®è®¤æ„å»ºç›®æ ‡é…ç½®æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
            echo "4. æŸ¥çœ‹è¯¦ç»†çš„Actionsæ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # è°ƒè¯•ä¿¡æ¯ (ä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹)
          if [[ "${{ env.DEBUG_MODE }}" == "true" ]]; then
            echo "## ğŸ› è°ƒè¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ç¯å¢ƒå˜é‡" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "GITHUB_REF: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
            echo "GITHUB_SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "GITHUB_EVENT_NAME: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
            echo "GITHUB_ACTOR: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### é…ç½®è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "{" >> $GITHUB_STEP_SUMMARY
            echo "  \"projectName\": \"${{ needs.parse_config.outputs.projectName }}\"," >> $GITHUB_STEP_SUMMARY
            echo "  \"unityVersion\": \"${{ needs.parse_config.outputs.unityVersion }}\"," >> $GITHUB_STEP_SUMMARY
            echo "  \"buildType\": \"${{ needs.parse_config.outputs.buildType }}\"," >> $GITHUB_STEP_SUMMARY
            echo "  \"buildTargets\": ${{ needs.parse_config.outputs.buildTargets }}," >> $GITHUB_STEP_SUMMARY
            echo "  \"testsOnly\": ${{ needs.parse_config.outputs.testsOnly }}," >> $GITHUB_STEP_SUMMARY
            echo "  \"debugMode\": ${{ env.DEBUG_MODE }}" >> $GITHUB_STEP_SUMMARY
            echo "}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš¨ å¤±è´¥å¤„ç†å’Œé€šçŸ¥
        if: failure()
        run: |
          echo "ğŸ’¥ CIæµæ°´çº¿æ‰§è¡Œå¤±è´¥"
          echo "ğŸ“ å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— å·¥ä½œæµé“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # å¦‚æœå¯ç”¨äº†é”™è¯¯å¤„ç†é…ç½®ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘
          # ä¾‹å¦‚å‘é€åˆ°Slackã€Discordç­‰
          
          exit 1 