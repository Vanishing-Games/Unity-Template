name: ðŸš€ CIæµæ°´çº¿

on:
  push:
    branches:
      - develop

permissions:
  contents: write

jobs:
  unpack_inputs:
    name: è§£åŒ…è¾“å…¥å‚æ•°
    runs-on: ubuntu-latest
    outputs:
      projectName: ${{ steps.unpack.outputs.projectName }}
      skipTests: ${{ steps.unpack.outputs.skipTests }}
      testsOnly: ${{ steps.unpack.outputs.testsOnly }}
      buildType: ${{ steps.unpack.outputs.buildType }}
      buildVersion: ${{ steps.unpack.outputs.buildVersion }}
      retentionDays: ${{ steps.unpack.outputs.retentionDays }}
      requiresCombined: ${{ steps.unpack.outputs.requiresCombined }}
      skipPerBuildTarget: ${{ steps.unpack.outputs.skipPerBuildTarget }}
      unityVersion: ${{ steps.unpack.outputs.unityVersion }}
      useGitLfs: ${{ steps.unpack.outputs.useGitLfs }}
      editModePath: ${{ steps.unpack.outputs.editModePath }}
      playModePath: ${{ steps.unpack.outputs.playModePath }}
      timeoutMinutesTests: ${{ steps.unpack.outputs.timeoutMinutesTests }}
      timeoutMinutesBuild: ${{ steps.unpack.outputs.timeoutMinutesBuild }}
      quietMode: ${{ steps.unpack.outputs.quietMode }}
    steps:
      - name: æ£€å‡ºé…ç½®æ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/config/ci-defaults.json
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - id: unpack
        shell: bash
        run: |
          # è¯»å–è¾“å…¥å‚æ•°
          meta='${{ inputs.metadataConfig }}'
          artifact='${{ inputs.artifactConfig }}'
          testData='${{ inputs.testDataConfig }}'

          # å¦‚æžœå‚æ•°ä¸ºç©ºï¼Œåˆ™è¯»å–ci-defaults.json
          if [ -z "$meta" ] || [ "$meta" = "null" ] || [ "$meta" = "" ]; then
            meta=$(jq -c '.metadataConfig' .github/workflows/ci-defaults.json)
          fi
          if [ -z "$artifact" ] || [ "$artifact" = "null" ] || [ "$artifact" = "" ]; then
            artifact=$(jq -c '.artifactConfig' .github/workflows/ci-defaults.json)
          fi
          if [ -z "$testData" ] || [ "$testData" = "null" ] || [ "$testData" = "" ]; then
            testData=$(jq -c '.testDataConfig' .github/workflows/ci-defaults.json)
          fi

          # æµ‹è¯•æ•°æ®é…ç½®
          echo "unityVersion=$(echo "$testData" | jq -r .unityVersion)" >> "$GITHUB_OUTPUT"
          echo "useGitLfs=$(echo "$testData" | jq -r .useGitLfs)" >> "$GITHUB_OUTPUT"
          echo "editModePath=$(echo "$testData" | jq -r .editModePath)" >> "$GITHUB_OUTPUT"
          echo "playModePath=$(echo "$testData" | jq -r .playModePath)" >> "$GITHUB_OUTPUT"
          echo "quietMode=$(echo "$testData" | jq -r .quietMode)" >> "$GITHUB_OUTPUT"

          # å…ƒæ•°æ®é…ç½®
          echo "projectName=$(echo "$meta" | jq -r .projectName)" >> "$GITHUB_OUTPUT"
          echo "skipTests=$(echo "$meta" | jq -r .skipTests)" >> "$GITHUB_OUTPUT"
          echo "testsOnly=$(echo "$meta" | jq -r .testsOnly)" >> "$GITHUB_OUTPUT"
          echo "buildType=$(echo "$meta" | jq -r .buildType)" >> "$GITHUB_OUTPUT"
          echo "buildVersion=$(echo "$meta" | jq -r .buildVersion)" >> "$GITHUB_OUTPUT"
          echo "retentionDays=$(echo "$meta" | jq -r .retentionDays)" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesTests=$(echo "$meta" | jq -r .timeoutMinutesTests)" >> "$GITHUB_OUTPUT"
          echo "timeoutMinutesBuild=$(echo "$meta" | jq -r .timeoutMinutesBuild)" >> "$GITHUB_OUTPUT"

          # æž„å»ºäº§ç‰©é…ç½®
          echo "requiresCombined=$(echo "$artifact" | jq -r .requiresCombined)" >> "$GITHUB_OUTPUT"
          echo "skipPerBuildTarget=$(echo "$artifact" | jq -r .skipPerBuildTarget)" >> "$GITHUB_OUTPUT"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. è¿è¡Œæµ‹è¯•
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  run_tests:
    name: è¿è¡Œæµ‹è¯•
    if: ${{ needs.unpack_inputs.outputs.skipTests != 'true' }}
    needs: unpack_inputs
    uses: ./.github/workflows/step-1-test.yml
    with:
      unityVersion: ${{ needs.unpack_inputs.outputs.unityVersion }}
      useGitLfs: ${{ needs.unpack_inputs.outputs.useGitLfs }}
      editModePath: ${{ needs.unpack_inputs.outputs.editModePath }}
      playModePath: ${{ needs.unpack_inputs.outputs.playModePath }}
      timeoutMinutes: ${{ fromJson(needs.unpack_inputs.outputs.timeoutMinutesTests) }}
      quietMode: ${{ needs.unpack_inputs.outputs.quietMode }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. æž„å»º
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: æž„å»º
    needs: 
      - unpack_inputs
      - run_tests
    if: >
      always() &&
      (needs.run_tests.result == 'success' || needs.run_tests.result == 'skipped')
    uses: ./.github/workflows/step-2-build.yml
    with:
      projectName: ${{ needs.unpack_inputs.outputs.projectName }}
      unityVersion: ${{ needs.unpack_inputs.outputs.unityVersion }}
      buildVersion: ${{ needs.unpack_inputs.outputs.buildVersion }}
      buildType: ${{ needs.unpack_inputs.outputs.buildType }}
      buildTargets: ${{ inputs.buildTargets }}
      combineArtifacts: ${{ needs.unpack_inputs.outputs.requiresCombined }}
      timeoutMinutes: ${{ fromJson(needs.unpack_inputs.outputs.timeoutMinutesBuild) }}
      retentionDays: ${{ fromJson(needs.unpack_inputs.outputs.retentionDays) }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}