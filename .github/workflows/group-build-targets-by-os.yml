name: 📚 按操作系统分组构建目标

on:
  workflow_call:
    inputs:
      buildTargets:
        description: "要校验并按所需操作系统分组的构建目标 JSON 数组"
        required: true
        type: string
    outputs:
      validBuildTargets:
        description: "操作系统 runner 标签到构建目标列表的映射"
        value: ${{ jobs.filter_targets.outputs.validBuildTargets }}

jobs:
  filter_targets:
    name: 🧮 过滤目标
    runs-on: ubuntu-latest
    outputs:
      validBuildTargets: ${{ steps.group.outputs.validBuildTargets }}

    steps:
      - name: 📁 检出配置文件夹
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/config
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: 🔍 校验构建目标并加载配置
        id: validate
        run: |
          INPUT_JSON='${{ inputs.buildTargets }}'
          CONFIG_FILE=".github/config/build-targets.json"
          FALLBACK_URL="https://raw.githubusercontent.com/avalin/unity-ci-templates/main/.github/config/build-targets.json"

          echo "🔍 校验输入构建目标: $INPUT_JSON"

          if [ -f "$CONFIG_FILE" ]; then
            echo "✅ 使用配置: $CONFIG_FILE"
          else
            echo "⚠️ 未找到配置，正在下载备用配置..."
            mkdir -p "$(dirname "$CONFIG_FILE")"
            curl -sSL "$FALLBACK_URL" -o "$CONFIG_FILE"
          fi

          echo "$INPUT_JSON" | jq empty || {
            echo "❌ 输入不是有效的 JSON。"
            exit 1
          }

          KNOWN=$(jq -r 'keys[]' "$CONFIG_FILE")
          INPUTS=$(echo "$INPUT_JSON" | jq -r '.[]')
          VALID=()
          INVALID=()

          for TARGET in $INPUTS; do
            if echo "$KNOWN" | grep -qx "$TARGET"; then
              VALID+=("$TARGET")
            else
              INVALID+=("$TARGET")
            fi
          done

          if [ "${#INVALID[@]}" -gt 0 ]; then
            echo "⚠️ 未识别的目标（已忽略）："
            for p in "${INVALID[@]}"; do echo "  - $p"; done
          fi

          # 导出供后续步骤使用
          echo "VALID_TARGETS=${VALID[*]}" >> $GITHUB_ENV
          echo "INVALID_TARGETS=${INVALID[*]}" >> $GITHUB_ENV

          # 输出有效构建目标
          VALID_JSON=$(printf '%s\n' "${VALID[@]}" | jq -R . | jq -s .)
          echo "validBuildTargets<<EOF" >> $GITHUB_OUTPUT
          echo "$VALID_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 🧪 按操作系统分组有效目标
        id: group
        run: |
          CONFIG_FILE=".github/config/build-targets.json"
          TARGETS='${{ steps.validate.outputs.validBuildTargets }}'

          echo "📥 正在按操作系统分组目标..."

          jq -n \
            --argjson targets "$TARGETS" \
            --slurpfile cfg "$CONFIG_FILE" '
              $targets
              | map({ target: ., os: ($cfg[0][.]?.os) })
              | group_by(.os)
              | map({ (.[0].os): map(.target) })
              | add
            ' > grouped.json

          echo "📦 分组后的构建目标:"
          cat grouped.json

          echo "validBuildTargets<<EOF" >> $GITHUB_OUTPUT
          cat grouped.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 📋 构建目标校验汇总
        if: always()
        run: |
          INVALID_TARGETS="${INVALID_TARGETS:-}"
          GROUPED_FILE="grouped.json"

          echo ""
          echo "📋 构建目标校验汇总"
          echo "──────────────────────────────────────"

          if [ -f "$GROUPED_FILE" ]; then
            echo "🧮 按操作系统分组的构建目标"
            echo "────────────────────────────"

            jq -r '
              to_entries[] |
              "🖥️  \(.key):\n" +
              (.value | map("   • " + .) | join("\n"))
            ' "$GROUPED_FILE"
          else
            echo "⚠️ 未获取到分组后的构建目标数据。"
          fi

          if [ -n "$INVALID_TARGETS" ]; then
            echo "────────────────────────────"
            echo "⚠️ 无效的构建目标（已忽略）："
            for p in $INVALID_TARGETS; do echo "   • $p"; done
            echo "────────────────────────────"
          fi