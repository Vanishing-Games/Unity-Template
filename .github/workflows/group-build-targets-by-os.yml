name: 📚 按操作系统分组构建目标

on:
  workflow_call:
    inputs:
      buildTargets:
        description: "要校验并按所需操作系统分组的构建目标 JSON 数组"
        required: true
        type: string
    outputs:
      validBuildTargets:
        description: "操作系统 runner 标签到构建目标列表的映射"
        value: ${{ jobs.filter_targets.outputs.validBuildTargets }}

jobs:
  filter_targets:
    name: 🧮 过滤目标
    runs-on: ubuntu-latest
    outputs:
      validBuildTargets: ${{ steps.group.outputs.validBuildTargets }}

    steps:
      - name: 📁 检出配置文件夹
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/config
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: 🔍 校验构建目标并加载配置
        id: validate
        run: |
          # 处理输入的构建目标
          BUILD_TARGETS_INPUT='${{ inputs.buildTargets }}'
          echo "🔍 接收到的构建目标输入: $BUILD_TARGETS_INPUT"
          
          # 检查输入是否为空或null，如果是则使用默认配置文件
          if [[ -z "$BUILD_TARGETS_INPUT" || "$BUILD_TARGETS_INPUT" == "null" || "$BUILD_TARGETS_INPUT" == '""' ]]; then
            echo "⚠️ 输入为空，使用默认配置文件"
            if [ -f "./.github/config/build-targets-config.json" ]; then
              INPUT_JSON=$(cat ./.github/config/build-targets-config.json)
              echo "📄 从build-targets-config.json读取默认构建目标: $INPUT_JSON"
            else
              # 如果配置文件不存在，使用硬编码默认值
              INPUT_JSON='["StandaloneWindows64","StandaloneOSX"]'
              echo "⚠️ 未找到配置文件，使用硬编码默认值: $INPUT_JSON"
            fi
          # 检查输入格式并转换
          elif echo "$BUILD_TARGETS_INPUT" | jq empty 2>/dev/null && [[ "$BUILD_TARGETS_INPUT" != '""' && "$BUILD_TARGETS_INPUT" != "" ]]; then
            # 输入是有效的非空JSON
            INPUT_JSON="$BUILD_TARGETS_INPUT"
            echo "✅ 输入是有效的JSON数组"
          elif [[ "$BUILD_TARGETS_INPUT" == *","* ]]; then
            # 输入是逗号分隔的字符串，转换为JSON数组
            INPUT_JSON=$(echo "$BUILD_TARGETS_INPUT" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s .)
            echo "🔄 将逗号分隔的字符串转换为JSON数组: $INPUT_JSON"
          else
            # 单个构建目标，去除可能的引号和空格
            CLEAN_TARGET=$(echo "$BUILD_TARGETS_INPUT" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^"//;s/"$//')
            if [[ -n "$CLEAN_TARGET" ]]; then
              INPUT_JSON=$(jq -n --arg target "$CLEAN_TARGET" '[$target]')
              echo "🔄 将单个目标转换为JSON数组: $INPUT_JSON"
            else
              echo "⚠️ 处理后的目标为空，使用默认配置"
              if [ -f "./.github/config/build-targets-config.json" ]; then
                INPUT_JSON=$(cat ./.github/config/build-targets-config.json)
                echo "📄 从build-targets-config.json读取默认构建目标: $INPUT_JSON"
              else
                INPUT_JSON='["StandaloneWindows64","StandaloneOSX"]'
                echo "⚠️ 使用硬编码默认值: $INPUT_JSON"
              fi
            fi
          fi
          
          CONFIG_FILE="./.github/config/optional-build-targets.json"
          FALLBACK_URL="https://raw.githubusercontent.com/avalin/unity-ci-templates/main/.github/config/optional-build-targets.json"

          echo "🔍 最终处理的构建目标: $INPUT_JSON"

          if [ -f "$CONFIG_FILE" ]; then
            echo "✅ 使用配置: $CONFIG_FILE"
          else
            echo "⚠️ 未找到配置，正在下载备用配置..."
            mkdir -p "$(dirname "$CONFIG_FILE")"
            curl -sSL "$FALLBACK_URL" -o "$CONFIG_FILE"
          fi

          # 打印配置文件内容
          echo "📖 配置文件内容:"
          echo "────────────────────────────"
          cat "$CONFIG_FILE" | jq '.'
          echo "────────────────────────────"

          echo "$INPUT_JSON" | jq empty || {
            echo "❌ 输入不是有效的 JSON。"
            exit 1
          }

          KNOWN=$(jq -r 'keys[]' "$CONFIG_FILE")
          INPUTS=$(echo "$INPUT_JSON" | jq -r '.[]')
          VALID=()
          INVALID=()

          for TARGET in $INPUTS; do
            if echo "$KNOWN" | grep -qx "$TARGET"; then
              VALID+=("$TARGET")
            else
              INVALID+=("$TARGET")
            fi
          done

          if [ "${#INVALID[@]}" -gt 0 ]; then
            echo "⚠️ 未识别的目标（已忽略）："
            for p in "${INVALID[@]}"; do echo "  - $p"; done
          fi

          # 导出供后续步骤使用
          echo "VALID_TARGETS=${VALID[*]}" >> $GITHUB_ENV
          echo "INVALID_TARGETS=${INVALID[*]}" >> $GITHUB_ENV

          # 输出有效构建目标
          VALID_JSON=$(printf '%s\n' "${VALID[@]}" | jq -R . | jq -s .)
          echo "validBuildTargets<<EOF" >> $GITHUB_OUTPUT
          echo "$VALID_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # log
          echo "🧾 输出每个有效构建目标的配置详情："
          for TARGET in "${VALID[@]}"; do
            echo "────────────────────────────"
            echo "🔧 构建目标: $TARGET"
            jq -r --arg t "$TARGET" '.[$t]' "$CONFIG_FILE" | jq .
          done
          echo "────────────────────────────"

      - name: 🧪 按操作系统分组有效目标
        id: group
        run: |
          CONFIG_FILE=".github/config/optional-build-targets.json"
          TARGETS='${{ steps.validate.outputs.validBuildTargets }}'

          echo "📥 正在按操作系统分组目标..."

          jq -n \
            --argjson targets "$TARGETS" \
            --slurpfile cfg "$CONFIG_FILE" '
              $targets
              | map({ target: ., os: ($cfg[0][.]?.os) })
              | group_by(.os)
              | map({ (.[0].os): map(.target) })
              | add
            ' > grouped.json

          echo "📦 分组后的构建目标:"
          cat grouped.json

          echo "validBuildTargets<<EOF" >> $GITHUB_OUTPUT
          cat grouped.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 📋 构建目标校验汇总
        if: always()
        run: |
          INVALID_TARGETS="${INVALID_TARGETS:-}"
          GROUPED_FILE="grouped.json"

          echo ""
          echo "📋 构建目标校验汇总"
          echo "──────────────────────────────────────"

          if [ -f "$GROUPED_FILE" ]; then
            echo "🧮 按操作系统分组的构建目标"
            echo "────────────────────────────"

            jq -r '
              to_entries[] |
              "🖥️  \(.key):\n" +
              (.value | map("   • " + .) | join("\n"))
            ' "$GROUPED_FILE"
          else
            echo "⚠️ 未获取到分组后的构建目标数据。"
          fi

          if [ -n "$INVALID_TARGETS" ]; then
            echo "────────────────────────────"
            echo "⚠️ 无效的构建目标（已忽略）："
            for p in $INVALID_TARGETS; do echo "   • $p"; done
            echo "────────────────────────────"
          fi