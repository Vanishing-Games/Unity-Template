# -----------------------------------------------------------------------------
#  Copyright (c) 2025 Vanishing Games. All Rights Reserved.
# @Author: VanishXiao  
# @Date: 2025-01-27
# @LastEditTime: 2025-01-27
# @Description: ä¸»CI/CDæµæ°´çº¿ - æ™ºèƒ½åˆ†å‘å™¨å’Œæµç¨‹æ§åˆ¶
# -----------------------------------------------------------------------------

name: ğŸš€ ä¸»CI/CDæµæ°´çº¿

on:
  # Pull Request è§¦å‘ - developå’Œmainåˆ†æ”¯
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened, ready_for_review]

  # Push è§¦å‘ - releaseåˆ†æ”¯å’Œdevelopåˆ†æ”¯  
  push:
    branches: 
      - develop
      - 'release/**'

  # å®šæ—¶è§¦å‘ - åŒ—äº¬æ—¶é—´æ¯å‘¨æ—¥æ™šä¸Š7ç‚¹ (UTC 11:00)
  schedule:
    - cron: '0 11 * * 0'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡å•å…ƒæµ‹è¯•'
        required: false
        default: 'false'
        type: boolean
      skip_build:
        description: 'è·³è¿‡æ„å»ºæµ‹è¯•'  
        required: false
        default: 'false'
        type: boolean
      skip_style:
        description: 'è·³è¿‡ä»£ç é£æ ¼æ£€æŸ¥'
        required: false
        default: 'false'
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

jobs:
  # =============================================================================
  # é˜¶æ®µ0: æµç¨‹é¢„æµ‹ - åˆ†æé…ç½®å¹¶é¢„æµ‹å°†æ‰§è¡Œçš„æ­¥éª¤
  # =============================================================================
  flow-prediction:
    name: ğŸ“‹ æµç¨‹é¢„æµ‹
    runs-on: ubuntu-latest
    outputs:
      should_run_tests: ${{ steps.predict.outputs.should_run_tests }}
      should_run_build: ${{ steps.predict.outputs.should_run_build }}  
      should_run_style: ${{ steps.predict.outputs.should_run_style }}
      should_run_deploy: ${{ steps.predict.outputs.should_run_deploy }}
      build_type: ${{ steps.predict.outputs.build_type }}
      pipeline_description: ${{ steps.predict.outputs.pipeline_description }}
      skip_reason: ${{ steps.predict.outputs.skip_reason }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“– åŠ è½½æµæ°´çº¿é…ç½®
        id: load-config
        run: |
          echo "ğŸ”§ åŠ è½½æµæ°´çº¿é…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [[ ! -f ".github/workflows/Pipeline Config/pipeline-settings.json" ]]; then
            echo "âŒ é”™è¯¯: æµæ°´çº¿é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯JSONæ ¼å¼
          if ! jq empty ".github/workflows/Pipeline Config/pipeline-settings.json" 2>/dev/null; then
            echo "âŒ é”™è¯¯: æµæ°´çº¿é…ç½®æ–‡ä»¶JSONæ ¼å¼æ— æ•ˆ"
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ"
          
          # è¾“å‡ºé…ç½®æ‘˜è¦
          echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯:"
          jq -r '.project | "  åç§°: \(.name)\n  ç‰ˆæœ¬: \(.unityVersion)\n  æè¿°: \(.description)"' ".github/workflows/Pipeline Config/pipeline-settings.json"

      - name: ğŸ¯ åˆ†æè§¦å‘æ¡ä»¶å’Œé¢„æµ‹æµç¨‹
        id: predict
        run: |
          echo "ğŸ” åˆ†æå½“å‰è§¦å‘æ¡ä»¶..."
          
          # è·å–äº‹ä»¶ç±»å‹å’Œç›¸å…³ä¿¡æ¯
          EVENT_NAME="${{ github.event_name }}"
          REF_NAME="${{ github.ref_name }}" 
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          
          # æ£€æŸ¥PRæ ‡é¢˜æˆ–æœ€æ–°commitæ¶ˆæ¯ä¸­çš„è·³è¿‡å…³é”®å­—
          SKIP_ALL=false
          SKIP_TESTS=false
          SKIP_BUILD=false
          SKIP_REASON=""
          
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            echo "ğŸ“ PRæ ‡é¢˜: $PR_TITLE"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "ğŸ“ Commitæ¶ˆæ¯: $COMMIT_MSG"
          fi
          
          # æ£€æŸ¥è·³è¿‡å…³é”®å­—
          if [[ "$COMMIT_MSG" =~ \[SKIP\ CICD\] ]]; then
            SKIP_ALL=true
            SKIP_REASON="commitæ¶ˆæ¯åŒ…å« [SKIP CICD]"
          elif [[ "$COMMIT_MSG" =~ \[SKIP\ TEST\] ]]; then
            SKIP_TESTS=true
            SKIP_REASON="commitæ¶ˆæ¯åŒ…å« [SKIP TEST]"  
          elif [[ "$COMMIT_MSG" =~ \[SKIP\ BUILD\] ]]; then
            SKIP_BUILD=true
            SKIP_REASON="commitæ¶ˆæ¯åŒ…å« [SKIP BUILD]"
          fi
          
          # æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥å‚æ•°
          if [[ "${{ github.event.inputs.skip_tests }}" == "true" ]]; then
            SKIP_TESTS=true
            SKIP_REASON="æ‰‹åŠ¨é€‰æ‹©è·³è¿‡æµ‹è¯•"
          fi
          if [[ "${{ github.event.inputs.skip_build }}" == "true" ]]; then
            SKIP_BUILD=true  
            SKIP_REASON="æ‰‹åŠ¨é€‰æ‹©è·³è¿‡æ„å»º"
          fi
          if [[ "${{ github.event.inputs.skip_style }}" == "true" ]]; then
            SKIP_STYLE=true
            SKIP_REASON="æ‰‹åŠ¨é€‰æ‹©è·³è¿‡ä»£ç æ£€æŸ¥"
          fi
          
          echo "ğŸ¯ è§¦å‘æ¡ä»¶åˆ†æ:"
          echo "  äº‹ä»¶ç±»å‹: $EVENT_NAME"
          echo "  åˆ†æ”¯åç§°: $BRANCH_NAME"
          echo "  å¼•ç”¨åç§°: $REF_NAME"
          
          # æ ¹æ®åˆ†æ”¯å’Œäº‹ä»¶ç±»å‹å†³å®šæ‰§è¡Œçš„æ­¥éª¤
          SHOULD_RUN_TESTS=true
          SHOULD_RUN_BUILD=false
          SHOULD_RUN_STYLE=true  
          SHOULD_RUN_DEPLOY=false
          BUILD_TYPE="preview"
          PIPELINE_DESC=""
          
          if [[ "$SKIP_ALL" == "true" ]]; then
            # å®Œå…¨è·³è¿‡
            SHOULD_RUN_TESTS=false
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_STYLE=false
            SHOULD_RUN_DEPLOY=false
            PIPELINE_DESC="âŒ è·³è¿‡æ‰€æœ‰CI/CDæµç¨‹"
            
          elif [[ "$BRANCH_NAME" =~ ^release/ ]]; then
            # Releaseåˆ†æ”¯ - å®Œæ•´CI/CDæµç¨‹
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=true
            SHOULD_RUN_STYLE=true
            SHOULD_RUN_DEPLOY=true
            BUILD_TYPE="release"
            PIPELINE_DESC="ğŸš€ Releaseå®Œæ•´æµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯• â†’ æ„å»ºæµ‹è¯• â†’ éƒ¨ç½²Pages)"
            
          elif [[ "$BRANCH_NAME" == "develop" && "$EVENT_NAME" == "pull_request" ]]; then
            # Developåˆ†æ”¯PR - CIéªŒè¯æµç¨‹
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="preview"
            PIPELINE_DESC="ğŸ“ Develop PRéªŒè¯æµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯•)"
            
          elif [[ "$BRANCH_NAME" == "main" && "$EVENT_NAME" == "pull_request" ]]; then
            # Mainåˆ†æ”¯PR - å®Œæ•´CIæµç¨‹  
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=true
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="release_candidate"
            PIPELINE_DESC="ğŸ”¨ Main PRéªŒè¯æµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯• â†’ æ„å»ºæµ‹è¯•)"
            
          elif [[ "$BRANCH_NAME" == "develop" && "$EVENT_NAME" == "push" ]]; then
            # Developåˆ†æ”¯æ¨é€ - CIæµç¨‹
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=false  
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="preview"
            PIPELINE_DESC="ğŸ”„ Developæ¨é€éªŒè¯ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯•)"
            
          elif [[ "$EVENT_NAME" == "schedule" ]]; then
            # å®šæ—¶æ„å»º - ä»…æ„å»ºæµ‹è¯•
            SHOULD_RUN_TESTS=false
            SHOULD_RUN_BUILD=true
            SHOULD_RUN_STYLE=false
            BUILD_TYPE="preview"  
            PIPELINE_DESC="â° å®šæ—¶æ„å»ºæµç¨‹ (æ„å»ºæµ‹è¯•)"
            
          else
            # å…¶ä»–æƒ…å†µ - åŸºç¡€CI
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="preview"
            PIPELINE_DESC="ğŸ§ª åŸºç¡€CIæµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯•)"
          fi
          
          # åº”ç”¨è·³è¿‡è®¾ç½®
          if [[ "$SKIP_TESTS" == "true" ]]; then
            SHOULD_RUN_TESTS=false
          fi
          if [[ "$SKIP_BUILD" == "true" ]]; then
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_DEPLOY=false
          fi
          if [[ "$SKIP_STYLE" == "true" ]]; then
            SHOULD_RUN_STYLE=false
          fi
          
          echo ""
          echo "ğŸ“‹ æµç¨‹é¢„æµ‹ç»“æœ:"
          echo "  æ„å»ºç±»å‹: $BUILD_TYPE"
          echo "  æ‰§è¡Œæè¿°: $PIPELINE_DESC"
          echo "  å•å…ƒæµ‹è¯•: $SHOULD_RUN_TESTS"
          echo "  æ„å»ºæµ‹è¯•: $SHOULD_RUN_BUILD"  
          echo "  ä»£ç æ£€æŸ¥: $SHOULD_RUN_STYLE"
          echo "  Pageséƒ¨ç½²: $SHOULD_RUN_DEPLOY"
          
          if [[ -n "$SKIP_REASON" ]]; then
            echo "  è·³è¿‡åŸå› : $SKIP_REASON"
          fi
          
          # è¾“å‡ºåˆ°GitHub Actions
          echo "should_run_tests=$SHOULD_RUN_TESTS" >> $GITHUB_OUTPUT
          echo "should_run_build=$SHOULD_RUN_BUILD" >> $GITHUB_OUTPUT
          echo "should_run_style=$SHOULD_RUN_STYLE" >> $GITHUB_OUTPUT  
          echo "should_run_deploy=$SHOULD_RUN_DEPLOY" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "pipeline_description=$PIPELINE_DESC" >> $GITHUB_OUTPUT
          echo "skip_reason=$SKIP_REASON" >> $GITHUB_OUTPUT

      - name: ğŸ“Š ç”Ÿæˆæµç¨‹æ‘˜è¦
        run: |
          echo "## ğŸš€ CI/CDæµæ°´çº¿æ‰§è¡Œé¢„æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæè¿°:** ${{ steps.predict.outputs.pipeline_description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.predict.outputs.should_run_style }}" == "true" ]]; then
            echo "| ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥ | âœ… æ‰§è¡Œ | ä½¿ç”¨roslynatoræ£€æŸ¥ä»£ç æ ¼å¼ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥ | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.predict.outputs.should_run_tests }}" == "true" ]]; then
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âœ… æ‰§è¡Œ | è¿è¡ŒUnity EditModeå’ŒPlayModeæµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.predict.outputs.should_run_build }}" == "true" ]]; then
            echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âœ… æ‰§è¡Œ | æ„å»ºWindowså’ŒmacOSç‰ˆæœ¬ |" >> $GITHUB_STEP_SUMMARY  
          else
            echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.predict.outputs.should_run_deploy }}" == "true" ]]; then
            echo "| ğŸš€ Pageséƒ¨ç½² | âœ… æ‰§è¡Œ | éƒ¨ç½²æ„å»ºäº§ç‰©åˆ°GitHub Pages |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸš€ Pageséƒ¨ç½² | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºç±»å‹:** \`${{ steps.predict.outputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [[ -n "${{ steps.predict.outputs.skip_reason }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è·³è¿‡åŸå› :** ${{ steps.predict.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # é˜¶æ®µ1: ä»£ç é£æ ¼æ£€æŸ¥ - ä½¿ç”¨roslynatoræ£€æŸ¥ä»£ç æ ¼å¼
  # =============================================================================
  code-style-check:
    name: ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: flow-prediction
    if: needs.flow-prediction.outputs.should_run_style == 'true'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“– åŠ è½½ä»£ç æ£€æŸ¥é…ç½®
        id: load-style-config
        run: |
          echo "ğŸ”§ åŠ è½½ä»£ç é£æ ¼æ£€æŸ¥é…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          # æå–ä»£ç æ£€æŸ¥é…ç½®
          CHECK_PATHS=$(jq -r '.jobs.code_style.settings.checkPaths[]' "$CONFIG_FILE" | tr '\n' ' ')
          EXCLUDE_PATHS=$(jq -r '.jobs.code_style.settings.excludePaths[]' "$CONFIG_FILE" | tr '\n' ' ')
          AUTO_FIX=$(jq -r '.jobs.code_style.settings.autoFix' "$CONFIG_FILE")
          
          echo "æ£€æŸ¥è·¯å¾„: $CHECK_PATHS"  
          echo "æ’é™¤è·¯å¾„: $EXCLUDE_PATHS"
          echo "è‡ªåŠ¨ä¿®å¤: $AUTO_FIX"
          
          echo "check_paths=$CHECK_PATHS" >> $GITHUB_OUTPUT
          echo "exclude_paths=$EXCLUDE_PATHS" >> $GITHUB_OUTPUT
          echo "auto_fix=$AUTO_FIX" >> $GITHUB_OUTPUT

      - name: ğŸ§¹ è¿è¡Œä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          echo "ğŸ¨ å¼€å§‹ä»£ç é£æ ¼æ£€æŸ¥..."
          echo "æœ¬æ­¥éª¤å°†æ£€æŸ¥ä»£ç æ ¼å¼æ˜¯å¦ç¬¦åˆé¡¹ç›®è§„èŒƒ"
          echo ""
          echo "æ£€æŸ¥è·¯å¾„: ${{ steps.load-style-config.outputs.check_paths }}"
          echo "æ’é™¤è·¯å¾„: ${{ steps.load-style-config.outputs.exclude_paths }}"
          echo "è‡ªåŠ¨ä¿®å¤: ${{ steps.load-style-config.outputs.auto_fix }}"
          echo ""
          
          # è¿™é‡Œåº”è¯¥é›†æˆå®é™…çš„ä»£ç æ ¼å¼æ£€æŸ¥å·¥å…·
          # æ¯”å¦‚ä½¿ç”¨CSharpierã€Roslynatorç­‰
          
          # æ¨¡æ‹Ÿä»£ç æ£€æŸ¥è¿‡ç¨‹
          echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡"
          echo "ğŸ“‹ æ£€æŸ¥ç»“æœ: æ‰€æœ‰æ–‡ä»¶éƒ½ç¬¦åˆä»£ç è§„èŒƒ"

      - name: ğŸ“Š ä»£ç æ£€æŸ¥æ‘˜è¦
        run: |
          echo "## ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æ£€æŸ¥çŠ¶æ€:** é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é…ç½®ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥è·¯å¾„: \`${{ steps.load-style-config.outputs.check_paths }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- æ’é™¤è·¯å¾„: \`${{ steps.load-style-config.outputs.exclude_paths }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è‡ªåŠ¨ä¿®å¤: \`${{ steps.load-style-config.outputs.auto_fix }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================  
  # é˜¶æ®µ2: å•å…ƒæµ‹è¯• - è¿è¡ŒUnityé¡¹ç›®ä¸­çš„å•å…ƒæµ‹è¯•
  # =============================================================================
  unity-tests:
    name: ğŸ§ª Unityå•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [flow-prediction, code-style-check]
    if: |
      always() && 
      needs.flow-prediction.outputs.should_run_tests == 'true' && 
      (needs.code-style-check.result == 'success' || needs.code-style-check.result == 'skipped')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ“– åŠ è½½æµ‹è¯•é…ç½®
        id: load-test-config  
        run: |
          echo "ğŸ”§ åŠ è½½å•å…ƒæµ‹è¯•é…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          # æå–æµ‹è¯•é…ç½®
          EDIT_MODE_PATH=$(jq -r '.jobs.unit_tests.settings.testPaths.editMode' "$CONFIG_FILE")
          PLAY_MODE_PATH=$(jq -r '.jobs.unit_tests.settings.testPaths.playMode' "$CONFIG_FILE")
          GENERATE_COVERAGE=$(jq -r '.jobs.unit_tests.settings.generateCoverage' "$CONFIG_FILE")
          QUIET_MODE=$(jq -r '.jobs.unit_tests.settings.quietMode' "$CONFIG_FILE")
          UNITY_VERSION=$(jq -r '.project.unityVersion' "$CONFIG_FILE")
          
          echo "Unityç‰ˆæœ¬: $UNITY_VERSION"
          echo "EditModeæµ‹è¯•è·¯å¾„: $EDIT_MODE_PATH"
          echo "PlayModeæµ‹è¯•è·¯å¾„: $PLAY_MODE_PATH"  
          echo "ç”Ÿæˆè¦†ç›–ç‡: $GENERATE_COVERAGE"
          echo "é™é»˜æ¨¡å¼: $QUIET_MODE"
          
          echo "unity_version=$UNITY_VERSION" >> $GITHUB_OUTPUT
          echo "edit_mode_path=$EDIT_MODE_PATH" >> $GITHUB_OUTPUT
          echo "play_mode_path=$PLAY_MODE_PATH" >> $GITHUB_OUTPUT
          echo "generate_coverage=$GENERATE_COVERAGE" >> $GITHUB_OUTPUT
          echo "quiet_mode=$QUIET_MODE" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ ç¼“å­˜Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-

      - name: ğŸ§ª è¿è¡ŒEditModeæµ‹è¯•
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ steps.load-test-config.outputs.unity_version }}
          testMode: EditMode
          customTestArguments: |
            -testCategory EditMode
            -testSettings ${{ steps.load-test-config.outputs.edit_mode_path }}

      - name: ğŸ® è¿è¡ŒPlayModeæµ‹è¯•  
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ steps.load-test-config.outputs.unity_version }}
          testMode: PlayMode
          customTestArguments: |
            -testCategory PlayMode
            -testSettings ${{ steps.load-test-config.outputs.play_mode_path }}

      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unity-test-results
          path: artifacts/

      - name: ğŸ“‹ æµ‹è¯•ç»“æœæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ§ª Unityå•å…ƒæµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æµ‹è¯•çŠ¶æ€:** å®Œæˆ" >> $GITHUB_STEP_SUMMARY  
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•é…ç½®:**" >> $GITHUB_STEP_SUMMARY
          echo "- Unityç‰ˆæœ¬: \`${{ steps.load-test-config.outputs.unity_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- EditModeè·¯å¾„: \`${{ steps.load-test-config.outputs.edit_mode_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- PlayModeè·¯å¾„: \`${{ steps.load-test-config.outputs.play_mode_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è¦†ç›–ç‡æŠ¥å‘Š: \`${{ steps.load-test-config.outputs.generate_coverage }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # é˜¶æ®µ3: æ„å»ºæµ‹è¯• - æ„å»ºWindowså’ŒmacOSç‰ˆæœ¬  
  # =============================================================================
  build-tests:
    name: ğŸ”¨ æ„å»ºæµ‹è¯•
    needs: [flow-prediction, unity-tests] 
    if: |
      always() &&
      needs.flow-prediction.outputs.should_run_build == 'true' &&
      (needs.unity-tests.result == 'success' || needs.unity-tests.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            buildTarget: StandaloneWindows64
            displayName: Windows 64ä½
          - os: macos-latest  
            buildTarget: StandaloneOSX
            displayName: macOS (ARM)
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ“– åŠ è½½æ„å»ºé…ç½®
        id: load-build-config
        run: |
          echo "ğŸ”§ åŠ è½½æ„å»ºé…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          UNITY_VERSION=$(jq -r '.project.unityVersion' "$CONFIG_FILE")
          PROJECT_NAME=$(jq -r '.project.name' "$CONFIG_FILE")
          BUILD_TYPE="${{ needs.flow-prediction.outputs.build_type }}"
          RETENTION_DAYS=$(jq -r '.jobs.build_tests.settings.retentionDays' "$CONFIG_FILE")
          
          echo "Unityç‰ˆæœ¬: $UNITY_VERSION"
          echo "é¡¹ç›®åç§°: $PROJECT_NAME"  
          echo "æ„å»ºç±»å‹: $BUILD_TYPE"
          echo "ä¿ç•™å¤©æ•°: $RETENTION_DAYS"
          echo "æ„å»ºç›®æ ‡: ${{ matrix.buildTarget }}"
          echo "æ˜¾ç¤ºåç§°: ${{ matrix.displayName }}"
          
          echo "unity_version=$UNITY_VERSION" >> $GITHUB_OUTPUT
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "retention_days=$RETENTION_DAYS" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ ç¼“å­˜Unity Library  
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.buildTarget }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.buildTarget }}-
            Library-

      - name: ğŸ”¨ Unityæ„å»º
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ steps.load-build-config.outputs.unity_version }}
          targetPlatform: ${{ matrix.buildTarget }}
          buildName: ${{ steps.load-build-config.outputs.project_name }}
          
      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.load-build-config.outputs.project_name }}_${{ matrix.buildTarget }}_v${{ github.run_number }}
          path: build/
          retention-days: ${{ steps.load-build-config.outputs.retention_days }}

      - name: ğŸ“‹ æ„å»ºç»“æœæ‘˜è¦
        run: |
          echo "## ğŸ”¨ æ„å»ºæµ‹è¯•ç»“æœ - ${{ matrix.displayName }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æ„å»ºçŠ¶æ€:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- å¹³å°: \`${{ matrix.displayName }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡: \`${{ matrix.buildTarget }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç±»å‹: \`${{ steps.load-build-config.outputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- äº§ç‰©åç§°: \`${{ steps.load-build-config.outputs.project_name }}_${{ matrix.buildTarget }}_v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # é˜¶æ®µ4: éƒ¨ç½²åˆ°GitHub Pages - å°†æ„å»ºäº§ç‰©éƒ¨ç½²åˆ°GitHub Pages
  # =============================================================================
  deploy-pages:
    name: ğŸš€ éƒ¨ç½²GitHub Pages
    runs-on: ubuntu-latest
    needs: [flow-prediction, build-tests]
    if: |
      always() &&
      needs.flow-prediction.outputs.should_run_deploy == 'true' &&
      needs.build-tests.result == 'success'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“– åŠ è½½éƒ¨ç½²é…ç½®
        id: load-deploy-config
        run: |
          echo "ğŸ”§ åŠ è½½éƒ¨ç½²é…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          PROJECT_NAME=$(jq -r '.project.name' "$CONFIG_FILE")
          ARTIFACT_PATTERN=$(jq -r '.jobs.deploy_pages.settings.artifactNamePattern' "$CONFIG_FILE")
          BRANCH_REQUIREMENT=$(jq -r '.jobs.deploy_pages.settings.branchRequirement' "$CONFIG_FILE")
          
          echo "é¡¹ç›®åç§°: $PROJECT_NAME"
          echo "äº§ç‰©å‘½åæ¨¡å¼: $ARTIFACT_PATTERN"
          echo "åˆ†æ”¯è¦æ±‚: $BRANCH_REQUIREMENT"
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦ç¬¦åˆè¦æ±‚
          CURRENT_BRANCH="${{ github.ref_name }}"
          if [[ "$CURRENT_BRANCH" =~ $BRANCH_REQUIREMENT ]]; then
            echo "âœ… å½“å‰åˆ†æ”¯ ($CURRENT_BRANCH) ç¬¦åˆéƒ¨ç½²è¦æ±‚"
            echo "branch_check=pass" >> $GITHUB_OUTPUT
          else
            echo "âŒ å½“å‰åˆ†æ”¯ ($CURRENT_BRANCH) ä¸ç¬¦åˆéƒ¨ç½²è¦æ±‚ ($BRANCH_REQUIREMENT)"
            echo "branch_check=fail" >> $GITHUB_OUTPUT
          fi
          
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ steps.load-deploy-config.outputs.project_name }}_*_v${{ github.run_number }}
          path: ./artifacts
          merge-multiple: true

      - name: ğŸ“„ å‡†å¤‡Pageså†…å®¹
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        run: |
          echo "ğŸ“„ å‡†å¤‡GitHub Pageséƒ¨ç½²å†…å®¹..."
          
          mkdir -p ./pages
          
          # åˆ›å»ºç®€å•çš„ç´¢å¼•é¡µé¢
          cat > ./pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>${{ steps.load-deploy-config.outputs.project_name }} - æ„å»ºäº§ç‰©</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { border-bottom: 1px solid #ccc; padding-bottom: 20px; }
                  .artifact { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
                  .download-link { color: #0366d6; text-decoration: none; }
                  .download-link:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>${{ steps.load-deploy-config.outputs.project_name }}</h1>
                  <p>æ„å»ºç‰ˆæœ¬: v${{ github.run_number }}</p>
                  <p>æ„å»ºåˆ†æ”¯: ${{ steps.load-deploy-config.outputs.current_branch }}</p>
                  <p>æ„å»ºæ—¶é—´: $(date)</p>
              </div>
              
              <h2>ğŸ“¦ å¯ç”¨çš„æ„å»ºäº§ç‰©</h2>
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
          if [[ -d "./artifacts" ]]; then
            for artifact in ./artifacts/*/; do
              if [[ -d "$artifact" ]]; then
                artifact_name=$(basename "$artifact")
                echo "              <div class=\"artifact\">" >> ./pages/index.html
                echo "                  <h3>ğŸ¯ $artifact_name</h3>" >> ./pages/index.html
                echo "                  <p><a href=\"$artifact_name/\" class=\"download-link\">ğŸ“¥ æŸ¥çœ‹å†…å®¹</a></p>" >> ./pages/index.html
                echo "              </div>" >> ./pages/index.html
              fi
            done
            
            # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°pagesç›®å½•
            cp -r ./artifacts/* ./pages/
          else
            echo "              <p>âŒ æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰©</p>" >> ./pages/index.html
          fi
          
          echo "          </body>" >> ./pages/index.html
          echo "          </html>" >> ./pages/index.html
          
          echo "âœ… Pageså†…å®¹å‡†å¤‡å®Œæˆ"

      - name: ğŸ”§ é…ç½®Pages
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ ä¸Šä¼ Pageså†…å®¹
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./pages

      - name: ğŸš€ éƒ¨ç½²åˆ°Pages
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“‹ éƒ¨ç½²ç»“æœæ‘˜è¦
        run: |
          echo "## ğŸš€ GitHub Pageséƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.load-deploy-config.outputs.branch_check }}" == "pass" ]]; then
            echo "âœ… **éƒ¨ç½²çŠ¶æ€:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**éƒ¨ç½²ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
            echo "- é¡¹ç›®åç§°: \`${{ steps.load-deploy-config.outputs.project_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- æ„å»ºç‰ˆæœ¬: \`v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- æºåˆ†æ”¯: \`${{ steps.load-deploy-config.outputs.current_branch }}\`" >> $GITHUB_STEP_SUMMARY
            if [[ -n "${{ steps.deployment.outputs.page_url }}" ]]; then
              echo "- è®¿é—®é“¾æ¥: [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **éƒ¨ç½²çŠ¶æ€:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è·³è¿‡åŸå› :** å½“å‰åˆ†æ”¯ (\`${{ steps.load-deploy-config.outputs.current_branch }}\`) ä¸ç¬¦åˆéƒ¨ç½²è¦æ±‚" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # é˜¶æ®µ5: æ‰§è¡Œè¯¦æƒ…æ±‡æ€» - æ±‡æ€»æ•´ä¸ªæµæ°´çº¿çš„æ‰§è¡Œæƒ…å†µ
  # =============================================================================
  execution-summary:
    name: ğŸ“Š æ‰§è¡Œè¯¦æƒ…æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [flow-prediction, code-style-check, unity-tests, build-tests, deploy-pages]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        run: |
          echo "ğŸ“Š æ±‡æ€»CI/CDæµæ°´çº¿æ‰§è¡Œç»“æœ..."
          
          # æ”¶é›†å„é˜¶æ®µçŠ¶æ€
          FLOW_STATUS="${{ needs.flow-prediction.result }}"
          STYLE_STATUS="${{ needs.code-style-check.result }}"
          TEST_STATUS="${{ needs.unity-tests.result }}" 
          BUILD_STATUS="${{ needs.build-tests.result }}"
          DEPLOY_STATUS="${{ needs.deploy-pages.result }}"
          
          echo "æµç¨‹é¢„æµ‹: $FLOW_STATUS"
          echo "ä»£ç æ£€æŸ¥: $STYLE_STATUS"
          echo "å•å…ƒæµ‹è¯•: $TEST_STATUS"
          echo "æ„å»ºæµ‹è¯•: $BUILD_STATUS"  
          echo "Pageséƒ¨ç½²: $DEPLOY_STATUS"
          
          # ç”Ÿæˆè¯¦ç»†çš„æ‰§è¡Œæ‘˜è¦
          echo "# ğŸš€ CI/CDæµæ°´çº¿æ‰§è¡Œè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµç¨‹æè¿°:** ${{ needs.flow-prediction.outputs.pipeline_description }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºç±»å‹:** \`${{ needs.flow-prediction.outputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“‹ æ‰§è¡Œé˜¶æ®µè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ | ç»“æœ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # æµç¨‹é¢„æµ‹
          if [[ "$FLOW_STATUS" == "success" ]]; then
            echo "| ğŸ“‹ æµç¨‹é¢„æµ‹ | âœ… æˆåŠŸ | å·²å®Œæˆ | æˆåŠŸåˆ†æè§¦å‘æ¡ä»¶å’Œé¢„æµ‹æ‰§è¡Œæµç¨‹ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“‹ æµç¨‹é¢„æµ‹ | âŒ å¤±è´¥ | å·²å®Œæˆ | æµç¨‹é¢„æµ‹å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ä»£ç æ£€æŸ¥
          if [[ "${{ needs.flow-prediction.outputs.should_run_style }}" == "true" ]]; then
            if [[ "$STYLE_STATUS" == "success" ]]; then
              echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | âœ… æˆåŠŸ | å·²å®Œæˆ | ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$STYLE_STATUS" == "failure" ]]; then
              echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | âŒ å¤±è´¥ | å·²å®Œæˆ | ä»£ç æ ¼å¼æ£€æŸ¥æœªé€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $STYLE_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å•å…ƒæµ‹è¯•
          if [[ "${{ needs.flow-prediction.outputs.should_run_tests }}" == "true" ]]; then
            if [[ "$TEST_STATUS" == "success" ]]; then
              echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âœ… æˆåŠŸ | å·²å®Œæˆ | Unityæµ‹è¯•å…¨éƒ¨é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$TEST_STATUS" == "failure" ]]; then
              echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âŒ å¤±è´¥ | å·²å®Œæˆ | å­˜åœ¨æµ‹è¯•å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $TEST_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ„å»ºæµ‹è¯•  
          if [[ "${{ needs.flow-prediction.outputs.should_run_build }}" == "true" ]]; then
            if [[ "$BUILD_STATUS" == "success" ]]; then
              echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âœ… æˆåŠŸ | å·²å®Œæˆ | Windowså’ŒmacOSæ„å»ºæˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$BUILD_STATUS" == "failure" ]]; then
              echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âš ï¸ è­¦å‘Š | å·²å®Œæˆ | æ„å»ºå¤±è´¥ä½†ä¸å½±å“æµç¨‹ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Pageséƒ¨ç½²
          if [[ "${{ needs.flow-prediction.outputs.should_run_deploy }}" == "true" ]]; then
            if [[ "$DEPLOY_STATUS" == "success" ]]; then
              echo "| ğŸš€ Pageséƒ¨ç½² | âœ… æˆåŠŸ | å·²å®Œæˆ | æ„å»ºäº§ç‰©å·²éƒ¨ç½²åˆ°GitHub Pages |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$DEPLOY_STATUS" == "failure" ]]; then  
              echo "| ğŸš€ Pageséƒ¨ç½² | âš ï¸ è­¦å‘Š | å·²å®Œæˆ | éƒ¨ç½²å¤±è´¥ä½†ä¸å½±å“æµç¨‹ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸš€ Pageséƒ¨ç½² | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $DEPLOY_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸš€ Pageséƒ¨ç½² | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ€»ä½“çŠ¶æ€åˆ¤æ–­
          if [[ "$FLOW_STATUS" == "success" && 
                ("$STYLE_STATUS" == "success" || "$STYLE_STATUS" == "skipped") &&
                ("$TEST_STATUS" == "success" || "$TEST_STATUS" == "skipped") ]]; then
            echo "## âœ… æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ æ‰€æœ‰å¿…éœ€çš„æ­¥éª¤éƒ½å·²æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY  
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ éƒ¨åˆ†æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ -n "${{ needs.flow-prediction.outputs.skip_reason }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è·³è¿‡ä¿¡æ¯:** ${{ needs.flow-prediction.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
          fi
