# -----------------------------------------------------------------------------
#  Copyright (c) 2025 Vanishing Games. All Rights Reserved.
# @Author: VanishXiao  
# @Date: 2025-01-27
# @LastEditTime: 2025-01-27
# @Description: ä¸»CI/CDæµæ°´çº¿ - æ™ºèƒ½åˆ†å‘å™¨å’Œæµç¨‹æ§åˆ¶
# -----------------------------------------------------------------------------

name: ğŸš€ ä¸»CI/CDæµæ°´çº¿

on:
  # Pull Request è§¦å‘ - developå’Œmainåˆ†æ”¯
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened, ready_for_review]

  # Push è§¦å‘ - ä»…releaseåˆ†æ”¯å’Œdevelopåˆ†æ”¯çš„ç›´æ¥æ¨é€
  # æ³¨æ„ï¼šå½“åˆ›å»ºPRæ—¶ï¼Œä¸ä¼šè§¦å‘ç›®æ ‡åˆ†æ”¯çš„pushäº‹ä»¶ï¼Œåªä¼šè§¦å‘pull_requestäº‹ä»¶
  # æ’é™¤PRåˆ†æ”¯çš„æ¨é€ï¼Œé¿å…ä¸pull_requestäº‹ä»¶é‡å¤
  push:
    branches: 
      - develop
      - 'release/**'
    # æ’é™¤.githubç›®å½•çš„æ›´æ”¹ï¼Œé¿å…å·¥ä½œæµæ›´æ–°æ—¶çš„æ— æ„ä¹‰è§¦å‘
    paths-ignore:
      - '.github/workflows/**'
      - '.github/config/**'
      - '**.md'

  # å®šæ—¶è§¦å‘ - åŒ—äº¬æ—¶é—´æ¯å‘¨æ—¥æ™šä¸Š7ç‚¹ (UTC 11:00)
  schedule:
    - cron: '0 11 * * 0'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡å•å…ƒæµ‹è¯•'
        required: false
        default: false
        type: boolean
      skip_build:
        description: 'è·³è¿‡æ„å»ºæµ‹è¯•'  
        required: false
        default: false
        type: boolean
      skip_style:
        description: 'è·³è¿‡ä»£ç é£æ ¼æ£€æŸ¥'
        required: false
        default: false
        type: boolean

# æƒé™é…ç½®
permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

jobs:
  # =============================================================================
  # é˜¶æ®µ0: æµç¨‹é¢„æµ‹ - åˆ†æé…ç½®å¹¶é¢„æµ‹å°†æ‰§è¡Œçš„æ­¥éª¤
  # =============================================================================
  flow-prediction:
    name: ğŸ“‹ æµç¨‹é¢„æµ‹
    runs-on: ubuntu-latest
    outputs:
      should_run_tests: ${{ steps.predict.outputs.should_run_tests }}
      should_run_build: ${{ steps.predict.outputs.should_run_build }}  
      should_run_style: ${{ steps.predict.outputs.should_run_style }}
      should_run_deploy: ${{ steps.predict.outputs.should_run_deploy }}
      build_type: ${{ steps.predict.outputs.build_type }}
      pipeline_description: ${{ steps.predict.outputs.pipeline_description }}
      skip_reason: ${{ steps.predict.outputs.skip_reason }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“– åŠ è½½æµæ°´çº¿é…ç½®
        id: load-config
        run: |
          echo "ğŸ”§ åŠ è½½æµæ°´çº¿é…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [[ ! -f ".github/workflows/Pipeline Config/pipeline-settings.json" ]]; then
            echo "âŒ é”™è¯¯: æµæ°´çº¿é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯JSONæ ¼å¼
          if ! jq empty ".github/workflows/Pipeline Config/pipeline-settings.json" 2>/dev/null; then
            echo "âŒ é”™è¯¯: æµæ°´çº¿é…ç½®æ–‡ä»¶JSONæ ¼å¼æ— æ•ˆ"
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ"
          
          # è¾“å‡ºè¯¦ç»†é…ç½®æ‘˜è¦
          echo "ğŸ“‹ é¡¹ç›®ä¿¡æ¯:"
          jq -r '.project | "  åç§°: \(.name)\n  ç‰ˆæœ¬: \(.unityVersion)\n  æè¿°: \(.description)"' ".github/workflows/Pipeline Config/pipeline-settings.json"
          
          echo ""
          echo "ğŸ”§ æµæ°´çº¿ä½œä¸šé…ç½®:"
          jq -r '.jobs | to_entries[] | select(.key != "description") | "  \(.value.name): \(.value.description) (è¶…æ—¶: \(.value.timeout)åˆ†é’Ÿ, å¤±è´¥å¤„ç†: \(.value.failureAction))"' ".github/workflows/Pipeline Config/pipeline-settings.json"
          
          echo ""
          echo "ğŸ›ï¸ æ”¯æŒçš„PRå…³é”®å­—:"
          jq -r '.triggers.skipKeywords.keywords[] | "  \(.keyword): \(.description)"' ".github/workflows/Pipeline Config/pipeline-settings.json"
          
          echo ""
          echo "ğŸ”‘ å¿…éœ€çš„Secrets:"
          jq -r '.requirements.secrets.required[] | "  \(.name): \(.description)"' ".github/workflows/Pipeline Config/pipeline-settings.json"

      - name: ğŸ¯ åˆ†æè§¦å‘æ¡ä»¶å’Œé¢„æµ‹æµç¨‹
        id: predict
        run: |
          echo "ğŸ” åˆ†æå½“å‰è§¦å‘æ¡ä»¶..."
          
          # è·å–äº‹ä»¶ç±»å‹å’Œç›¸å…³ä¿¡æ¯
          EVENT_NAME="${{ github.event_name }}"
          REF_NAME="${{ github.ref_name }}" 
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤è§¦å‘ï¼ˆåŒæ—¶æœ‰PRå’Œpushäº‹ä»¶ï¼‰
          if [[ "$EVENT_NAME" == "push" && "$REF_NAME" == "develop" ]]; then
            # æ£€æŸ¥å½“å‰commitæ˜¯å¦æœ‰å…³è”çš„å¼€æ”¾PR
            echo "ğŸ” æ£€æŸ¥æ˜¯å¦å­˜åœ¨é‡å¤çš„PRè§¦å‘..."
            # å¦‚æœæ˜¯pushåˆ°developä¸”å¯èƒ½æœ‰PRæ‰“å¼€ï¼Œæˆ‘ä»¬ä¼˜å…ˆè®©PRäº‹ä»¶å¤„ç†
            echo "âš ï¸ è¿™æ˜¯developåˆ†æ”¯çš„pushäº‹ä»¶ï¼Œå¯èƒ½ä¸PRäº‹ä»¶é‡å¤"
            echo "ğŸ’¡ å»ºè®®ï¼šå¦‚æœæœ‰æ´»è·ƒçš„PRï¼Œä¼˜å…ˆä½¿ç”¨PRäº‹ä»¶çš„å·¥ä½œæµ"
          fi
          
          # æ£€æŸ¥PRæ ‡é¢˜æˆ–æœ€æ–°commitæ¶ˆæ¯ä¸­çš„æ§åˆ¶å…³é”®å­—
          SKIP_ALL=false
          SKIP_TESTS=false
          SKIP_BUILD=false
          SKIP_FORMAT=false
          ADD_TESTS=false
          ADD_BUILD=false
          ADD_DEPLOY=false
          SKIP_REASON=""
          
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            echo "ğŸ“ PRæ ‡é¢˜: $PR_TITLE"
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "ğŸ“ Commitæ¶ˆæ¯: $COMMIT_MSG"
          fi
          
          # æ£€æŸ¥è·³è¿‡å…³é”®å­—
          if [[ "$COMMIT_MSG" =~ \[SKIP\ CICD\] ]]; then
            SKIP_ALL=true
            SKIP_REASON="PRæ ‡é¢˜/commitæ¶ˆæ¯åŒ…å« [SKIP CICD]"
          elif [[ "$COMMIT_MSG" =~ \[SKIP\ FORMAT\] ]]; then
            SKIP_FORMAT=true
            SKIP_REASON="PRæ ‡é¢˜/commitæ¶ˆæ¯åŒ…å« [SKIP FORMAT]"
          elif [[ "$COMMIT_MSG" =~ \[SKIP\ TEST\] ]]; then
            SKIP_TESTS=true
            SKIP_REASON="PRæ ‡é¢˜/commitæ¶ˆæ¯åŒ…å« [SKIP TEST]"  
          elif [[ "$COMMIT_MSG" =~ \[SKIP\ BUILD\] ]]; then
            SKIP_BUILD=true
            SKIP_REASON="PRæ ‡é¢˜/commitæ¶ˆæ¯åŒ…å« [SKIP BUILD]"
          fi
          
          # æ£€æŸ¥å¢åŠ å…³é”®å­—
          if [[ "$COMMIT_MSG" =~ \[ADD\ TEST\] ]]; then
            ADD_TESTS=true
            echo "ğŸ” æ£€æµ‹åˆ° [ADD TEST] å…³é”®å­—"
          fi
          if [[ "$COMMIT_MSG" =~ \[ADD\ BUILD\] ]]; then
            ADD_BUILD=true
            echo "ğŸ” æ£€æµ‹åˆ° [ADD BUILD] å…³é”®å­—"
          fi
          if [[ "$COMMIT_MSG" =~ \[ADD\ DEPLOY\] ]]; then
            ADD_DEPLOY=true
            echo "ğŸ” æ£€æµ‹åˆ° [ADD DEPLOY] å…³é”®å­—"
          fi
          
          # æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥å‚æ•°
          if [[ "${{ github.event.inputs.skip_tests }}" == "true" ]]; then
            SKIP_TESTS=true
            SKIP_REASON="æ‰‹åŠ¨é€‰æ‹©è·³è¿‡æµ‹è¯•"
          fi
          if [[ "${{ github.event.inputs.skip_build }}" == "true" ]]; then
            SKIP_BUILD=true  
            SKIP_REASON="æ‰‹åŠ¨é€‰æ‹©è·³è¿‡æ„å»º"
          fi
          if [[ "${{ github.event.inputs.skip_style }}" == "true" ]]; then
            SKIP_STYLE=true
            SKIP_REASON="æ‰‹åŠ¨é€‰æ‹©è·³è¿‡ä»£ç æ£€æŸ¥"
          fi
          
          echo "ğŸ¯ è§¦å‘æ¡ä»¶åˆ†æ:"
          echo "  äº‹ä»¶ç±»å‹: $EVENT_NAME"
          echo "  åˆ†æ”¯åç§°: $BRANCH_NAME"
          echo "  å¼•ç”¨åç§°: $REF_NAME"
          
          # æ ¹æ®åˆ†æ”¯å’Œäº‹ä»¶ç±»å‹å†³å®šæ‰§è¡Œçš„æ­¥éª¤
          SHOULD_RUN_TESTS=true
          SHOULD_RUN_BUILD=false
          SHOULD_RUN_STYLE=true  
          SHOULD_RUN_DEPLOY=false
          BUILD_TYPE="preview"
          PIPELINE_DESC=""
          
          if [[ "$SKIP_ALL" == "true" ]]; then
            # å®Œå…¨è·³è¿‡
            SHOULD_RUN_TESTS=false
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_STYLE=false
            SHOULD_RUN_DEPLOY=false
            PIPELINE_DESC="âŒ è·³è¿‡æ‰€æœ‰CI/CDæµç¨‹"
            
          elif [[ "$BRANCH_NAME" =~ ^release/ ]]; then
            # Releaseåˆ†æ”¯ - å®Œæ•´CI/CDæµç¨‹
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=true
            SHOULD_RUN_STYLE=true
            SHOULD_RUN_DEPLOY=true
            BUILD_TYPE="release"
            PIPELINE_DESC="ğŸš€ Releaseå®Œæ•´æµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯• â†’ æ„å»ºæµ‹è¯• â†’ éƒ¨ç½²Pages)"
            
          elif [[ "$BRANCH_NAME" == "develop" && "$EVENT_NAME" == "pull_request" ]]; then
            # Developåˆ†æ”¯PR - CIéªŒè¯æµç¨‹
            echo "ğŸ” æ£€æµ‹åˆ° develop åˆ†æ”¯ PRï¼Œåº”ç”¨é»˜è®¤é…ç½®"
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="preview"
            PIPELINE_DESC="ğŸ“ Develop PRéªŒè¯æµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯•)"
            
          elif [[ "$BRANCH_NAME" == "main" && "$EVENT_NAME" == "pull_request" ]]; then
            # Mainåˆ†æ”¯PR - å®Œæ•´CIæµç¨‹  
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=true
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="release_candidate"
            PIPELINE_DESC="ğŸ”¨ Main PRéªŒè¯æµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯• â†’ æ„å»ºæµ‹è¯•)"
            
          elif [[ "$BRANCH_NAME" == "develop" && "$EVENT_NAME" == "push" ]]; then
            # Developåˆ†æ”¯æ¨é€ - CIæµç¨‹
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=false  
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="preview"
            PIPELINE_DESC="ğŸ”„ Developåˆ†æ”¯çŠ¶æ€éªŒè¯ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯•)"
            
          elif [[ "$EVENT_NAME" == "schedule" ]]; then
            # å®šæ—¶æ„å»º - ä»…æ„å»ºæµ‹è¯•
            SHOULD_RUN_TESTS=false
            SHOULD_RUN_BUILD=true
            SHOULD_RUN_STYLE=false
            BUILD_TYPE="preview"  
            PIPELINE_DESC="â° å®šæ—¶æ„å»ºæµç¨‹ (æ„å»ºæµ‹è¯•)"
            
          else
            # å…¶ä»–æƒ…å†µ - åŸºç¡€CI
            SHOULD_RUN_TESTS=true
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_STYLE=true
            BUILD_TYPE="preview"
            PIPELINE_DESC="ğŸ§ª åŸºç¡€CIæµç¨‹ (ä»£ç æ£€æµ‹ â†’ å•å…ƒæµ‹è¯•)"
          fi
          
          # åº”ç”¨è·³è¿‡è®¾ç½®
          if [[ "$SKIP_TESTS" == "true" ]]; then
            SHOULD_RUN_TESTS=false
          fi
          if [[ "$SKIP_BUILD" == "true" ]]; then
            SHOULD_RUN_BUILD=false
            SHOULD_RUN_DEPLOY=false
          fi
          if [[ "$SKIP_FORMAT" == "true" ]]; then
            SHOULD_RUN_STYLE=false
          fi
          if [[ "$SKIP_STYLE" == "true" ]]; then
            SHOULD_RUN_STYLE=false
          fi
          
          # åº”ç”¨å¢åŠ è®¾ç½®
          ADD_REASONS=""
          if [[ "$ADD_TESTS" == "true" ]]; then
            SHOULD_RUN_TESTS=true
            echo "âœ… åº”ç”¨ [ADD TEST]ï¼šå¯ç”¨å•å…ƒæµ‹è¯•"
            ADD_REASONS="${ADD_REASONS}[ADD TEST] "
          fi
          if [[ "$ADD_BUILD" == "true" ]]; then
            SHOULD_RUN_BUILD=true
            echo "âœ… åº”ç”¨ [ADD BUILD]ï¼šå¯ç”¨æ„å»ºæµ‹è¯•"
            ADD_REASONS="${ADD_REASONS}[ADD BUILD] "
          fi
          if [[ "$ADD_DEPLOY" == "true" ]]; then
            SHOULD_RUN_DEPLOY=true
            echo "âœ… åº”ç”¨ [ADD DEPLOY]ï¼šå¯ç”¨éƒ¨ç½²"
            ADD_REASONS="${ADD_REASONS}[ADD DEPLOY] "
            # å¦‚æœè¦éƒ¨ç½²ä½†æ²¡æœ‰æ„å»ºï¼Œè‡ªåŠ¨å¯ç”¨æ„å»º
            if [[ "$SHOULD_RUN_BUILD" == "false" ]]; then
              SHOULD_RUN_BUILD=true
              echo "âœ… è‡ªåŠ¨å¯ç”¨æ„å»ºï¼ˆéƒ¨ç½²éœ€è¦æ„å»ºäº§ç‰©ï¼‰"
            fi
          fi
          
          # æ›´æ–°è·³è¿‡/å¢åŠ åŸå› 
          if [[ -n "$ADD_REASONS" ]]; then
            if [[ -z "$SKIP_REASON" ]]; then
              SKIP_REASON="PRæ ‡é¢˜åŒ…å«å¢å¼ºå…³é”®å­—: $ADD_REASONS"
            else
              SKIP_REASON="${SKIP_REASON}; åŒæ—¶åŒ…å«å¢å¼ºå…³é”®å­—: $ADD_REASONS"
            fi
          fi
          
          echo ""
          echo "ğŸ”§ å…³é”®å­—çŠ¶æ€:"
          echo "  ADD_TESTS: $ADD_TESTS"
          echo "  ADD_BUILD: $ADD_BUILD"
          echo "  ADD_DEPLOY: $ADD_DEPLOY"
          echo "  SKIP_TESTS: $SKIP_TESTS"
          echo "  SKIP_BUILD: $SKIP_BUILD"
          echo "  SKIP_FORMAT: $SKIP_FORMAT"
          echo ""
          echo "ğŸ“‹ æµç¨‹é¢„æµ‹ç»“æœ:"
          echo "  æ„å»ºç±»å‹: $BUILD_TYPE"
          echo "  æ‰§è¡Œæè¿°: $PIPELINE_DESC"
          echo "  å•å…ƒæµ‹è¯•: $SHOULD_RUN_TESTS"
          echo "  æ„å»ºæµ‹è¯•: $SHOULD_RUN_BUILD"  
          echo "  ä»£ç æ£€æŸ¥: $SHOULD_RUN_STYLE"
          echo "  Pageséƒ¨ç½²: $SHOULD_RUN_DEPLOY"
          
          if [[ -n "$SKIP_REASON" ]]; then
            echo "  è·³è¿‡åŸå› : $SKIP_REASON"
          fi
          
          # è¾“å‡ºåˆ°GitHub Actions
          echo "should_run_tests=$SHOULD_RUN_TESTS" >> $GITHUB_OUTPUT
          echo "should_run_build=$SHOULD_RUN_BUILD" >> $GITHUB_OUTPUT
          echo "should_run_style=$SHOULD_RUN_STYLE" >> $GITHUB_OUTPUT  
          echo "should_run_deploy=$SHOULD_RUN_DEPLOY" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "pipeline_description=$PIPELINE_DESC" >> $GITHUB_OUTPUT
          echo "skip_reason=$SKIP_REASON" >> $GITHUB_OUTPUT

      - name: ğŸ“Š ç”Ÿæˆæµç¨‹æ‘˜è¦
        run: |
          echo "## ğŸš€ CI/CDæµæ°´çº¿æ‰§è¡Œé¢„æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘äº‹ä»¶:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæè¿°:** ${{ steps.predict.outputs.pipeline_description }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºç±»å‹:** \`${{ steps.predict.outputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ å½“å‰é…ç½®ä¿¡æ¯
          echo "### âš™ï¸ å½“å‰æµæ°´çº¿é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é¡¹ç›®ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          jq -r '.project | "| åç§° | \(.name) |\n| Unityç‰ˆæœ¬ | \(.unityVersion) |\n| æè¿° | \(.description) |"' ".github/workflows/Pipeline Config/pipeline-settings.json" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä½œä¸šé…ç½®:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä½œä¸šåç§° | æè¿° | è¶…æ—¶æ—¶é—´ | å¤±è´¥å¤„ç† |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          jq -r '.jobs | to_entries[] | select(.key != "description") | "| \(.value.name) | \(.value.description) | \(.value.timeout)åˆ†é’Ÿ | \(.value.failureAction) |"' ".github/workflows/Pipeline Config/pipeline-settings.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**æ”¯æŒçš„å…³é”®å­—:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å…³é”®å­— | æè¿° |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          jq -r '.triggers.skipKeywords.keywords[] | "| \(.keyword) | \(.description) |"' ".github/workflows/Pipeline Config/pipeline-settings.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‹ æ‰§è¡Œé˜¶æ®µé¢„æµ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.predict.outputs.should_run_style }}" == "true" ]]; then
            echo "| ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥ | âœ… æ‰§è¡Œ | ä½¿ç”¨CSharpieræ£€æŸ¥ä»£ç æ ¼å¼ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥ | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.predict.outputs.should_run_tests }}" == "true" ]]; then
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âœ… æ‰§è¡Œ | è¿è¡ŒUnity EditModeå’ŒPlayModeæµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.predict.outputs.should_run_build }}" == "true" ]]; then
            echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âœ… æ‰§è¡Œ | æ„å»ºWindowså’ŒmacOSç‰ˆæœ¬ |" >> $GITHUB_STEP_SUMMARY  
          else
            echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.predict.outputs.should_run_deploy }}" == "true" ]]; then
            echo "| ğŸš€ Pageséƒ¨ç½² | âœ… æ‰§è¡Œ | éƒ¨ç½²æ„å»ºäº§ç‰©åˆ°GitHub Pages |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸš€ Pageséƒ¨ç½² | â­ï¸ è·³è¿‡ | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -n "${{ steps.predict.outputs.skip_reason }}" ]]; then
            echo "**è·³è¿‡åŸå› :** ${{ steps.predict.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # é˜¶æ®µ1: ä»£ç é£æ ¼æ£€æŸ¥ - ä½¿ç”¨CSharpieræ£€æŸ¥ä»£ç æ ¼å¼
  # =============================================================================
  code-style-check:
    name: ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: flow-prediction
    if: needs.flow-prediction.outputs.should_run_style == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0 # å¿…é¡»ä¸º 0 ä»¥è¿›è¡Œ git diff

      - name: âš™ï¸ å®‰è£… CSharpier
        run: |
          echo "â¬‡ï¸ å®‰è£… .NET Tool: CSharpier..."
          dotnet tool install -g csharpier

      - name: ğŸ“– åŠ è½½ä¸è§£æé…ç½®
        id: config
        run: |
          echo "ğŸ”§ è¯»å– Pipeline é…ç½®..."
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          CHECK_PATHS=$(jq -r '.jobs.code_style.settings.checkPaths[]' "$CONFIG_FILE" | tr '\n' ' ')
          AUTO_FIX=$(jq -r '.jobs.code_style.settings.autoFix' "$CONFIG_FILE")
          
          if [ -z "$CHECK_PATHS" ]; then CHECK_PATHS="."; fi
          
          echo "ğŸ“‚ åŒ…å«è·¯å¾„: $CHECK_PATHS"
          
          echo "check_paths=$CHECK_PATHS" >> $GITHUB_OUTPUT
          echo "auto_fix=$AUTO_FIX" >> $GITHUB_OUTPUT

      - name: ğŸ§¹ æ‰§è¡Œå¢é‡ä»£ç æ£€æŸ¥
        id: run_check
        env:
          CHECK_PATHS: ${{ steps.config.outputs.check_paths }}
        run: |
          echo "ğŸ¨ å‡†å¤‡è®¡ç®—å˜æ›´æ–‡ä»¶..."
          
          BASE_REF="origin/${{ github.base_ref || 'main' }}"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_REF="HEAD^"
          fi
          echo "ğŸ” å¯¹æ¯”åŸºå‡†: $BASE_REF"

          echo "ğŸ” æ£€ç´¢è·¯å¾„èŒƒå›´: $CHECK_PATHS"
          
          # 1. è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          FINAL_FILES=$(git diff --name-only --diff-filter=ACMR $BASE_REF HEAD -- $CHECK_PATHS | grep '\.cs$' | tr '\n' ' ' || true)
          
          TRIMMED_FILES=$(echo "$FINAL_FILES" | xargs)
          
          if [ -z "$TRIMMED_FILES" ]; then
            echo "âœ… åœ¨æŒ‡å®šè·¯å¾„ä¸‹æ—  .cs æ–‡ä»¶å˜æ›´ã€‚"
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "files_count=0" >> $GITHUB_OUTPUT
            echo "failed_files=''" >> $GITHUB_OUTPUT 
            exit 0
          fi
          
          COUNT=$(echo $TRIMMED_FILES | wc -w)
          echo "ğŸ“ å³å°†æ£€æŸ¥ $COUNT ä¸ªæ–‡ä»¶..."
          echo "files_count=$COUNT" >> $GITHUB_OUTPUT

          echo "ğŸš€ è¿è¡Œ CSharpier..."
          
          # 2. æ ¸å¿ƒæ”¹è¿›ï¼šæ‰§è¡Œæ£€æŸ¥å¹¶æ•è·è¾“å‡º
          set +e
          # æ•è·æ‰€æœ‰è¾“å‡ºï¼ŒåŒ…æ‹¬æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
          CSHARPIER_OUTPUT=$(dotnet csharpier --check $FINAL_FILES 2>&1)
          EXIT_CODE=$?
          set -e
          
          # æ‰“å° CSharpier åŸå§‹è¾“å‡ºï¼Œå¸®åŠ©è°ƒè¯•
          echo "--- CSharpier åŸå§‹è¾“å‡º ---"
          echo "$CSHARPIER_OUTPUT"
          echo "-------------------------"
          
          # 3. è§£æè¾“å‡ºä»¥æ‰¾åˆ°å¤±è´¥æ–‡ä»¶
          # ç­–ç•¥ï¼šå¦‚æœ EXIT_CODE != 0ï¼Œåˆ™æ„å‘³ç€å¤±è´¥ã€‚
          # å¤±è´¥çš„è¡Œé€šå¸¸åŒ…å«æ–‡ä»¶è·¯å¾„ã€‚ç”±äºä¸Šä¸€æ¬¡çš„è§£æå¤±è´¥ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨æ›´ç®€å•çš„åŒ¹é…ï¼Œ
          # åªè¦æ±‚åŒ…å« ".cs" ä¸”ä¸åŒ…å«è€—æ—¶/æˆåŠŸä¿¡æ¯ã€‚
          
          # æŸ¥æ‰¾åŒ…å« ".cs" ä¸”ä¸åŒ…å« "[info]"ã€"ms" ç­‰æ—¥å¿—å…³é”®è¯çš„è¡Œ
          FAILED_FILES_RAW=$(echo "$CSHARPIER_OUTPUT" | grep -E '\.cs' | grep -v 'ms' | grep -v 'Formatting finished')
          
          # 4. æ ¼å¼åŒ–å¤±è´¥æ–‡ä»¶åˆ—è¡¨ä¸º Markdown åˆ—è¡¨
          FAILED_FILES_LIST=""
          if [ -n "$FAILED_FILES_RAW" ]; then
              # ä½¿ç”¨ while å¾ªç¯é€è¡Œå¤„ç†ï¼Œç¡®ä¿æ¯ä¸€è¡Œéƒ½è¢«æ­£ç¡®æ•è·
              while IFS= read -r line; do
                  # ç§»é™¤å‰åçš„ç©ºæ ¼å’Œæ½œåœ¨çš„æ—¥å¿—å‰ç¼€
                  CLEAN_LINE=$(echo "$line" | sed 's/^.*[a-zA-Z] \+\(.*\)/\1/' | xargs)
                  
                  if [ -n "$CLEAN_LINE" ]; then
                    FAILED_FILES_LIST+="- \`$CLEAN_LINE\`"$'\n'
                  fi
              done <<< "$FAILED_FILES_RAW"
          fi

          # 5. æ ¹æ®é€€å‡ºç è®¾ç½®æœ€ç»ˆçŠ¶æ€
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… æ£€æŸ¥é€šè¿‡ï¼"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "failed_files=''" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ£€æŸ¥å¤±è´¥ï¼å­˜åœ¨æ ¼å¼é—®é¢˜ã€‚"
            echo "status=failure" >> $GITHUB_OUTPUT
            
            # æ£€æŸ¥è§£æç»“æœæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if [ -z "$FAILED_FILES_LIST" ]; then
                # å¤‡ç”¨ï¼šå¦‚æœè§£æå¤±è´¥ï¼Œä½†æˆ‘ä»¬çŸ¥é“ EXIT_CODE != 0ï¼Œåˆ™å‡å®šæ‰€æœ‰æ£€æŸ¥çš„æ–‡ä»¶éƒ½æœ‰é—®é¢˜
                echo "âš ï¸ è­¦å‘Šï¼šæœªèƒ½è§£æå…·ä½“å¤±è´¥æ–‡ä»¶ï¼Œå¯èƒ½ CSharpier è¾“å‡ºæ ¼å¼å·²æ›´æ”¹ã€‚"
            fi

            # ä½¿ç”¨ base64 ç¼–ç æ¥å®‰å…¨åœ°ä¼ é€’å¤šè¡Œæ•°æ®
            ENCODED_FAILED_FILES=$(echo "$FAILED_FILES_LIST" | base64 -w 0)
            echo "failed_files=$ENCODED_FAILED_FILES" >> $GITHUB_OUTPUT
          fi
          
          # å¦‚æœå¤±è´¥ï¼Œåˆ™å¼ºåˆ¶ Action å¤±è´¥
          if [ $EXIT_CODE -ne 0 ]; then
              exit 1
          fi

      - name: ğŸ“Š ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
        if: always() 
        run: |
          STATUS="${{ steps.run_check.outputs.status }}"
          COUNT="${{ steps.run_check.outputs.files_count }}"
          ENCODED_FAILED_FILES="${{ steps.run_check.outputs.failed_files }}"
          
          # è§£ç å¤±è´¥æ–‡ä»¶åˆ—è¡¨
          if [ -n "$ENCODED_FAILED_FILES" ]; then
              FAILED_FILES=$(echo "$ENCODED_FAILED_FILES" | base64 --decode)
          else
              FAILED_FILES=""
          fi
          
          echo "## ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$STATUS" == "success" ]; then
            echo "âœ… **ç»“æœ:** é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ æ‰€æœ‰å˜æ›´çš„ C# æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" == "skipped" ]; then
            echo "âšª **ç»“æœ:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            echo "âœ¨ æŒ‡å®šè·¯å¾„å†…æ—  .cs æ–‡ä»¶å˜æ›´ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ç»“æœ:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ å‘ç°ä»£ç æ ¼å¼é—®é¢˜ï¼Œè¯·åœ¨æœ¬åœ°è¿è¡Œ \`dotnet csharpier .\` è¿›è¡Œä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æŠ¥å‘Šå¤±è´¥æ–‡ä»¶åˆ—è¡¨
            if [ -n "$FAILED_FILES" ]; then
              echo "### ğŸ“„ æœªé€šè¿‡æ ¼å¼æ£€æŸ¥çš„æ–‡ä»¶ (${COUNT} ä¸ª)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "$FAILED_FILES" >> $GITHUB_STEP_SUMMARY
            else
              # æŠ¥å‘Šï¼šä»ç„¶æœªèƒ½è§£æå‡ºæ–‡ä»¶åˆ—è¡¨
              echo "â“ **æ³¨æ„:** CSharpier æ£€æŸ¥å¤±è´¥ï¼ˆé€€å‡ºç éé›¶ï¼‰ï¼Œä½†æœªèƒ½è§£æå‡ºå…·ä½“æ–‡ä»¶åˆ—è¡¨ã€‚è¯·æ£€æŸ¥ Action Log è·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ é…ç½®è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ£€æŸ¥è·¯å¾„** | \`${{ steps.config.outputs.check_paths }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ£€æŸ¥æ–‡ä»¶æ•°** | $COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| **è‡ªåŠ¨ä¿®å¤** | âŒ (å·²ç¦ç”¨) |" >> $GITHUB_STEP_SUMMARY
      - name: ğŸ“Š ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
        if: always() 
        run: |
          STATUS="${{ steps.run_check.outputs.status }}"
          COUNT="${{ steps.run_check.outputs.files_count }}"
          ENCODED_FAILED_FILES="${{ steps.run_check.outputs.failed_files }}"
          
          # è§£ç å¤±è´¥æ–‡ä»¶åˆ—è¡¨
          if [ -n "$ENCODED_FAILED_FILES" ]; then
              FAILED_FILES=$(echo "$ENCODED_FAILED_FILES" | base64 --decode)
          else
              FAILED_FILES=""
          fi
          
          echo "## ğŸ¨ ä»£ç é£æ ¼æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$STATUS" == "success" ]; then
            echo "âœ… **ç»“æœ:** é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ æ‰€æœ‰å˜æ›´çš„ C# æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "$STATUS" == "skipped" ]; then
            echo "âšª **ç»“æœ:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            echo "âœ¨ æŒ‡å®šè·¯å¾„å†…æ—  .cs æ–‡ä»¶å˜æ›´ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ç»“æœ:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ å‘ç°ä»£ç æ ¼å¼é—®é¢˜ï¼Œè¯·åœ¨æœ¬åœ°è¿è¡Œ \`dotnet csharpier .\` è¿›è¡Œä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æŠ¥å‘Šå¤±è´¥æ–‡ä»¶åˆ—è¡¨
            if [ -n "$FAILED_FILES" ]; then
              echo "### ğŸ“„ æœªé€šè¿‡æ ¼å¼æ£€æŸ¥çš„æ–‡ä»¶ (${COUNT} ä¸ª)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "$FAILED_FILES" >> $GITHUB_STEP_SUMMARY
            else
              # å¤‡ä»½é€»è¾‘ï¼šå¦‚æœè§£æå¤±è´¥ï¼Œä½†é€€å‡ºç æ˜¯éé›¶ï¼Œè¯´æ˜ CSharpier æŠ¥é”™
              echo "â“ **æ³¨æ„:** CSharpier æ£€æŸ¥å¤±è´¥ï¼Œä½†æœªèƒ½è§£æå‡ºå…·ä½“æ–‡ä»¶åˆ—è¡¨ã€‚è¯·æ£€æŸ¥ Action Log è·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ é…ç½®è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ£€æŸ¥è·¯å¾„** | \`${{ steps.config.outputs.check_paths }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ£€æŸ¥æ–‡ä»¶æ•°** | $COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| **è‡ªåŠ¨ä¿®å¤** | âŒ (å·²ç¦ç”¨) |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================  
  # é˜¶æ®µ2: å•å…ƒæµ‹è¯• - è¿è¡ŒUnityé¡¹ç›®ä¸­çš„å•å…ƒæµ‹è¯•
  # =============================================================================
  unity-tests:
    name: ğŸ§ª Unityå•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [flow-prediction, code-style-check]
    if: |
      always() && 
      needs.flow-prediction.outputs.should_run_tests == 'true' && 
      (needs.code-style-check.result == 'success' || needs.code-style-check.result == 'skipped')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ“– åŠ è½½æµ‹è¯•é…ç½®
        id: load-test-config  
        run: |
          echo "ğŸ”§ åŠ è½½å•å…ƒæµ‹è¯•é…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          # æå–æµ‹è¯•é…ç½®
          EDIT_MODE_PATH=$(jq -r '.jobs.unit_tests.settings.testPaths.editMode' "$CONFIG_FILE")
          PLAY_MODE_PATH=$(jq -r '.jobs.unit_tests.settings.testPaths.playMode' "$CONFIG_FILE")
          GENERATE_COVERAGE=$(jq -r '.jobs.unit_tests.settings.generateCoverage' "$CONFIG_FILE")
          QUIET_MODE=$(jq -r '.jobs.unit_tests.settings.quietMode' "$CONFIG_FILE")
          UNITY_VERSION=$(jq -r '.project.unityVersion' "$CONFIG_FILE")
          
          echo "Unityç‰ˆæœ¬: $UNITY_VERSION"
          echo "EditModeæµ‹è¯•è·¯å¾„: $EDIT_MODE_PATH"
          echo "PlayModeæµ‹è¯•è·¯å¾„: $PLAY_MODE_PATH"  
          echo "ç”Ÿæˆè¦†ç›–ç‡: $GENERATE_COVERAGE"
          echo "é™é»˜æ¨¡å¼: $QUIET_MODE"
          
          echo "unity_version=$UNITY_VERSION" >> $GITHUB_OUTPUT
          echo "edit_mode_path=$EDIT_MODE_PATH" >> $GITHUB_OUTPUT
          echo "play_mode_path=$PLAY_MODE_PATH" >> $GITHUB_OUTPUT
          echo "generate_coverage=$GENERATE_COVERAGE" >> $GITHUB_OUTPUT
          echo "quiet_mode=$QUIET_MODE" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ ç¼“å­˜Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-

      - name: ğŸ§ª è¿è¡ŒEditModeæµ‹è¯•
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ steps.load-test-config.outputs.unity_version }}
          testMode: EditMode

      - name: ğŸ® è¿è¡ŒPlayModeæµ‹è¯•  
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ steps.load-test-config.outputs.unity_version }}
          testMode: PlayMode

      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unity-test-results
          path: artifacts/

      - name: ğŸ“‹ æµ‹è¯•ç»“æœæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ§ª Unityå•å…ƒæµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æµ‹è¯•çŠ¶æ€:** å®Œæˆ" >> $GITHUB_STEP_SUMMARY  
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµ‹è¯•é…ç½®:**" >> $GITHUB_STEP_SUMMARY
          echo "- Unityç‰ˆæœ¬: \`${{ steps.load-test-config.outputs.unity_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- EditModeè·¯å¾„: \`${{ steps.load-test-config.outputs.edit_mode_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- PlayModeè·¯å¾„: \`${{ steps.load-test-config.outputs.play_mode_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- è¦†ç›–ç‡æŠ¥å‘Š: \`${{ steps.load-test-config.outputs.generate_coverage }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # é˜¶æ®µ3: æ„å»ºæµ‹è¯• - æ„å»ºWindowså’ŒmacOSç‰ˆæœ¬  
  # =============================================================================
  build-tests:
    name: ğŸ”¨ æ„å»ºæµ‹è¯•
    needs: [flow-prediction, unity-tests] 
    if: |
      always() &&
      needs.flow-prediction.outputs.should_run_build == 'true' &&
      (needs.unity-tests.result == 'success' || needs.unity-tests.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            buildTarget: StandaloneWindows64
            displayName: Windows 64ä½
          - os: macos-latest  
            buildTarget: StandaloneOSX
            displayName: macOS (ARM)
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ“– åŠ è½½æ„å»ºé…ç½®
        id: load-build-config
        run: |
          echo "ğŸ”§ åŠ è½½æ„å»ºé…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          UNITY_VERSION=$(jq -r '.project.unityVersion' "$CONFIG_FILE")
          PROJECT_NAME=$(jq -r '.project.name' "$CONFIG_FILE")
          BUILD_TYPE="${{ needs.flow-prediction.outputs.build_type }}"
          RETENTION_DAYS=$(jq -r '.jobs.build_tests.settings.retentionDays' "$CONFIG_FILE")
          
          echo "Unityç‰ˆæœ¬: $UNITY_VERSION"
          echo "é¡¹ç›®åç§°: $PROJECT_NAME"  
          echo "æ„å»ºç±»å‹: $BUILD_TYPE"
          echo "ä¿ç•™å¤©æ•°: $RETENTION_DAYS"
          echo "æ„å»ºç›®æ ‡: ${{ matrix.buildTarget }}"
          echo "æ˜¾ç¤ºåç§°: ${{ matrix.displayName }}"
          
          echo "unity_version=$UNITY_VERSION" >> $GITHUB_OUTPUT
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "retention_days=$RETENTION_DAYS" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ ç¼“å­˜Unity Library  
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.buildTarget }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.buildTarget }}-
            Library-

      - name: ğŸ”¨ Unityæ„å»º
        id: unity-build
        uses: game-ci/unity-builder@v4
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          unityVersion: ${{ steps.load-build-config.outputs.unity_version }}
          targetPlatform: ${{ matrix.buildTarget }}
          buildName: ${{ steps.load-build-config.outputs.project_name }}
          
      - name: ğŸ“¦ ç¡®å®šäº§ç‰©åç§°å¹¶ä¸Šä¼ 
        id: determine-artifact-name
        run: |
          # ç¡®å®šäº§ç‰©åç§°
          if [[ "${{ github.event.pull_request.title }}" == *"[ADD DEPLOY]"* ]] || [[ "${{ github.event.head_commit.message }}" == *"[ADD DEPLOY]"* ]]; then
            # ä½¿ç”¨ç‰¹æ®Šå‘½åï¼ˆç”¨äºéƒ¨ç½²ï¼‰
            ARTIFACT_NAME="${{ steps.load-build-config.outputs.project_name }}_${{ matrix.buildTarget }}_${{ github.event.pull_request.title || github.ref_name }}"
            echo "ä½¿ç”¨éƒ¨ç½²ä¸“ç”¨å‘½å: $ARTIFACT_NAME"
          else
            # ä½¿ç”¨å¸¸è§„å‘½å
            ARTIFACT_NAME="${{ steps.load-build-config.outputs.project_name }}_${{ matrix.buildTarget }}_v${{ github.run_number }}"
            echo "ä½¿ç”¨å¸¸è§„å‘½å: $ARTIFACT_NAME"
          fi
          
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.determine-artifact-name.outputs.artifact_name }}
          path: build/
          retention-days: ${{ steps.load-build-config.outputs.retention_days }}

      - name: ğŸ“‹ æ„å»ºç»“æœæ‘˜è¦
        if: always()
        run: |
          # æ£€æŸ¥å‰é¢æ­¥éª¤çš„çŠ¶æ€
          BUILD_STATUS="${{ steps.unity-build.conclusion || 'unknown' }}"
          
          echo "## ğŸ”¨ æ„å»ºæµ‹è¯•ç»“æœ - ${{ matrix.displayName }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$BUILD_STATUS" == "success" ]]; then
            echo "âœ… **æ„å»ºçŠ¶æ€:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [[ "$BUILD_STATUS" == "failure" ]]; then
            echo "âŒ **æ„å»ºçŠ¶æ€:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **æ„å»ºçŠ¶æ€:** $BUILD_STATUS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- å¹³å°: \`${{ matrix.displayName }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç›®æ ‡: \`${{ matrix.buildTarget }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ç±»å‹: \`${{ steps.load-build-config.outputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- äº§ç‰©åç§°: \`${{ steps.determine-artifact-name.outputs.artifact_name }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$BUILD_STATUS" == "failure" ]]; then
            echo "- å¤±è´¥åŸå› : è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # é˜¶æ®µ4: éƒ¨ç½²åˆ°GitHub Pages - å°†æ„å»ºäº§ç‰©éƒ¨ç½²åˆ°GitHub Pages
  # =============================================================================
  deploy-pages:
    name: ğŸš€ éƒ¨ç½²GitHub Pages
    runs-on: ubuntu-latest
    needs: [flow-prediction, build-tests]
    if: |
      always() &&
      needs.flow-prediction.outputs.should_run_deploy == 'true' &&
      (needs.build-tests.result == 'success' || needs.build-tests.result == 'failure')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“– åŠ è½½éƒ¨ç½²é…ç½®
        id: load-deploy-config
        run: |
          echo "ğŸ”§ åŠ è½½éƒ¨ç½²é…ç½®..."
          
          CONFIG_FILE=".github/workflows/Pipeline Config/pipeline-settings.json"
          
          PROJECT_NAME=$(jq -r '.project.name' "$CONFIG_FILE")
          ARTIFACT_PATTERN=$(jq -r '.jobs.deploy_pages.settings.artifactNamePattern' "$CONFIG_FILE")
          BRANCH_REQUIREMENT=$(jq -r '.jobs.deploy_pages.settings.branchRequirement' "$CONFIG_FILE")
          
          echo "é¡¹ç›®åç§°: $PROJECT_NAME"
          echo "äº§ç‰©å‘½åæ¨¡å¼: $ARTIFACT_PATTERN"
          echo "åˆ†æ”¯è¦æ±‚: $BRANCH_REQUIREMENT"
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦ç¬¦åˆè¦æ±‚
          CURRENT_BRANCH="${{ github.ref_name }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¼ºåˆ¶éƒ¨ç½²å…³é”®å­—
          if [[ "${{ github.event.pull_request.title }}" == *"[ADD DEPLOY]"* ]] || [[ "${{ github.event.head_commit.message }}" == *"[ADD DEPLOY]"* ]]; then
            echo "ğŸ”¥ æ£€æµ‹åˆ° [ADD DEPLOY] å…³é”®å­—ï¼Œè·³è¿‡åˆ†æ”¯é™åˆ¶"
            echo "âœ… å¼ºåˆ¶éƒ¨ç½²ï¼šå¿½ç•¥åˆ†æ”¯è¦æ±‚ ($BRANCH_REQUIREMENT)"
            echo "branch_check=pass" >> $GITHUB_OUTPUT
          elif [[ "$CURRENT_BRANCH" =~ $BRANCH_REQUIREMENT ]]; then
            echo "âœ… å½“å‰åˆ†æ”¯ ($CURRENT_BRANCH) ç¬¦åˆéƒ¨ç½²è¦æ±‚"
            echo "branch_check=pass" >> $GITHUB_OUTPUT
          else
            echo "âŒ å½“å‰åˆ†æ”¯ ($CURRENT_BRANCH) ä¸ç¬¦åˆéƒ¨ç½²è¦æ±‚ ($BRANCH_REQUIREMENT)"
            echo "â“ æç¤ºï¼šä½¿ç”¨ [ADD DEPLOY] å…³é”®å­—å¯å¼ºåˆ¶éƒ¨ç½²"
            echo "branch_check=fail" >> $GITHUB_OUTPUT
          fi
          
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        id: download-artifacts
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: ${{ steps.load-deploy-config.outputs.project_name }}_*_v${{ github.run_number }}
          path: ./artifacts
          merge-multiple: true

      - name: ğŸ“„ å‡†å¤‡Pageså†…å®¹
        id: prepare-pages
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        run: |
          echo "ğŸ“„ å‡†å¤‡GitHub Pageséƒ¨ç½²å†…å®¹..."
          
          mkdir -p ./pages
          
          # åˆ›å»ºç®€å•çš„ç´¢å¼•é¡µé¢
          cat > ./pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>${{ steps.load-deploy-config.outputs.project_name }} - æ„å»ºäº§ç‰©</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { border-bottom: 1px solid #ccc; padding-bottom: 20px; }
                  .artifact { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
                  .download-link { color: #0366d6; text-decoration: none; }
                  .download-link:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>${{ steps.load-deploy-config.outputs.project_name }}</h1>
                  <p>æ„å»ºç‰ˆæœ¬: v${{ github.run_number }}</p>
                  <p>æ„å»ºåˆ†æ”¯: ${{ steps.load-deploy-config.outputs.current_branch }}</p>
                  <p>æ„å»ºæ—¶é—´: $(date)</p>
              </div>
              
              <h2>ğŸ“¦ å¯ç”¨çš„æ„å»ºäº§ç‰©</h2>
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰æ„å»ºäº§ç‰©
          if [[ -d "./artifacts" ]]; then
            for artifact in ./artifacts/*/; do
              if [[ -d "$artifact" ]]; then
                artifact_name=$(basename "$artifact")
                echo "              <div class=\"artifact\">" >> ./pages/index.html
                echo "                  <h3>ğŸ¯ $artifact_name</h3>" >> ./pages/index.html
                echo "                  <p><a href=\"$artifact_name/\" class=\"download-link\">ğŸ“¥ æŸ¥çœ‹å†…å®¹</a></p>" >> ./pages/index.html
                echo "              </div>" >> ./pages/index.html
              fi
            done
            
            # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°pagesç›®å½•
            cp -r ./artifacts/* ./pages/
          else
            echo "              <p>âŒ æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰©</p>" >> ./pages/index.html
          fi
          
          echo "          </body>" >> ./pages/index.html
          echo "          </html>" >> ./pages/index.html
          
          echo "âœ… Pageså†…å®¹å‡†å¤‡å®Œæˆ"

      - name: ğŸ”§ é…ç½®Pages
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ ä¸Šä¼ Pageså†…å®¹
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./pages

      - name: ğŸš€ éƒ¨ç½²åˆ°Pages
        if: steps.load-deploy-config.outputs.branch_check == 'pass'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“‹ éƒ¨ç½²ç»“æœæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸš€ GitHub Pageséƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥å„ä¸ªæ­¥éª¤çš„çŠ¶æ€
          BRANCH_CHECK="${{ steps.load-deploy-config.outputs.branch_check }}"
          DOWNLOAD_STATUS="${{ steps.download-artifacts.conclusion || 'unknown' }}"
          PREPARE_STATUS="${{ steps.prepare-pages.conclusion || 'unknown' }}"
          DEPLOY_STATUS="${{ steps.deployment.conclusion || 'unknown' }}"
          
          echo "ğŸ” è°ƒè¯•ä¿¡æ¯:"
          echo "- åˆ†æ”¯æ£€æŸ¥: $BRANCH_CHECK"
          echo "- ä¸‹è½½äº§ç‰©: $DOWNLOAD_STATUS"
          echo "- å‡†å¤‡å†…å®¹: $PREPARE_STATUS"
          echo "- éƒ¨ç½²çŠ¶æ€: $DEPLOY_STATUS"
          echo ""
          
          if [[ "$BRANCH_CHECK" == "pass" ]]; then
            # åˆ†æ”¯æ£€æŸ¥é€šè¿‡ï¼Œæ£€æŸ¥éƒ¨ç½²ç»“æœ
            if [[ "$DEPLOY_STATUS" == "success" ]]; then
              echo "âœ… **éƒ¨ç½²çŠ¶æ€:** æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            elif [[ "$DEPLOY_STATUS" == "failure" ]]; then
              echo "âŒ **éƒ¨ç½²çŠ¶æ€:** å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            elif [[ "$DEPLOY_STATUS" == "skipped" ]]; then
              echo "â­ï¸ **éƒ¨ç½²çŠ¶æ€:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **éƒ¨ç½²çŠ¶æ€:** $DEPLOY_STATUS" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**éƒ¨ç½²ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
            echo "- é¡¹ç›®åç§°: \`${{ steps.load-deploy-config.outputs.project_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- æ„å»ºç‰ˆæœ¬: \`v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- æºåˆ†æ”¯: \`${{ steps.load-deploy-config.outputs.current_branch }}\`" >> $GITHUB_STEP_SUMMARY
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯å¼ºåˆ¶éƒ¨ç½²
            if [[ "${{ github.event.pull_request.title }}" == *"[ADD DEPLOY]"* ]] || [[ "${{ github.event.head_commit.message }}" == *"[ADD DEPLOY]"* ]]; then
              echo "- éƒ¨ç½²ç±»å‹: \`å¼ºåˆ¶éƒ¨ç½² (é€šè¿‡ [ADD DEPLOY] å…³é”®å­—)\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- éƒ¨ç½²ç±»å‹: \`æ ‡å‡†éƒ¨ç½² (ç¬¦åˆåˆ†æ”¯è¦æ±‚)\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ -n "${{ steps.deployment.outputs.page_url }}" ]]; then
              echo "- è®¿é—®é“¾æ¥: [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
            fi
            
            # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if [[ "$DEPLOY_STATUS" == "failure" ]]; then
              echo "- å¤±è´¥åŸå› : è¯·æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            fi
            
          else
            echo "â­ï¸ **éƒ¨ç½²çŠ¶æ€:** è·³è¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è·³è¿‡åŸå› :** å½“å‰åˆ†æ”¯ (\`${{ steps.load-deploy-config.outputs.current_branch }}\`) ä¸ç¬¦åˆéƒ¨ç½²è¦æ±‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **æç¤º:** åœ¨PRæ ‡é¢˜ä¸­æ·»åŠ  \`[ADD DEPLOY]\` å…³é”®å­—å¯å¼ºåˆ¶å¯ç”¨éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          fi

  # =============================================================================
  # é˜¶æ®µ5: æ‰§è¡Œè¯¦æƒ…æ±‡æ€» - æ±‡æ€»æ•´ä¸ªæµæ°´çº¿çš„æ‰§è¡Œæƒ…å†µ
  # =============================================================================
  execution-summary:
    name: ğŸ“Š æ‰§è¡Œè¯¦æƒ…æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [flow-prediction, code-style-check, unity-tests, build-tests, deploy-pages]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        run: |
          echo "ğŸ“Š æ±‡æ€»CI/CDæµæ°´çº¿æ‰§è¡Œç»“æœ..."
          
          # æ”¶é›†å„é˜¶æ®µçŠ¶æ€
          FLOW_STATUS="${{ needs.flow-prediction.result }}"
          STYLE_STATUS="${{ needs.code-style-check.result }}"
          TEST_STATUS="${{ needs.unity-tests.result }}" 
          BUILD_STATUS="${{ needs.build-tests.result }}"
          DEPLOY_STATUS="${{ needs.deploy-pages.result }}"
          
          echo "æµç¨‹é¢„æµ‹: $FLOW_STATUS"
          echo "ä»£ç æ£€æŸ¥: $STYLE_STATUS"
          echo "å•å…ƒæµ‹è¯•: $TEST_STATUS"
          echo "æ„å»ºæµ‹è¯•: $BUILD_STATUS"  
          echo "Pageséƒ¨ç½²: $DEPLOY_STATUS"
          
          # ç”Ÿæˆè¯¦ç»†çš„æ‰§è¡Œæ‘˜è¦
          echo "# ğŸš€ CI/CDæµæ°´çº¿æ‰§è¡Œè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æµç¨‹æè¿°:** ${{ needs.flow-prediction.outputs.pipeline_description }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºç±»å‹:** \`${{ needs.flow-prediction.outputs.build_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“‹ æ‰§è¡Œé˜¶æ®µè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é˜¶æ®µ | çŠ¶æ€ | ç»“æœ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # æµç¨‹é¢„æµ‹
          if [[ "$FLOW_STATUS" == "success" ]]; then
            echo "| ğŸ“‹ æµç¨‹é¢„æµ‹ | âœ… æˆåŠŸ | å·²å®Œæˆ | æˆåŠŸåˆ†æè§¦å‘æ¡ä»¶å’Œé¢„æµ‹æ‰§è¡Œæµç¨‹ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“‹ æµç¨‹é¢„æµ‹ | âŒ å¤±è´¥ | å·²å®Œæˆ | æµç¨‹é¢„æµ‹å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ä»£ç æ£€æŸ¥
          if [[ "${{ needs.flow-prediction.outputs.should_run_style }}" == "true" ]]; then
            if [[ "$STYLE_STATUS" == "success" ]]; then
              echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | âœ… æˆåŠŸ | å·²å®Œæˆ | ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$STYLE_STATUS" == "failure" ]]; then
              echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | âŒ å¤±è´¥ | å·²å®Œæˆ | ä»£ç æ ¼å¼æ£€æŸ¥æœªé€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $STYLE_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸ¨ ä»£ç æ£€æŸ¥ | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å•å…ƒæµ‹è¯•
          if [[ "${{ needs.flow-prediction.outputs.should_run_tests }}" == "true" ]]; then
            if [[ "$TEST_STATUS" == "success" ]]; then
              echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âœ… æˆåŠŸ | å·²å®Œæˆ | Unityæµ‹è¯•å…¨éƒ¨é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$TEST_STATUS" == "failure" ]]; then
              echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âŒ å¤±è´¥ | å·²å®Œæˆ | å­˜åœ¨æµ‹è¯•å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸ§ª å•å…ƒæµ‹è¯• | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $TEST_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸ§ª å•å…ƒæµ‹è¯• | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ„å»ºæµ‹è¯•  
          if [[ "${{ needs.flow-prediction.outputs.should_run_build }}" == "true" ]]; then
            if [[ "$BUILD_STATUS" == "success" ]]; then
              echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âœ… æˆåŠŸ | å·²å®Œæˆ | Windowså’ŒmacOSæ„å»ºæˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$BUILD_STATUS" == "failure" ]]; then
              echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âš ï¸ è­¦å‘Š | å·²å®Œæˆ | æ„å»ºå¤±è´¥ä½†ä¸å½±å“æµç¨‹ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸ”¨ æ„å»ºæµ‹è¯• | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Pageséƒ¨ç½²
          if [[ "${{ needs.flow-prediction.outputs.should_run_deploy }}" == "true" ]]; then
            if [[ "$DEPLOY_STATUS" == "success" ]]; then
              echo "| ğŸš€ Pageséƒ¨ç½² | âœ… æˆåŠŸ | å·²å®Œæˆ | æ„å»ºäº§ç‰©å·²éƒ¨ç½²åˆ°GitHub Pages |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$DEPLOY_STATUS" == "failure" ]]; then  
              echo "| ğŸš€ Pageséƒ¨ç½² | âš ï¸ è­¦å‘Š | å·²å®Œæˆ | éƒ¨ç½²å¤±è´¥ä½†ä¸å½±å“æµç¨‹ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ğŸš€ Pageséƒ¨ç½² | âš ï¸ å¼‚å¸¸ | å·²å®Œæˆ | çŠ¶æ€: $DEPLOY_STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ğŸš€ Pageséƒ¨ç½² | â­ï¸ è·³è¿‡ | - | æ ¹æ®è§¦å‘æ¡ä»¶è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ€»ä½“çŠ¶æ€åˆ¤æ–­
          if [[ "$FLOW_STATUS" == "success" && 
                ("$STYLE_STATUS" == "success" || "$STYLE_STATUS" == "skipped") &&
                ("$TEST_STATUS" == "success" || "$TEST_STATUS" == "skipped") ]]; then
            echo "## âœ… æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ æ‰€æœ‰å¿…éœ€çš„æ­¥éª¤éƒ½å·²æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ æµæ°´çº¿æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY  
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ éƒ¨åˆ†æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ -n "${{ needs.flow-prediction.outputs.skip_reason }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è·³è¿‡ä¿¡æ¯:** ${{ needs.flow-prediction.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
          fi
