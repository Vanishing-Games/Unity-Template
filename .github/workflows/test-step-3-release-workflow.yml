name: ğŸ§ª æµ‹è¯• - æ­¥éª¤3å‘å¸ƒå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: "preview = ä»…æ„å»ºï¼"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - release_candidate
          - release
      buildVersion:
        description: "å¯é€‰çš„ç‰ˆæœ¬å·å­—ç¬¦ä¸²ï¼ˆå¦‚ v1.2.3 æˆ– v1.2.3-rc.1ï¼‰ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚ PR-0001, manual-mainï¼‰"
        required: false
        default: "v0.0.0"
        type: string
      projectName:
        description: "äº§ç‰©çš„é¡¹ç›®åç§°"
        required: true
        default: "Unity_CI_Templates"
      buildTargets:
        description: "æ„å»ºç›®æ ‡çš„ JSON æ•°ç»„"
        required: true
        default: '["Android", "WebGL", "StandaloneLinux64-Client", "StandaloneLinux64-Server", "StandaloneWindows", "StandaloneWindows64", "StandaloneOSX", "iOS"]'
      deployTargets:
        description: "éƒ¨ç½²ç›®æ ‡çš„ JSON æ•°ç»„ï¼ˆå¦‚ [\"itch.io\",\"s3\"]ï¼‰"
        required: true
        default: '["steam", "gh-pages"]'
        type: string

permissions:
  contents: write

jobs:
  prepare_metadata:
    name: â³ å…ƒæ•°æ®å‡†å¤‡
    uses: ./.github/workflows/prepare-metadata.yml
    with:
      projectName: ${{ inputs.projectName }}
      unityVersion: ${{ vars.UNITY_VERSION }}
      skipTests: true
      testsOnly: false
      buildTargets: ${{ inputs.buildTargets }}
      deployTargets: ${{ inputs.deployTargets }}
      buildType: ${{ inputs.buildType }}
      buildVersion: ${{ inputs.buildVersion }}

  dry_build:
    name: ğŸ§© åˆ›å»ºå¹²æ„å»º
    needs: prepare_metadata
    uses: ./.github/workflows/dry-build.yml
    with:
      unityVersion: ${{ needs.prepare_metadata.outputs.unityVersion }}
      buildVersion: ${{ needs.prepare_metadata.outputs.buildVersion }}
      buildType: ${{ needs.prepare_metadata.outputs.buildType }}
      projectName: ${{ needs.prepare_metadata.outputs.projectName }}
      buildTargets: ${{ inputs.buildTargets }}
      combineArtifacts: ${{ needs.prepare_metadata.outputs.requiresCombined }}
    secrets: inherit

  test_release:
    name: ğŸ“¦ æµ‹è¯•å‘å¸ƒå·¥ä½œæµ
    needs: 
      - prepare_metadata 
      - dry_build
    if: ${{ inputs.buildType == 'release' || inputs.buildType == 'release_candidate' }}
    uses: ./.github/workflows/step-3-release.yml
    with:
      buildType: ${{ needs.prepare_metadata.outputs.buildType }}
      buildVersion: ${{ needs.prepare_metadata.outputs.buildVersion }}
      projectName: ${{ needs.prepare_metadata.outputs.projectName }}
      buildTargets: ${{ inputs.buildTargets }}
      combineArtifacts: ${{ needs.prepare_metadata.outputs.requiresCombined }}
      skipPerBuildTargetArtifacts: ${{ needs.prepare_metadata.outputs.skipPerBuildTarget }}  
    secrets: inherit