name: âš™ï¸ CI/CD æ™ºèƒ½åˆ†å‘å™¨

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'            # åŒ¹é… v1.2.3 (release)
      - 'v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+'  # åŒ¹é… v1.2.3-rc.1 (release_candidate)
    branches:
      - 'release/**'                       # releaseåˆ†æ”¯è§¦å‘å®Œæ•´CI/CD
      - 'develop'                          # developåˆ†æ”¯è§¦å‘CI
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'Tests/**'
      - '.github/config/**'
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - 'develop'
      - 'main'
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'Tests/**'
      - '.github/config/**'

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  CONFIG_PATH: '.github/config'

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ” é…ç½®éªŒè¯å’Œæµç¨‹è§£æž
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  parse_trigger:
    name: ðŸ” è§£æžè§¦å‘æ¡ä»¶å’Œé…ç½®
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.parse.outputs.should_run }}
      pipeline_type: ${{ steps.parse.outputs.pipeline_type }}
      skip_reason: ${{ steps.parse.outputs.skip_reason }}
      build_type: ${{ steps.parse.outputs.build_type }}
      tests_only: ${{ steps.parse.outputs.tests_only }}
      commit_message: ${{ steps.parse.outputs.commit_message }}
      trigger_source: ${{ steps.parse.outputs.trigger_source }}
      debug_info: ${{ steps.parse.outputs.debug_info }}
    steps:
      - name: ðŸ“ æ£€å‡ºé…ç½®æ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ env.CONFIG_PATH }}
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ðŸ” è§£æžè§¦å‘æ¡ä»¶å’ŒCommitå…³é”®å­—
        id: parse
        shell: bash
        run: |
          set -euo pipefail
          
          # åŠ è½½é…ç½®æ–‡ä»¶
          PIPELINE_CONFIG="${CONFIG_PATH}/pipeline-config.json"
          DEFAULTS_CONFIG="${CONFIG_PATH}/defaults.json"
          
          echo "ðŸ“‹ åŠ è½½é…ç½®æ–‡ä»¶..."
          if [[ ! -f "$PIPELINE_CONFIG" ]]; then
            echo "âŒ ç¼ºå°‘ç®¡é“é…ç½®æ–‡ä»¶: $PIPELINE_CONFIG"
            exit 1
          fi
          
          if [[ ! -f "$DEFAULTS_CONFIG" ]]; then
            echo "âŒ ç¼ºå°‘é»˜è®¤é…ç½®æ–‡ä»¶: $DEFAULTS_CONFIG"
            exit 1
          fi
          
          # èŽ·å–commitä¿¡æ¯
          COMMIT_MSG="${{ github.event.head_commit.message || github.event.pull_request.title || 'No commit message' }}"
          TRIGGER_SOURCE="${{ github.event_name }}"
          REF_NAME="${{ github.ref_name }}"
          REF_TYPE="${{ github.ref_type }}"
          
          echo "commit_message=$COMMIT_MSG" >> "$GITHUB_OUTPUT"
          echo "trigger_source=$TRIGGER_SOURCE" >> "$GITHUB_OUTPUT"
          
          echo "ðŸ” è§¦å‘ä¿¡æ¯:"
          echo "  - äº‹ä»¶ç±»åž‹: $TRIGGER_SOURCE"
          echo "  - å¼•ç”¨åç§°: $REF_NAME"
          echo "  - å¼•ç”¨ç±»åž‹: $REF_TYPE"
          echo "  - Commitæ¶ˆæ¯: $COMMIT_MSG"
          
          # æ£€æŸ¥è·³è¿‡å…³é”®å­—
          SKIP_KEYWORDS=$(jq -r '.triggers.skip.commitKeywords[]' "$PIPELINE_CONFIG")
          for keyword in $SKIP_KEYWORDS; do
            if [[ "$COMMIT_MSG" == *"$keyword"* ]]; then
              echo "ðŸš« æ£€æµ‹åˆ°è·³è¿‡å…³é”®å­—: $keyword"
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "skip_reason=commit_keyword_$keyword" >> "$GITHUB_OUTPUT"
              echo "pipeline_type=skip" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done
          
          # æ£€æŸ¥TEST ONLYå…³é”®å­—
          TEST_ONLY_KEYWORDS=$(jq -r '.triggers.ciOnly.commitKeywords[]' "$PIPELINE_CONFIG")
          TESTS_ONLY=false
          for keyword in $TEST_ONLY_KEYWORDS; do
            if [[ "$COMMIT_MSG" == *"$keyword"* ]]; then
              echo "ðŸ§ª æ£€æµ‹åˆ°ä»…æµ‹è¯•å…³é”®å­—: $keyword"
              TESTS_ONLY=true
              break
            fi
          done
          echo "tests_only=$TESTS_ONLY" >> "$GITHUB_OUTPUT"
          
          # è§£æžæµæ°´çº¿ç±»åž‹å’Œæž„å»ºç±»åž‹
          PIPELINE_TYPE=""
          BUILD_TYPE=""
          
          case "$TRIGGER_SOURCE" in
            "push")
              if [[ "$REF_TYPE" == "tag" ]]; then
                echo "ðŸ·ï¸ æ ‡ç­¾æŽ¨é€è§¦å‘"
                if [[ "$REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
                  BUILD_TYPE="release_candidate"
                  PIPELINE_TYPE="full_cicd"
                elif [[ "$REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  BUILD_TYPE="release"
                  PIPELINE_TYPE="full_cicd"
                else
                  echo "âŒ ä¸æ”¯æŒçš„æ ‡ç­¾æ ¼å¼: $REF_NAME"
                  echo "should_run=false" >> "$GITHUB_OUTPUT"
                  echo "skip_reason=unsupported_tag_format" >> "$GITHUB_OUTPUT"
                  exit 0
                fi
              elif [[ "$REF_NAME" == release/* ]]; then
                echo "ðŸš€ Releaseåˆ†æ”¯æŽ¨é€è§¦å‘"
                BUILD_TYPE="release_candidate"
                PIPELINE_TYPE="full_cicd"
              elif [[ "$REF_NAME" == "develop" ]]; then
                echo "ðŸ”¨ Developåˆ†æ”¯æŽ¨é€è§¦å‘"
                BUILD_TYPE="preview"
                PIPELINE_TYPE="ci_only"
              else
                echo "â„¹ï¸ å…¶ä»–åˆ†æ”¯æŽ¨é€ï¼Œè·³è¿‡CI/CD"
                echo "should_run=false" >> "$GITHUB_OUTPUT"
                echo "skip_reason=branch_not_configured" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              ;;
            "pull_request")
              echo "ðŸ”„ PRäº‹ä»¶è§¦å‘"
              BUILD_TYPE="preview"
              PIPELINE_TYPE="ci_only"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„è§¦å‘äº‹ä»¶: $TRIGGER_SOURCE"
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "skip_reason=unsupported_event" >> "$GITHUB_OUTPUT"
              exit 0
              ;;
          esac
          
          # å¦‚æžœè®¾ç½®äº†TEST ONLYï¼Œå¼ºåˆ¶è®¾ä¸ºä»…æµ‹è¯•
          if [[ "$TESTS_ONLY" == "true" ]]; then
            BUILD_TYPE="preview"
            PIPELINE_TYPE="ci_only"
          fi
          
          echo "should_run=true" >> "$GITHUB_OUTPUT"
          echo "pipeline_type=$PIPELINE_TYPE" >> "$GITHUB_OUTPUT"
          echo "build_type=$BUILD_TYPE" >> "$GITHUB_OUTPUT"
          
          # ç”Ÿæˆè°ƒè¯•ä¿¡æ¯
          DEBUG_INFO=$(jq -n \
            --arg trigger_source "$TRIGGER_SOURCE" \
            --arg ref_name "$REF_NAME" \
            --arg ref_type "$REF_TYPE" \
            --arg pipeline_type "$PIPELINE_TYPE" \
            --arg build_type "$BUILD_TYPE" \
            --arg tests_only "$TESTS_ONLY" \
            '{
              "trigger_source": $trigger_source,
              "ref_name": $ref_name,
              "ref_type": $ref_type,
              "pipeline_type": $pipeline_type,
              "build_type": $build_type,
              "tests_only": $tests_only
            }')
          
          # å°†DEBUG_INFOè¿›è¡Œbase64ç¼–ç ä»¥é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          DEBUG_INFO_ENCODED=$(echo "$DEBUG_INFO" | base64 | tr -d '\n')
          echo "debug_info=$DEBUG_INFO_ENCODED" >> "$GITHUB_OUTPUT"
          
          echo "âœ… æµæ°´çº¿è§£æžå®Œæˆ:"
          echo "  - æµæ°´çº¿ç±»åž‹: $PIPELINE_TYPE"
          echo "  - æž„å»ºç±»åž‹: $BUILD_TYPE"
          echo "  - ä»…æµ‹è¯•: $TESTS_ONLY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ›¡ï¸ é…ç½®å’ŒSecretséªŒè¯  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate_config:
    name: ðŸ›¡ï¸ éªŒè¯é…ç½®å’ŒSecrets
    runs-on: ubuntu-latest
    needs: parse_trigger
    if: needs.parse_trigger.outputs.should_run == 'true'
    outputs:
      validation_passed: ${{ steps.validate.outputs.validation_passed }}
      missing_secrets: ${{ steps.validate.outputs.missing_secrets }}
      config_errors: ${{ steps.validate.outputs.config_errors }}
    steps:
      - name: ðŸ“ æ£€å‡ºé…ç½®æ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            ${{ env.CONFIG_PATH }}
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ðŸ” éªŒè¯å¿…éœ€çš„Secrets
        id: validate
        shell: bash
        run: |
          set -euo pipefail
          
          PIPELINE_CONFIG="${CONFIG_PATH}/pipeline-config.json"
          REQUIRED_SECRETS=$(jq -r '.validation.requiredSecrets[]' "$PIPELINE_CONFIG")
          MISSING_SECRETS=""
          VALIDATION_PASSED=true
          
          echo "ðŸ” éªŒè¯å¿…éœ€çš„Secrets..."
          
          for SECRET_NAME in $REQUIRED_SECRETS; do
            VALUE_VAR="SECRET_${SECRET_NAME}"
            VALUE="${!VALUE_VAR:-}"
            
            if [[ -z "$VALUE" ]]; then
              echo "âŒ å¿…éœ€çš„Secret '$SECRET_NAME' æœªè®¾ç½®"
              MISSING_SECRETS="$MISSING_SECRETS $SECRET_NAME"
              VALIDATION_PASSED=false
            else
              echo "âœ… Secret '$SECRET_NAME' å·²è®¾ç½®"
            fi
          done
          
          # éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
          echo "ðŸ“‹ éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼..."
          CONFIG_ERRORS=""
          
          for config_file in defaults.json pipeline-config.json optional-build-targets.json build-targets-config.json deploy-targets.json build-profiles.json; do
            config_path="${CONFIG_PATH}/${config_file}"
            if [[ ! -f "$config_path" ]]; then
              echo "âŒ ç¼ºå°‘é…ç½®æ–‡ä»¶: $config_file"
              CONFIG_ERRORS="$CONFIG_ERRORS missing_$config_file"
              VALIDATION_PASSED=false
            elif ! jq empty "$config_path" 2>/dev/null; then
              echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: $config_file"
              CONFIG_ERRORS="$CONFIG_ERRORS invalid_$config_file"
              VALIDATION_PASSED=false
            else
              echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡: $config_file"
            fi
          done
          
          echo "validation_passed=$VALIDATION_PASSED" >> "$GITHUB_OUTPUT"
          echo "missing_secrets=$MISSING_SECRETS" >> "$GITHUB_OUTPUT"
          echo "config_errors=$CONFIG_ERRORS" >> "$GITHUB_OUTPUT"
          
          if [[ "$VALIDATION_PASSED" == "false" ]]; then
            echo "ðŸ’¥ é…ç½®éªŒè¯å¤±è´¥ï¼Œç»ˆæ­¢æµæ°´çº¿"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡"
        env:
          SECRET_UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          SECRET_UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          SECRET_UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          SECRET_CICD_PAT: ${{ secrets.CICD_PAT }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # â³ å…ƒæ•°æ®å‡†å¤‡
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prepare_metadata:
    name: â³ å‡†å¤‡æµæ°´çº¿å…ƒæ•°æ®
    needs: 
      - parse_trigger
      - validate_config
    if: needs.parse_trigger.outputs.should_run == 'true' && needs.validate_config.outputs.validation_passed == 'true'
    uses: ./.github/workflows/prepare-metadata.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ·ï¸ ç‰ˆæœ¬æ ‡è®° (ä»…é™å®Œæ•´CI/CD)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  tag_version:
    name: ðŸ·ï¸ ç‰ˆæœ¬æ ‡è®°
    needs: 
      - parse_trigger
      - prepare_metadata
    if: >
      needs.parse_trigger.outputs.should_run == 'true' && 
      needs.parse_trigger.outputs.pipeline_type == 'full_cicd'
    uses: ./.github/workflows/build-version-tagger.yml
    with:
      buildType: ${{ needs.prepare_metadata.outputs.buildType }}
      buildVersion: ${{ needs.prepare_metadata.outputs.buildVersion }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸš€ æ™ºèƒ½æµæ°´çº¿è§¦å‘å™¨
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger_pipeline:
    name: ðŸš€ è§¦å‘å¯¹åº”æµæ°´çº¿
    needs: 
      - parse_trigger
      - prepare_metadata
      - tag_version
    if: >
      needs.parse_trigger.outputs.should_run == 'true' && 
      (needs.tag_version.result == 'success' || needs.tag_version.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      triggered_pipeline: ${{ steps.trigger.outputs.triggered_pipeline }}
      workflow_run_id: ${{ steps.trigger.outputs.workflow_run_id }}
    steps:
      - name: ðŸ“ æ£€å‡ºå·¥ä½œæµæ–‡ä»¶
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/workflows
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: ðŸ”§ å®‰è£…GitHub CLI
        run: sudo apt-get update && sudo apt-get install gh -y

      - name: ðŸš€ æ™ºèƒ½è§¦å‘æµæ°´çº¿
        id: trigger
        env:
          GITHUB_TOKEN: ${{ secrets.CICD_PAT }}
        run: |
          PIPELINE_TYPE="${{ needs.parse_trigger.outputs.pipeline_type }}"
          
          echo "ðŸ” æ£€æµ‹åˆ°æµæ°´çº¿ç±»åž‹: $PIPELINE_TYPE"
          
          if [[ "$PIPELINE_TYPE" == "ci_only" ]]; then
            echo "ðŸš€ è§¦å‘CIæµæ°´çº¿..."
            echo "ðŸ“‹ æµæ°´çº¿å‚æ•°:"
            echo "  - æž„å»ºç›®æ ‡: ${{ needs.prepare_metadata.outputs.buildTargets }}"
            echo "  - ä»…æµ‹è¯•: ${{ needs.parse_trigger.outputs.tests_only }}"
            echo "  - æž„å»ºç±»åž‹: ${{ needs.prepare_metadata.outputs.buildType }}"
            
            WORKFLOW_RUN=$(gh workflow run ci-pipeline.yml \
              --ref "${{ github.ref }}" \
              --field buildTargets="${{ needs.prepare_metadata.outputs.buildTargets }}" \
              --field testsOnly="${{ needs.parse_trigger.outputs.tests_only }}" \
              --field buildType="${{ needs.prepare_metadata.outputs.buildType }}" \
              --field triggerSource="${{ needs.parse_trigger.outputs.trigger_source }}" 2>&1)
            
            echo "triggered_pipeline=ci-pipeline" >> "$GITHUB_OUTPUT"
            
          elif [[ "$PIPELINE_TYPE" == "full_cicd" ]]; then
            echo "ðŸš€ è§¦å‘å®Œæ•´CI/CDæµæ°´çº¿..."
            echo "ðŸ“‹ æµæ°´çº¿å‚æ•°:"
            echo "  - æž„å»ºç›®æ ‡: ${{ needs.prepare_metadata.outputs.buildTargets }}"
            echo "  - éƒ¨ç½²ç›®æ ‡: ${{ needs.prepare_metadata.outputs.validDeployTargets }}"
            echo "  - æž„å»ºç±»åž‹: ${{ needs.prepare_metadata.outputs.buildType }}"
            echo "  - æž„å»ºç‰ˆæœ¬: ${{ needs.prepare_metadata.outputs.buildVersion }}"
            
            # æž„å»ºmetadataConfig JSON
            METADATA_CONFIG=$(jq -c -n \
              --arg projectName "${{ needs.prepare_metadata.outputs.projectName }}" \
              --arg skipTests "${{ needs.prepare_metadata.outputs.skipTests }}" \
              --arg testsOnly "${{ needs.prepare_metadata.outputs.testsOnly }}" \
              --arg buildType "${{ needs.prepare_metadata.outputs.buildType }}" \
              --arg buildVersion "${{ needs.prepare_metadata.outputs.buildVersion }}" \
              --arg retentionDays "${{ needs.prepare_metadata.outputs.retentionDays }}" \
              --arg timeoutMinutesTests "${{ needs.prepare_metadata.outputs.timeoutMinutesTests }}" \
              --arg timeoutMinutesBuild "${{ needs.prepare_metadata.outputs.timeoutMinutesBuild }}" \
              '{
                "projectName": $projectName,
                "skipTests": $skipTests,
                "testsOnly": $testsOnly,
                "buildType": $buildType,
                "buildVersion": $buildVersion,
                "retentionDays": $retentionDays,
                "timeoutMinutesTests": $timeoutMinutesTests,
                "timeoutMinutesBuild": $timeoutMinutesBuild
              }')
            
            # æž„å»ºartifactConfig JSON
            ARTIFACT_CONFIG=$(jq -c -n \
              --arg requiresCombined "${{ needs.prepare_metadata.outputs.requiresCombined }}" \
              --arg skipPerBuildTarget "${{ needs.prepare_metadata.outputs.skipPerBuildTarget }}" \
              '{
                "requiresCombined": $requiresCombined,
                "skipPerBuildTarget": $skipPerBuildTarget
              }')
            
            # æž„å»ºtestDataConfig JSON
            TEST_DATA_CONFIG=$(jq -c -n \
              --arg unityVersion "${{ needs.prepare_metadata.outputs.unityVersion }}" \
              --arg useGitLfs "${{ needs.prepare_metadata.outputs.useGitLfs }}" \
              --arg editModePath "${{ needs.prepare_metadata.outputs.editModePath }}" \
              --arg playModePath "${{ needs.prepare_metadata.outputs.playModePath }}" \
              --arg quietMode "${{ needs.prepare_metadata.outputs.quietMode }}" \
              '{
                "unityVersion": $unityVersion,
                "useGitLfs": $useGitLfs,
                "editModePath": $editModePath,
                "playModePath": $playModePath,
                "quietMode": $quietMode
              }')
            
            WORKFLOW_RUN=$(gh workflow run ci-cd-pipeline.yml \
              --ref "${{ github.ref }}" \
              --field buildTargets="${{ needs.prepare_metadata.outputs.buildTargets }}" \
              --field validDeployTargets="${{ needs.prepare_metadata.outputs.validDeployTargets }}" \
              --field metadataConfig="$METADATA_CONFIG" \
              --field artifactConfig="$ARTIFACT_CONFIG" \
              --field testDataConfig="$TEST_DATA_CONFIG" 2>&1)
            
            echo "triggered_pipeline=ci-cd-pipeline" >> "$GITHUB_OUTPUT"
            
          else
            echo "âŒ æœªçŸ¥çš„æµæ°´çº¿ç±»åž‹: $PIPELINE_TYPE"
            exit 1
          fi
          
          echo "âœ… æµæ°´çº¿è§¦å‘æˆåŠŸ"
          
          # å°è¯•æå–å·¥ä½œæµè¿è¡ŒID (å¦‚æžœå¯èƒ½)
          if echo "$WORKFLOW_RUN" | grep -q "workflow_run_id"; then
            WORKFLOW_RUN_ID=$(echo "$WORKFLOW_RUN" | grep -o 'workflow_run_id: [0-9]*' | cut -d' ' -f2)
            echo "workflow_run_id=$WORKFLOW_RUN_ID" >> "$GITHUB_OUTPUT"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ðŸ“Š æµæ°´çº¿æ‘˜è¦
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pipeline_summary:
    name: ðŸ“Š æµæ°´çº¿æ‰§è¡Œæ‘˜è¦
    needs: 
      - parse_trigger
      - validate_config
      - prepare_metadata
      - trigger_pipeline
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
        run: |
          echo "# ðŸš€ CI/CD åˆ†å‘å™¨æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è§¦å‘åˆ†æžç»“æžœ
          echo "## ðŸ” è§¦å‘åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æº | \`${{ needs.parse_trigger.outputs.trigger_source }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æ˜¯å¦æ‰§è¡Œ | ${{ needs.parse_trigger.outputs.should_run == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æµæ°´çº¿ç±»åž‹ | \`${{ needs.parse_trigger.outputs.pipeline_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | \`${{ needs.parse_trigger.outputs.build_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ä»…æµ‹è¯•æ¨¡å¼ | ${{ needs.parse_trigger.outputs.tests_only == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.parse_trigger.outputs.should_run }}" != "true" ]]; then
            echo "| è·³è¿‡åŽŸå›  | \`${{ needs.parse_trigger.outputs.skip_reason }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # é…ç½®éªŒè¯ç»“æžœ
          if [[ "${{ needs.parse_trigger.outputs.should_run }}" == "true" ]]; then
            echo "## ðŸ›¡ï¸ é…ç½®éªŒè¯" >> $GITHUB_STEP_SUMMARY
            echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| SecretséªŒè¯ | ${{ needs.validate_config.outputs.validation_passed == 'true' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ needs.validate_config.outputs.missing_secrets }}" != "" ]]; then
              echo "| ç¼ºå¤±Secrets | \`${{ needs.validate_config.outputs.missing_secrets }}\` |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [[ "${{ needs.validate_config.outputs.config_errors }}" != "" ]]; then
              echo "| é…ç½®é”™è¯¯ | \`${{ needs.validate_config.outputs.config_errors }}\` |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æµæ°´çº¿æ‰§è¡Œç»“æžœ
          if [[ "${{ needs.parse_trigger.outputs.should_run }}" == "true" && "${{ needs.validate_config.outputs.validation_passed }}" == "true" ]]; then
            echo "## ðŸš€ æµæ°´çº¿æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
            echo "| æµæ°´çº¿ | çŠ¶æ€ | ç±»åž‹ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
            
            PIPELINE_STATUS="${{ needs.trigger_pipeline.result == 'success' && 'âœ… å·²è§¦å‘' || 'âŒ è§¦å‘å¤±è´¥' }}"
            TRIGGERED_PIPELINE="${{ needs.trigger_pipeline.outputs.triggered_pipeline || 'æœªçŸ¥' }}"
            PIPELINE_TYPE="${{ needs.parse_trigger.outputs.pipeline_type }}"
            
            echo "| æ™ºèƒ½åˆ†å‘å™¨ | $PIPELINE_STATUS | $PIPELINE_TYPE â†’ $TRIGGERED_PIPELINE |" >> $GITHUB_STEP_SUMMARY
            
            # å¦‚æžœæœ‰å·¥ä½œæµè¿è¡ŒIDï¼Œæ·»åŠ é“¾æŽ¥
            if [[ "${{ needs.trigger_pipeline.outputs.workflow_run_id }}" != "" ]]; then
              echo "| è§¦å‘çš„å·¥ä½œæµ | [æŸ¥çœ‹è¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ needs.trigger_pipeline.outputs.workflow_run_id }}) | è¿è¡ŒID: ${{ needs.trigger_pipeline.outputs.workflow_run_id }} |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Commitä¿¡æ¯
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Commitä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.parse_trigger.outputs.commit_message }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # è°ƒè¯•ä¿¡æ¯
          if [[ "${{ needs.parse_trigger.outputs.debug_info }}" != "" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ› è°ƒè¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.parse_trigger.outputs.debug_info }}' | base64 -d | jq . >> $GITHUB_STEP_SUMMARY || echo "è°ƒè¯•ä¿¡æ¯è§£æžå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi