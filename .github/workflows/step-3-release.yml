name: ðŸ“¦ æ­¥éª¤3 - å‘å¸ƒ

on:
  workflow_call:
    inputs:
      buildType:
        description: "æž„å»ºç±»åž‹ï¼š'preview' | 'release_candidate' | 'release'"
        type: string
        required: true
      buildVersion:
        description: "ç‰ˆæœ¬/æ ‡ç­¾åï¼ˆå¦‚ v1.2.3ï¼‰"
        type: string
        required: true
      projectName:
        description: "äº§ç‰©ä¸­ä½¿ç”¨çš„é¡¹ç›®åç§°"
        type: string
        required: true
      buildTargets:
        description: "æœŸæœ›äº§ç‰©çš„æž„å»ºç›®æ ‡ JSON æ•°ç»„"
        type: string
        required: true
      combineArtifacts:
        description: "æ˜¯å¦å°†åˆå¹¶äº§ç‰©ä¸Šä¼ åˆ°å‘å¸ƒ"
        type: string
        default: "false"
        required: false
      skipPerBuildTargetArtifacts:
        description: "æ˜¯å¦è·³è¿‡ä¸Šä¼ å•å¹³å°äº§ç‰©"
        type: string
        default: "false"
        required: false
    outputs:
      releaseErrorMessage:
        description: "å‘å¸ƒå¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯"
        value: ${{ jobs.publish.outputs.releaseErrorMessage }}

jobs:
  publish:
    if: ${{ inputs.buildType == 'release' || inputs.buildType == 'release_candidate' }}
    name: ðŸ“¤ å‘å¸ƒ GitHub Release
    runs-on: ubuntu-latest
    outputs:
      releaseErrorMessage: ${{ steps.error-handler.outputs.releaseErrorMessage }}

    steps:
      - name: ðŸ“ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: ðŸ“ åˆ›å»º GitHub Release
        id: create_release
        uses: avalin/unity-ci-templates/.github/actions/create-release@main
        with:
          version: ${{ inputs.buildVersion }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§® ä¸Šä¼ å•å¹³å°äº§ç‰©
        uses: avalin/unity-ci-templates/.github/actions/upload-per-build-target-artifacts@main
        with:
          project: ${{ inputs.projectName }}
          version: ${{ inputs.buildVersion }}
          releaseId: ${{ steps.create_release.outputs.release_id }}
          repository: ${{ github.repository }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          buildTargets: ${{ inputs.buildTargets }}

      - name: ðŸ§® ä¸Šä¼ åˆå¹¶äº§ç‰©
        if: ${{ inputs.combineArtifacts == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.buildVersion }}"
          PROJECT="${{ inputs.projectName }}"
          COMBINED_PATH="${PROJECT}-${VERSION}"
          COMBINED_ZIP="${PROJECT}-${VERSION}-all-platforms.zip"

          RELEASE_ID="${{ steps.create_release.outputs.release_id }}"

          if [ -d "$COMBINED_PATH" ]; then
            echo "ðŸ“¦ æ­£åœ¨åŽ‹ç¼©: $COMBINED_PATH â†’ $COMBINED_ZIP"
            cd "$COMBINED_PATH"
            zip -r "../$COMBINED_ZIP" .
            cd -

            echo "ðŸ“¤ ä¸Šä¼  $COMBINED_ZIP åˆ°å‘å¸ƒ ID $RELEASE_ID"
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @"$COMBINED_ZIP" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$COMBINED_ZIP"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°åˆå¹¶æž„å»ºäº§ç‰©ï¼Œè·³è¿‡ã€‚"
          fi

      - name: ðŸ› ï¸ æ•èŽ·å‘å¸ƒé”™è¯¯
        if: failure()
        id: error-handler
        run: |
          ERROR_MESSAGE="æœªçŸ¥çš„å‘å¸ƒå¤±è´¥"

          if ! ls * >/dev/null 2>&1; then
            ERROR_MESSAGE="æœªæ‰¾åˆ°äº§ç‰©"
          elif ! jq -e .id response.json >/dev/null 2>&1; then
            ERROR_MESSAGE="åˆ›å»ºæˆ–èŽ·å– GitHub Release å¤±è´¥"
          else
            ERROR_MESSAGE="ä¸€ä¸ªæˆ–å¤šä¸ªä¸Šä¼ æ­¥éª¤å¤±è´¥"
          fi

          echo "releaseErrorMessage=$ERROR_MESSAGE" >> "$GITHUB_OUTPUT"