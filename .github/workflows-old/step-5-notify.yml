name: ðŸ“£ æ­¥éª¤5 - é€šçŸ¥

on:
  workflow_call:
    inputs:
      buildVersion:
        required: true
        type: string
      releaseResult:
        required: false
        type: string
        default: "skipped"
      releaseErrorMessage:
        required: false
        type: string
        default: ""
      deployResult:
        required: false
        type: string
        default: "skipped"
      testsHasFails:
        required: false
        type: string
        default: "false"
      testsTotal:
        required: false
        type: string
        default: "0"
      testsPassed:
        required: false
        type: string
        default: "0"
      testsFailedNames:
        required: false
        type: string
        default: "æ— ï¼ˆæœªè¿è¡Œæµ‹è¯•ï¼‰"
    secrets:
      SLACK_WEBHOOK: { required: false }
      DISCORD_WEBHOOK: { required: false }

jobs:
  notify:
    if: startsWith(inputs.buildVersion, 'v') && !contains(inputs.buildVersion, '-preview')
    runs-on: ubuntu-latest
    env:
      SLACK_STATUS: "âš ï¸ æœªé…ç½®Webhook"
      DISCORD_STATUS: "âš ï¸ æœªé…ç½®Webhook"
    steps:
      - name: ä¸‹è½½éƒ¨ç½²ç»“æžœ
        uses: actions/download-artifact@v4
        with:
          pattern: deployment-results-*
          path: deploy-results
          merge-multiple: true

      - name: ç”Ÿæˆé€šçŸ¥å†…å®¹
        id: generate_notification
        uses: avalin/unity-ci-templates/.github/actions/generate-notification@v1
        with:
          releaseResult: ${{ inputs.releaseResult }}
          releaseErrorMessage: ${{ inputs.releaseErrorMessage }}
          deployResult: ${{ inputs.deployResult }}
          version: ${{ inputs.buildVersion }}
          testsHasFails: ${{ inputs.testsHasFails }}
          testsTotal: ${{ inputs.testsTotal }}
          testsPassed: ${{ inputs.testsPassed }}
          testsFailedNames: ${{ inputs.testsFailedNames }}

      # â”€â”€â”€â”€â”€ Slack â”€â”€â”€â”€â”€
      - name: ðŸ“¢ å‘é€Slacké€šçŸ¥ï¼ˆå¦‚å·²é…ç½®ï¼‰
        if: ${{ env.SLACK_WEBHOOK != '' }}
        continue-on-error: true
        run: |
          case "${{ steps.generate_notification.outputs.status }}" in
            success) COLOR="good" ;;
            failure) COLOR="danger" ;;
            *) COLOR="#cccccc" ;;
          esac

          TEXT=$'*${{ steps.generate_notification.outputs.title }}* - `${{ github.repository }}`\n${{ steps.generate_notification.outputs.slackMessage }}'

          PAYLOAD=$(jq -n \
            --arg text "$TEXT" \
            --arg color "$COLOR" \
            '{
              text: $text,
              attachments: [{ color: $color }]
            }'
          )

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" "$SLACK_WEBHOOK")

          if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ]; then
            echo "SLACK_STATUS=âœ… é€šçŸ¥å·²å‘é€" >> $GITHUB_ENV
          else
            echo "SLACK_STATUS=âŒ å‘é€å¤±è´¥ (HTTP $RESPONSE)" >> $GITHUB_ENV
          fi
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

      # â”€â”€â”€â”€â”€ Discord â”€â”€â”€â”€â”€
      - name: ðŸ“¢ å‘é€Discordé€šçŸ¥ï¼ˆå¦‚å·²é…ç½®ï¼‰
        if: ${{ env.DISCORD_WEBHOOK != '' }}
        continue-on-error: true
        run: |
          TEXT=$'${{ steps.generate_notification.outputs.discordMessage }}'

          PAYLOAD=$(jq -n \
            --arg content "$TEXT" \
            '{ content: $content }'
          )

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" "$DISCORD_WEBHOOK")

          if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ]; then
            echo "DISCORD_STATUS=âœ… é€šçŸ¥å·²å‘é€" >> $GITHUB_ENV
          else
            echo "DISCORD_STATUS=âŒ å‘é€å¤±è´¥ (HTTP $RESPONSE)" >> $GITHUB_ENV
          fi
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      # â”€â”€â”€â”€â”€ æ€»ç»“ â”€â”€â”€â”€â”€
      - name: ðŸ“„ é€šçŸ¥æ€»ç»“
        if: always()
        run: |
          echo "### ðŸ“£ é€šçŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ¸ é“ | çŠ¶æ€ | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Slack   | ${SLACK_STATUS%% *} | ${SLACK_STATUS#* } |" >> $GITHUB_STEP_SUMMARY
          echo "| Discord | ${DISCORD_STATUS%% *} | ${DISCORD_STATUS#* } |" >> $GITHUB_STEP_SUMMARY