name: ğŸ”– ç‰ˆæœ¬è§£æå™¨

on:
  workflow_call:
    inputs:
      buildType:
        description: "æ„å»ºç±»å‹: preview | release_candidate | release"
        required: true
        type: string
      buildVersion:
        description: "å¯é€‰çš„ç‰ˆæœ¬å·è¦†ç›–ï¼Œæ¥è‡ªå·¥ä½œæµè¾“å…¥"
        required: false
        type: string
    outputs:
      buildVersion:
        description: "è§£æåçš„æ„å»ºç‰ˆæœ¬å­—ç¬¦ä¸²"
        value: ${{ jobs.version_resolver.outputs.buildVersion }}

jobs:
  version_resolver:
    name: ç”Ÿæˆæ„å»ºç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    outputs:
      buildVersion: ${{ steps.get_version.outputs.version }}

    steps:
      - name: ğŸ“¡ é…ç½® Gitï¼ˆæ‹‰å–æ ‡ç­¾å’Œé»˜è®¤åˆ†æ”¯ï¼‰
        run: |
          git init
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git fetch origin --tags --force
          git fetch origin $(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
          git checkout $(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')

      - name: è§£ææ„å»ºç‰ˆæœ¬å·
        id: get_version
        uses: avalin/unity-ci-templates/.github/actions/resolve-build-version@main
        with:
          ref: "${GITHUB_REF}"
          event: "${GITHUB_EVENT_NAME}"
          input_version: "${{ inputs.buildVersion }}"
          build_type: "${{ inputs.buildType }}"

      - name: ğŸ“ æ£€æŸ¥ Release ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
        id: check_release
        uses: avalin/unity-ci-templates/.github/actions/check-release-exists@main
        with:
          version: ${{ steps.get_version.outputs.version }}
          repo: ${{ github.repository }}
          token: ${{ github.token }}

      - name: ğŸ“ è¾“å‡ºæ„å»ºç‰ˆæœ¬ä¿¡æ¯
        if: ${{ always() }}
        run: |
          echo "ğŸ”– ç‰ˆæœ¬æ‘˜è¦"
          echo ""
          echo "- è§¦å‘äº‹ä»¶: '${{ github.event_name }}' â†’ '${{ github.ref }}'"
          echo "- æ„å»ºç±»å‹: '${{ inputs.buildType }}'"
          echo "- è§£æåçš„ç‰ˆæœ¬: '${{ steps.get_version.outputs.version }}'"

          if [[ -z "${{ steps.get_version.outputs.version }}" ]]; then
            echo "- âš ï¸ æœªèƒ½è§£æå‡ºç‰ˆæœ¬å· - è¯·æ£€æŸ¥ 'è§£æç‰ˆæœ¬å·' æ­¥éª¤æ—¥å¿—ã€‚"
          elif [[ "${GITHUB_REF}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$ ]]; then
            echo "- ğŸ·ï¸ è¿™æ˜¯ä¸€ä¸ªæ ‡ç­¾æ¨é€ â€” æ ‡ç­¾å·²å­˜åœ¨ï¼Œå±äºé¢„æœŸã€‚"
          else
            if [[ "${{ steps.check_release.outputs.release_exists }}" == "true" ]]; then
              echo "- âš ï¸ GitHub Release æ ‡ç­¾ '${{ steps.get_version.outputs.version }}' å·²å­˜åœ¨ â€” ä¸ºé¿å…è¦†ç›–ï¼Œæµç¨‹å°†æ•…æ„å¤±è´¥ã€‚"
            else
              echo "- âœ… æ ‡ç­¾ '${{ steps.get_version.outputs.version }}' å°šæœªå­˜åœ¨ â€” å¯ä»¥ç»§ç»­ï¼"
            fi
          fi

      - name: ğŸš« è‹¥ Release å·²å­˜åœ¨åˆ™é˜»æ­¢æµç¨‹
        if: ${{ inputs.buildType != 'preview' }}
        run: |
          if [[ "${{ steps.check_release.outputs.release_exists }}" == "true" ]]; then
            echo "âŒ ç‰ˆæœ¬ '${{ steps.get_version.outputs.version }}' çš„ Release å·²å­˜åœ¨ï¼Œæå‰ç»ˆæ­¢æµç¨‹ã€‚"
            exit 1
          fi

          echo "âœ… æœªæ£€æµ‹åˆ°å·²å­˜åœ¨çš„ Release â€” ç»§ç»­æµç¨‹ã€‚"