name: ðŸ“ˆ Roslyn ä»£ç è§„èŒƒæ£€æŸ¥ï¼ˆCSharpierï¼‰

on:
  workflow_call:
    inputs:
      allowAutofix:
        description: "æ˜¯å¦å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–å¹¶æäº¤"
        required: false
        default: false
        type: boolean
      allowFailure:
        description: "æ˜¯å¦å…è®¸æ ¼å¼åŒ–å¤±è´¥"
        required: false
        default: false
        type: boolean

jobs:
  roslyn-lint:
    name: C# ä»£ç è§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé¡¹ç›®
        uses: actions/checkout@v4

      - name: å®‰è£… CSharpier
        run: |
          echo "ðŸ”§ å®‰è£… CSharpier å…¨å±€å·¥å…·..."
          
          # ç¡®ä¿ .dotnet ç›®å½•å­˜åœ¨
          mkdir -p "$HOME/.dotnet/tools"
          
          # å°è¯•å®‰è£…æˆ–æ›´æ–° CSharpier
          if dotnet tool install -g csharpier --verbosity normal; then
            echo "âœ… CSharpier å®‰è£…æˆåŠŸ"
          elif dotnet tool update -g csharpier --verbosity normal; then
            echo "âœ… CSharpier æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ CSharpier å®‰è£…/æ›´æ–°å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶é‡æ–°å®‰è£…"
            dotnet tool uninstall -g csharpier 2>/dev/null || true
            dotnet tool install -g csharpier --verbosity normal
          fi
          
          # å°†å·¥å…·è·¯å¾„æ·»åŠ åˆ°çŽ¯å¢ƒå˜é‡
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          export PATH="$HOME/.dotnet/tools:$PATH"
          
          # éªŒè¯å®‰è£…
          echo "ðŸ” éªŒè¯ CSharpier å®‰è£…..."
          if command -v dotnet-csharpier &> /dev/null; then
            echo "âœ… CSharpier å·¥å…·å¯ç”¨ (ç›´æŽ¥å‘½ä»¤)"
            dotnet-csharpier --version
          elif dotnet csharpier --version &> /dev/null; then
            echo "âœ… CSharpier å·¥å…·å¯ç”¨ (dotnet å­å‘½ä»¤)"
            dotnet csharpier --version
          else
            echo "âš ï¸ CSharpier å·¥å…·éªŒè¯å¤±è´¥ï¼Œå°†åœ¨åŽç»­æ­¥éª¤ä¸­ä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
          fi

      - name: ðŸ“‹ åŠ è½½æ£€æŸ¥è·¯å¾„é…ç½®
        id: load_paths
        run: |
          CONFIG_FILE=".github/config/roslyn-lint-config.json"
          
          if [[ -f "$CONFIG_FILE" ]]; then
            CHECK_PATHS=$(jq -r '.checkPaths[]?' "$CONFIG_FILE" | tr '\n' ' ')
            if [[ -z "$CHECK_PATHS" ]]; then
              CHECK_PATHS="Assets"
            fi
          else
            CHECK_PATHS="Assets"
          fi
          
          echo "checkPaths=$CHECK_PATHS" >> "$GITHUB_OUTPUT"
          echo "ðŸ“‚ å°†æ£€æŸ¥ä»¥ä¸‹ç›®å½•: $CHECK_PATHS"

      - name: æ£€æŸ¥ C# æ ¼å¼ï¼ˆCSharpierï¼‰
        id: csharpier
        run: |
          CHECK_PATHS="${{ steps.load_paths.outputs.checkPaths }}"
          FORMAT_FAILED=false
          
          for path in $CHECK_PATHS; do
            if [[ -d "$path" ]]; then
              echo "ðŸ“‚ æ­£åœ¨æ£€æŸ¥ $path ç›®å½•ä¸‹çš„ä»£ç æ ¼å¼..."
              if ! dotnet csharpier --check "$path"; then
                FORMAT_FAILED=true
              fi
            else
              echo "âš ï¸ ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡: $path"
            fi
          done
          
          if [[ "$FORMAT_FAILED" == "true" ]]; then
            echo "FORMAT_FAILED=true" >> $GITHUB_ENV
          fi

      - name: è‹¥å‘çŽ°æ ¼å¼é—®é¢˜ä¸”ä¸å…è®¸å¤±è´¥åˆ™å¤±è´¥
        if: inputs.allowFailure == false
        run: |
          echo "âŒ æ£€æµ‹åˆ°æ ¼å¼é—®é¢˜ä¸” allowFailure ä¸º falseï¼Œä½œä¸šå¤±è´¥ã€‚"
          exit 1

      - name: è‡ªåŠ¨æ ¼å¼åŒ– C# æ–‡ä»¶ï¼ˆCSharpierï¼‰
        if: ${{ inputs.allowAutofix == true }}
        run: |
          echo "ðŸ› ï¸ å…è®¸è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œæ­£åœ¨åº”ç”¨æ›´æ”¹..."
          CHECK_PATHS="${{ steps.load_paths.outputs.checkPaths }}"
          
          for path in $CHECK_PATHS; do
            if [[ -d "$path" ]]; then
              echo "ðŸ”§ æ ¼å¼åŒ–ç›®å½•: $path"
              dotnet csharpier "$path"
            fi
          done

      - name: è¿è¡Œ Unity é£Žæ ¼ä¿®å¤å™¨
        if: ${{ inputs.allowAutofix == true }}
        run: bash .github/scripts/analyze/csharpier-addon.sh

      - name: æäº¤æ ¼å¼åŒ–ä¿®å¤
        if: ${{ inputs.allowAutofix == true }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          CHECK_PATHS="${{ steps.load_paths.outputs.checkPaths }}"
          for path in $CHECK_PATHS; do
            if [[ -d "$path" ]]; then
              git add "$path"
            fi
          done
          
          if git diff --cached --quiet; then
            echo "ðŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ROSLYN-AUTOFIX: auto-format C# files with CSharpier"
            
            if git push; then
              echo "âœ… æ ¼å¼åŒ–æ›´æ”¹å·²æˆåŠŸæŽ¨é€"
            else
              echo "âš ï¸ æ— æ³•æŽ¨é€æ›´æ”¹ï¼ˆå¯èƒ½æ˜¯ PR æˆ–æ— æƒé™ï¼‰"
            fi
          fi

      - name: æ·»åŠ æ±‡æ€»
        if: failure()
        run: |
          echo "âŒ **æ£€æµ‹åˆ° CSharpier æ ¼å¼é—®é¢˜**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æœ¬åœ°è¿è¡Œ \`dotnet csharpier .\` æˆ–é‡æ–°è¿è¡Œå¹¶è®¾ç½® \`allowAutofix: true\`ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æŸ¥çš„ç›®å½•:** ${{ steps.load_paths.outputs.checkPaths }}" >> $GITHUB_STEP_SUMMARY