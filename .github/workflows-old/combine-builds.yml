name: ðŸ“† åˆå¹¶æž„å»ºäº§ç‰©

description: |
  ä¸‹è½½æ‰€æœ‰å•ç‹¬æž„å»ºç›®æ ‡çš„äº§ç‰©ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶åˆ°ä¸€ä¸ªå¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶å¤¹ä¸­ï¼Œ
  ä¾¿äºŽä¸Šä¼ æˆ–éƒ¨ç½²ã€‚å§‹ç»ˆåˆ›å»ºç»“æž„ä¸€è‡´çš„åˆå¹¶äº§ç‰©ã€‚

on:
  workflow_call:
    inputs:
      projectName:
        required: true
        type: string
      buildVersion:
        required: true
        type: string
      retentionDays:
        required: false
        type: number
        default: 7
    outputs:
      created:
        description: "æ˜¯å¦å®žé™…åˆ›å»ºäº†åˆå¹¶äº§ç‰©"
        value: ${{ jobs.combine.outputs.created }}

jobs:
  combine:
    name: ðŸ“† åˆå¹¶æ‰€æœ‰æž„å»ºç›®æ ‡åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹
    runs-on: ubuntu-latest
    outputs:
      created: ${{ steps.set-created.outputs.success }}
    steps:
      - name: ðŸ“… ä¸‹è½½æ‰€æœ‰æž„å»ºç›®æ ‡äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: ðŸ—‚ï¸ åˆå¹¶åˆ°å•ä¸€ç‰ˆæœ¬æ–‡ä»¶å¤¹
        run: |
          VERSION="${{ inputs.buildVersion }}"
          PROJECT="${{ inputs.projectName }}"
          COMBINED_DIR="${PROJECT}-${VERSION}"
          mkdir -p "$COMBINED_DIR"

          echo "æ­£åœ¨åˆå¹¶äº§ç‰©åˆ°: $COMBINED_DIR"

          for DIR in all-artifacts/*; do
            ARTIFACT_NAME=$(basename "$DIR")
            TARGET=$(echo "$ARTIFACT_NAME" | sed -E 's/^.*-([^-]+)$/\1/')
            DEST="$COMBINED_DIR/$TARGET"

            echo "â†’ åˆå¹¶ç›®æ ‡: $TARGET åˆ° $DEST"
            mkdir -p "$DEST"
            cp -r "$DIR/"* "$DEST/" || echo "âš ï¸ $TARGET æ— å†…å®¹å¯å¤åˆ¶"
            rm -rf "$DEST/unity_license"
          done

      - name: ðŸ“¦ ä¸Šä¼ åˆå¹¶äº§ç‰©
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.projectName }}-${{ inputs.buildVersion }}
          path: ${{ inputs.projectName }}-${{ inputs.buildVersion }}
          retention-days: ${{ inputs.retentionDays }}

      - name: ðŸ“¤ æ£€æŸ¥å¹¶è®¾ç½®è¾“å‡ºï¼ˆåˆå¹¶äº§ç‰©æ˜¯å¦å­˜åœ¨ä¸”å·²ä¸Šä¼ ï¼‰
        id: set-created
        run: |
          COMBINED_DIR="${{ inputs.projectName }}-${{ inputs.buildVersion }}"

          if [ -d "$COMBINED_DIR" ] && [ "$(ls -A "$COMBINED_DIR")" ]; then
            echo "âœ… åˆå¹¶æ–‡ä»¶å¤¹å­˜åœ¨ä¸”å·²æˆåŠŸä¸Šä¼ "
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ åˆå¹¶æ–‡ä»¶å¤¹ç¼ºå¤±æˆ–ä¸ºç©º"
            echo "success=false" >> $GITHUB_OUTPUT
          fi