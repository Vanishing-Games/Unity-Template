name: âœˆï¸ CI/CD å†éƒ¨ç½²å™¨

on:
  workflow_dispatch:
    inputs:
      buildVersion:
        description: "è¦éƒ¨ç½²çš„å‘å¸ƒæ ‡ç­¾ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼šv1.2.3ï¼‰"
        required: true
        default: 'v0.0.0'
        type: string
      deployTargets:
        description: "éƒ¨ç½²ç›®æ ‡çš„ JSON æ•°ç»„ï¼ˆä¾‹å¦‚ï¼š[\"s3\", \"firebase\"]ï¼‰"
        required: true
        default: '["gh-pages"]'
        type: string
      buildTargets:
        description: "æ„å»ºç›®æ ‡çš„ JSON æ•°ç»„ï¼ˆä¾‹å¦‚ï¼š[\"WebGL\",\"iOS\"]ï¼‰- å¯é€‰ï¼ˆç•™ç©ºï¼‰"
        required: false
        type: string

permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 0. é¡¹ç›®åç§°è§„èŒƒåŒ–
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sanitize_project_name:
    name: é¡¹ç›®åç§°è§„èŒƒåŒ–
    runs-on: ubuntu-latest
    outputs:
      sanitized_name: ${{ steps.sanitize.outputs.sanitized_name }}
    steps:
      - name: è¿è¡Œé¡¹ç›®åç§°è§„èŒƒåŒ–å™¨
        id: sanitize
        uses: avalin/unity-ci-templates/.github/actions/resolve-project-name@main
        with:
          projectNameInput: ${{ vars.PROJECT_NAME }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. æ ¡éªŒå‘å¸ƒä¸äº§ç‰©
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate_release:
    name: æ ¡éªŒå‘å¸ƒæ ‡ç­¾ä¸äº§ç‰©
    runs-on: ubuntu-latest
    outputs:
      hasCombinedArtifacts: ${{ steps.check.outputs.hasCombinedArtifacts }}
    steps:
      - name: å®‰è£… GitHub CLI
        run: sudo apt-get install gh -y

      - name: æ£€æŸ¥ GitHub å‘å¸ƒä¸äº§ç‰©
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æŸ¥å‘å¸ƒ '${{ inputs.buildVersion }}' æ˜¯å¦å­˜åœ¨..." | tee -a "$GITHUB_STEP_SUMMARY"

          # å°è¯•è·å–å‘å¸ƒæ•°æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶
          if ! gh api repos/${{ github.repository }}/releases/tags/${{ inputs.buildVersion }} --jq '.' > release.json; then
            echo "âŒ æœªæ‰¾åˆ°å‘å¸ƒ '${{ inputs.buildVersion }}' æˆ– API è°ƒç”¨å¤±è´¥ã€‚" | tee -a "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "âœ… å·²æ‰¾åˆ°å‘å¸ƒã€‚æ­£åœ¨é‡æ–°éƒ¨ç½²: '${{ inputs.buildVersion }}'..." | tee -a "$GITHUB_STEP_SUMMARY"

          # è¯»å–å‘å¸ƒæ•°æ®
          RELEASE_DATA=$(cat release.json)

          # æ£€æŸ¥æ˜¯å¦æœ‰åˆå¹¶äº§ç‰©
          COMBINED_FOUND=$(echo "$RELEASE_DATA" | jq -r '.assets[]?.name' | grep -c 'all-platforms' || true)
          if [ "$COMBINED_FOUND" -gt 0 ]; then
            echo "âœ… æ£€æµ‹åˆ°åˆå¹¶äº§ç‰©ã€‚" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "hasCombinedArtifacts=true" >> "$GITHUB_OUTPUT"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°åˆå¹¶äº§ç‰©ã€‚" | tee -a "$GITHUB_STEP_SUMMARY"
            echo "hasCombinedArtifacts=false" >> "$GITHUB_OUTPUT"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. å†éƒ¨ç½²
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  redeploy:
    name: ä»å‘å¸ƒå†éƒ¨ç½²
    needs: 
      - sanitize_project_name
      - validate_release
    uses: ./.github/workflows/step-4-deploy.yml
    with:
      buildType: release
      buildVersion: ${{ inputs.buildVersion }}
      projectName: ${{ needs.sanitize_project_name.outputs.sanitized_name }}
      deployTargets: ${{ inputs.deployTargets || '[]' }}
      buildTargets: ${{ inputs.buildTargets != '' && inputs.buildTargets || vars.BUILD_TARGETS || '[]' }}
      hasCombinedArtifacts: ${{ needs.validate_release.outputs.hasCombinedArtifacts }}
      artifactSource: release
    secrets: inherit

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. é€šçŸ¥
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: é€šçŸ¥
    needs: 
      - redeploy
    uses: ./.github/workflows/step-5-notify.yml
    with:
      buildVersion: ${{ inputs.buildVersion }}
      releaseResult: 'success'
      releaseErrorMessage: ''
      deployResult: ${{ needs.redeploy.result }}
      testsHasFails: 0
      testsTotal: 0
      testsPassed: 0
      testsFailedNames: ''
    secrets: inherit