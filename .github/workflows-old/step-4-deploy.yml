name: ðŸŒ æ­¥éª¤4 - éƒ¨ç½²

on:
  workflow_call:
    inputs:
      buildType:
        type: string
        required: true
      buildVersion:
        description: "ç‰ˆæœ¬/æ ‡ç­¾åï¼ˆå¦‚ï¼šv1.2.3ï¼‰"
        type: string
        required: true
      projectName:
        type: string
        required: true
      hasCombinedArtifacts:
        description: "æ˜¯å¦å·²åˆ›å»ºåˆå¹¶äº§ç‰©æ–‡ä»¶å¤¹"
        required: true
        default: 'false'
        type: string
      deployTargets:
        description: "éƒ¨ç½²ç›®æ ‡çš„JSONæ•°ç»„ï¼ˆå¦‚ ['itch.io','appcenter','firebase','s3','gh-pages']ï¼‰"
        required: false
        default: '[]'
        type: string
      buildTargets:
        description: "æž„å»ºç›®æ ‡çš„JSONæ•°ç»„ï¼ˆå¦‚ [\"WebGL\",\"iOS\"]ï¼‰"
        required: true
        default: '[]'
        type: string
      artifactSource:
        description: "éƒ¨ç½²äº§ç‰©æ¥æºï¼ˆbuild æˆ– releaseï¼‰"
        required: false
        default: 'build'
        type: string
    secrets:
      CICD_PAT: { required: true }
      BUTLER_API_KEY: { required: false }
      DEPLOY_API_KEY: { required: false }
      ITCH_USERNAME: { required: false }
      ITCH_PROJECT: { required: false }
      APPCENTER_OWNER_NAME: { required: false }
      FIREBASE_TOKEN: { required: false }
      AWS_ACCESS_KEY_ID: { required: false }
      AWS_SECRET_ACCESS_KEY: { required: false }
      S3_BUCKET: { required: false }
      STEAM_USERNAME: { required: false }
      STEAM_PASSWORD: { required: false }
      STEAM_APP_ID: { required: false }
      STEAM_DEPOT_VDF_PATH: { required: false }
      APPSTORE_API_KEY_ID: { required: false }
      APPSTORE_API_ISSUER_ID: { required: false }
      APPSTORE_API_PRIVATE_KEY: { required: false }
      CUSTOM_SERVER_HOST: { required: false }
      CUSTOM_SERVER_USER: { required: false }
      CUSTOM_SERVER_KEY: { required: false }

jobs:
  resolve_deploy_matrix:
    uses: ./.github/workflows/resolve-deploy-matrix.yml
    with:
      validTargets: ${{ inputs.deployTargets }}

  deploy:
    name: ðŸš€ éƒ¨ç½² ${{ matrix.target }} äºŽ ${{ matrix.os }}
    needs: resolve_deploy_matrix
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.resolve_deploy_matrix.outputs.matrix) }}
    env:
      DEPLOY_DIR: deployment-artifacts
      PROJECT_DIR: ${{ inputs.projectName }}-${{ inputs.buildVersion }}
      ARTIFACT_DIR: deployment-artifacts/${{ inputs.projectName }}-${{ inputs.buildVersion }}
    steps:
      - name: ðŸ“¥ ä»ŽReleaseèŽ·å–äº§ç‰©
        uses: avalin/unity-ci-templates/.github/actions/download-from-release@main
        with:
          projectName: ${{ inputs.projectName }}
          version: ${{ inputs.buildVersion }}
          githubRepository: ${{ github.repository }}
          githubToken: ${{ secrets.CICD_PAT }}
          hasCombinedArtifacts: ${{ inputs.hasCombinedArtifacts }}
          requiredBuildTargetsJson: '${{ toJson(matrix.requiredBuildTargets) }}'

      # ä¸‹è½½åˆå¹¶äº§ç‰©ï¼ˆå•ä¸€ï¼‰
      - name: ðŸ“¥ ä»Žæž„å»ºèŽ·å–äº§ç‰©ï¼ˆåˆå¹¶ï¼‰
        if: ${{ inputs.artifactSource == 'build' && inputs.hasCombinedArtifacts == 'true' }}
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.ARTIFACT_DIR }}
          name: ${{ env.PROJECT_DIR }}

      - name: ðŸ“¥ ä»Žæž„å»ºèŽ·å–äº§ç‰©ï¼ˆæŒ‰æž„å»ºç›®æ ‡ï¼‰
        if: ${{ inputs.artifactSource == 'build' && inputs.hasCombinedArtifacts == 'false' }}
        uses: avalin/unity-ci-templates/.github/actions/download-per-build-target-artifacts-from-build@main
        with:
          artifactDir: ${{ env.ARTIFACT_DIR }}
          projectName: ${{ inputs.projectName }}
          version: ${{ inputs.buildVersion }}
          requiredBuildTargets: '${{ toJson(matrix.requiredBuildTargets) }}'
        env:
          GH_TOKEN: ${{ secrets.CICD_PAT }}

      - name: ðŸ› ï¸ è§„èŒƒåŒ–äº§ç‰©ç»“æž„ï¼ˆä»…ReleaseæŒ‰æž„å»ºç›®æ ‡ï¼‰
        if: ${{ inputs.artifactSource == 'release' && inputs.hasCombinedArtifacts == 'false' }}
        uses: avalin/unity-ci-templates/.github/actions/normalize-artifact-layout@main
        with:
          artifactDir: ${{ env.ARTIFACT_DIR }}

      - name: ðŸ§¾ åˆ—å‡ºäº§ç‰©
        run: ls -R "$DEPLOY_DIR" || echo "æœªæ‰¾åˆ°äº§ç‰©ã€‚"

      # â”€â”€â”€â”€â”€ GitHub Pages â”€â”€â”€â”€â”€
      - name: ðŸ” æ£€æŸ¥WebGLæž„å»ºæ˜¯å¦å­˜åœ¨
        if: matrix.target == 'gh-pages'
        run: |
          if [ ! -d "${ARTIFACT_DIR}/WebGL" ]; then
            echo "âŒ æœªæ‰¾åˆ°WebGLæž„å»ºï¼Œæ— æ³•éƒ¨ç½²åˆ°GitHub Pagesã€‚"
            exit 1
          fi

      - name: ðŸ”Ž æ£€æµ‹WebGLåŽ‹ç¼©æ ¼å¼
        id: detect-compression
        uses: avalin/unity-ci-templates/.github/actions/detect-webgl-compression@main
        with:
          artifactDir: ${{ env.ARTIFACT_DIR }}

      - name: ðŸ©¹ ä¿®è¡¥å¹¶è§£åŽ‹Unity WebGLä»¥ç”¨äºŽGitHub Pages
        if: ${{ matrix.target == 'gh-pages' && steps.detect-compression.outputs.needs_patch == 'true' }}
        uses: avalin/unity-ci-templates/.github/actions/patch-webgl-for-gh-pages@main
        with:
          artifactDir: ${{ env.ARTIFACT_DIR }}

      - name: ðŸŒ éƒ¨ç½²åˆ°GitHub Pages
        if: matrix.target == 'gh-pages'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.CICD_PAT }}
          publish_dir: "./${{ env.ARTIFACT_DIR }}/WebGL"

      # â”€â”€â”€â”€â”€ itch.io â”€â”€â”€â”€â”€
      - name: ðŸ¤µ å®‰è£…Butler
        if: matrix.target == 'itch.io'
        uses: remarkablegames/setup-butler@v1

      - name: ðŸ•¹ï¸ éƒ¨ç½²åˆ°itch.io
        if: matrix.target == 'itch.io'
        run: |
          if [ -z "${{ secrets.ITCH_USERNAME }}" ] || [ -z "${{ secrets.ITCH_PROJECT }}" ]; then
            echo "âš ï¸ ç¼ºå°‘itch.ioå‡­æ®ã€‚"; 
            exit 1;
          fi
          butler push "$ARTIFACT_DIR" "${{ secrets.ITCH_USERNAME }}/${{ secrets.ITCH_PROJECT }}:${{ inputs.buildType }}"
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

      # â”€â”€â”€â”€â”€ App Center â”€â”€â”€â”€â”€
      - name: ðŸ“± éƒ¨ç½²åˆ°App Center
        if: matrix.target == 'appcenter'
        run: |
          if [ -z "${{ secrets.APPCENTER_OWNER_NAME }}" ] || [ -z "${{ secrets.DEPLOY_API_KEY }}" ]; then
            echo "âš ï¸ ç¼ºå°‘App Centerå‡­æ®ã€‚"; 
            exit 1;
          fi
          FILES=$(find "$ARTIFACT_DIR" -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.ipa" \))
          if [ -z "$FILES" ]; then echo "âŒ æœªæ‰¾åˆ°ç§»åŠ¨ç«¯äº§ç‰©ã€‚"; exit 1; fi

          for file in $FILES; do
            echo "ðŸš€ æ­£åœ¨éƒ¨ç½² $file"
            npx appcenter distribute release \
              --app "${{ secrets.APPCENTER_OWNER_NAME }}/${{ inputs.projectName }}" \
              --file "$file" \
              --group "Testers" \
              --token "${{ secrets.DEPLOY_API_KEY }}"
          done

      # â”€â”€â”€â”€â”€ Firebase â”€â”€â”€â”€â”€
      - name: ðŸ”¥ éƒ¨ç½²åˆ°Firebase Hosting
        if: matrix.target == 'firebase'
        run: |
          if [ -z "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "âš ï¸ ç¼ºå°‘Firebaseä»¤ç‰Œã€‚"; 
            exit 1;
          fi
          cd "${{ env.ARTIFACT_DIR }}/WebGL" || exit 1
          npm install -g firebase-tools
          firebase deploy --token "${{ secrets.FIREBASE_TOKEN }}"

      # â”€â”€â”€â”€â”€ AWS S3 â”€â”€â”€â”€â”€
      - name: â˜ï¸ éƒ¨ç½²åˆ°AWS S3
        if: matrix.target == 's3'
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] || [ -z "${{ secrets.S3_BUCKET }}" ]; then
            echo "âš ï¸ ç¼ºå°‘AWSå‡­æ®æˆ–å­˜å‚¨æ¡¶ã€‚"; 
            exit 1;
          fi
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws s3 sync "${{ env.ARTIFACT_DIR }}/WebGL" "s3://${{ secrets.S3_BUCKET }}" --delete

      # â”€â”€â”€â”€â”€ Steam â”€â”€â”€â”€â”€
      - name: ðŸŽ® éƒ¨ç½²åˆ°Steam
        if: matrix.target == 'steam'
        run: |
          VDF_PATH="${{ secrets.STEAM_DEPOT_VDF_PATH }}"
          if [ -z "$VDF_PATH" ]; then
            VDF_PATH="$ARTIFACT_DIR/steam/app_build.vdf"
          fi

          if [ -z "${{ secrets.STEAM_USERNAME }}" ] || [ -z "${{ secrets.STEAM_PASSWORD }}" ] || [ -z "${{ secrets.STEAM_APP_ID }}" ]; then
            echo "âš ï¸ ç¼ºå°‘Steamå‡­æ®æˆ–App IDã€‚"; 
            exit 1;
          fi

          echo "ðŸ› ï¸ å®‰è£…SteamCMD..."
          mkdir -p ~/steamcmd && cd ~/steamcmd
          curl -sSL https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz | tar -xz

          echo "ðŸ”‘ ç™»å½•Steamå¹¶è§¦å‘æž„å»º..."
          ./steamcmd.sh +login "${{ secrets.STEAM_USERNAME }}" "${{ secrets.STEAM_PASSWORD }}" +run_app_build "$VDF_PATH" +quit

      # â”€â”€â”€â”€â”€ è‡ªå®šä¹‰æœåŠ¡å™¨ â”€â”€â”€â”€â”€
      - name: ðŸ–¥ï¸ éƒ¨ç½²åˆ°è‡ªå®šä¹‰æœåŠ¡å™¨ï¼ˆé€šè¿‡SCPæˆ–Rsyncï¼‰
        if: matrix.target == 'custom-server'
        run: |
          if [ -z "${{ secrets.CUSTOM_SERVER_HOST }}" ] || [ -z "${{ secrets.CUSTOM_SERVER_USER }}" ] || [ -z "${{ secrets.CUSTOM_SERVER_KEY }}" ]; then
            echo "âš ï¸ ç¼ºå°‘è‡ªå®šä¹‰æœåŠ¡å™¨å‡­æ®ã€‚"; 
            exit 1;
          fi

          echo "âž¡ï¸ æ­£åœ¨éƒ¨ç½²åˆ°è‡ªå®šä¹‰æœåŠ¡å™¨..."
          mkdir -p ~/.ssh
          echo "${{ secrets.CUSTOM_SERVER_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.CUSTOM_SERVER_HOST }}" >> ~/.ssh/known_hosts

          rsync -avz "$ARTIFACT_DIR/" "${{ secrets.CUSTOM_SERVER_USER }}@${{ secrets.CUSTOM_SERVER_HOST }}:/var/www/mygame/"
        env:
          CUSTOM_SERVER_HOST: ${{ secrets.CUSTOM_SERVER_HOST }}
          CUSTOM_SERVER_USER: ${{ secrets.CUSTOM_SERVER_USER }}
          CUSTOM_SERVER_KEY: ${{ secrets.CUSTOM_SERVER_KEY }}

      # â”€â”€â”€â”€â”€ TestFlight â”€â”€â”€â”€â”€
      - name: ðŸ éƒ¨ç½².ipaåˆ°TestFlight
        if: matrix.target == 'testflight'
        run: |
          if [ -z "${{ secrets.APPSTORE_API_KEY_ID }}" ] || [ -z "${{ secrets.APPSTORE_API_ISSUER_ID }}" ] || [ -z "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" ]; then
            echo "âš ï¸ ç¼ºå°‘App Store Connect APIå‡­æ®ã€‚"; 
            exit 1;
          fi

          FILE=$(find "$ARTIFACT_DIR" -type f -name "*.ipa" | head -n 1)
          if [ -z "$FILE" ]; then echo "âŒ æœªæ‰¾åˆ°å¯ä¸Šä¼ çš„.ipaã€‚"; exit 1; fi

          echo "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" > private_key.p8

          echo "ðŸš€ æ­£åœ¨ä¸Šä¼  $FILE åˆ°TestFlight..."
          xcrun altool \
            --upload-app \
            --type ios \
            --file "$FILE" \
            --apiKey "${{ secrets.APPSTORE_API_KEY_ID }}" \
            --apiIssuer "${{ secrets.APPSTORE_API_ISSUER_ID }}" \
            --private-key-path private_key.p8
          rm private_key.p8
        env:
          FASTLANE_DISABLE_COLORS: 1

      # â”€â”€â”€â”€â”€ æ€»ç»“ â”€â”€â”€â”€â”€
      - name: ðŸ“Œ å­˜å‚¨éƒ¨ç½²ç»“æžœ
        if: always()
        run: |
          mkdir -p deployment-results
          RESULT_FILE="deployment-results/${{ matrix.target }}.json"

          STATUS="âœ…"
          NOTE="éƒ¨ç½²æˆåŠŸ"

          if [ "${{ job.status }}" != "success" ]; then
            STATUS="âŒ"
            NOTE="éƒ¨ç½²å¤±è´¥æˆ–ä¸å®Œæ•´"
          elif [ ! -d "$ARTIFACT_DIR" ]; then
            STATUS="âŒ"
            NOTE="æœªæ‰¾åˆ°éƒ¨ç½²äº§ç‰©"
          fi

          echo "{\"status\": \"$STATUS\", \"note\": \"$NOTE\"}" > "$RESULT_FILE"

      - name: ðŸ“¤ ä¸Šä¼ éƒ¨ç½²ç»“æžœäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-results-${{ matrix.target }}
          path: deployment-results
          retention-days: 1

  summarize_deploy:
    if: always()
    uses: ./.github/workflows/summarize-deploys.yml
    needs: deploy
    with:
      projectName: ${{ inputs.projectName }}
      buildVersion: ${{ inputs.buildVersion }}
      buildType: ${{ inputs.buildType }}